var PlayerControl=pc.createScript("playerControl");PlayerControl.attributes.add("camera",{type:"entity"}),PlayerControl.attributes.add("speed",{type:"number",default:500}),PlayerControl.attributes.add("runSpeed",{type:"number",default:800}),PlayerControl.attributes.add("maxVelocityChange",{type:"number",default:10}),PlayerControl.attributes.add("jumpImpulseY",{type:"number",default:7}),PlayerControl.attributes.add("fallMultplier",{type:"number",default:10}),PlayerControl.attributes.add("groundCheckFrom",{type:"entity"}),PlayerControl.attributes.add("groundCheckTo",{type:"entity"}),PlayerControl.prototype.initialize=function(){var t=this.app,e=t.root.findByName("Player").findByName("Body");this.isMobile=pc.platform.mobile||pc.platform.touch,this.isMobile&&(this.joystick=t.root.findByName("Joystick").script.joystick),this.body=e,this.mass=this.entity.rigidbody.mass,this.moveVelocity=new pc.Vec3,this.originVelocityY=this.entity.rigidbody.linearVelocity.y,this.rotY=this.converToDegrees(this.body.getLocalRotation()),this.rot=this.body.getLocalEulerAngles(),this.rotateTo=this.rotY,this.quatY=new pc.Quat,this.disableMove=!1,this.disableRotate=!1,this.running=!1,this.moveTimer=0,this.moveInterval=.5,this.jumpTimer=0,this.interval=.3,this.groundCastStart=-this.entity.collision.radius,this.groundContactPointY=this.groundCastStart,this.objectNormal=null,this.objectPoint=null,this.slopeHit=null,this.slopeNormal=new pc.Vec3,this.moveDirection=new pc.Vec3,this.slopeDirection=new pc.Vec3,this.force=new pc.Vec3,t.on("playerControl:enable",(function(){this.disableMove=!1,this.disableRotate=!1}),this),t.on("playerControl:disable",(function(){this.disableMove=!0,this.disableRotate=!0}),this),t.on("playerControl:rotate",(function(t){this.rotateTo=t}),this),t.on("playerControl:jump",(function(){this.jumpTimer>this.interval&&this.jump()}),this),t.on("playerControl:reset",(function(){this.moveVelocity=new pc.Vec3}),this)},PlayerControl.prototype.converToDegrees=function(t){var e=new pc.Vec3;return t.transformVector(pc.Vec3.FORWARD,e),Math.atan2(-e.x,-e.z)*pc.math.RAD_TO_DEG},PlayerControl.prototype.update=function(t){var e=this.app,i=this.camera.forward,o=this.camera.right;const s=new pc.Vec3(i.x,0,i.z).normalize(),r=new pc.Vec3(o.x,0,o.z).normalize();var a=0,n=0;if(this.isMobile){if(this.joystick.isDragging){var l=this.joystick.getTouchMovement();a=l.x*r.x+-l.y*-r.z,n=l.x*s.x+-l.y*-s.z}}else{var c=new pc.Vec3;(e.keyboard.isPressed(pc.KEY_A)||e.keyboard.isPressed(pc.KEY_LEFT))&&(c.x-=r.x,c.z-=r.z),(e.keyboard.isPressed(pc.KEY_D)||e.keyboard.isPressed(pc.KEY_RIGHT))&&(c.x+=r.x,c.z+=r.z),(e.keyboard.isPressed(pc.KEY_W)||e.keyboard.isPressed(pc.KEY_UP))&&(c.x+=s.x,c.z+=s.z),(e.keyboard.isPressed(pc.KEY_S)||e.keyboard.isPressed(pc.KEY_DOWN))&&(c.x-=s.x,c.z-=s.z),e.keyboard.isPressed(pc.KEY_G)&&this.entity.rigidbody.applyForce(0,-20,0),a=c.x,n=c.z}if(this.moveDirection=new pc.Vec3(a,0,n),!this.disableRotate&&(0!==a||0!==n)){var p=this.rotateTo,h=90+180*Math.atan2(this.moveDirection.z,-this.moveDirection.x)/Math.PI-180;shortestDistance=this.shortestDistDegrees(p,h),this.rotateTo=p+shortestDistance}if(this.moveTimer+=t,!this.disableMove){if(0!==a||0!==n){let i=this.speed;e.keyboard.isPressed(pc.KEY_SHIFT)&&(i=this.runSpeed);let o=(new pc.Vec3).copy(e.systems.rigidbody.gravity);this.force.set(a,o.y*t,n).normalize().scale(i*this.mass),this.entity.rigidbody.applyForce(this.force)}this.jumpTimer+=t,e.keyboard.isPressed(pc.KEY_SPACE)&&this.jumpTimer>this.interval&&this.jump()}this.disableMove?e.fire("PlayAnim:setWalkValue",0):e.fire("PlayAnim:setWalkValue",Math.abs(a)+Math.abs(n)),this.entity.getPosition().y<-20&&(this.startPoint=e.root.findByName("Start Point"),this.entity.rigidbody.linearVelocity=pc.Vec3.ZERO,this.entity.rigidbody.teleport(this.startPoint.getPosition())),this.rotY=pc.math.lerpAngle(this.rotY,this.rotateTo,t/.1),this.quatY.setFromAxisAngle(pc.Vec3.UP,this.rotY),this.body.setRotation(this.quatY)},PlayerControl.prototype.isSlope=function(){const t=this.groundCheckFrom.getPosition(),e=this.groundCheckTo.getPosition(),i=this.app.systems.rigidbody.raycastFirst(t,e);null!==i?(this.slopeHit=i,this.slopeNormal=i.normal):this.slopeNormal=pc.Vec3.UP},PlayerControl.prototype.projectOnPlane=function(t,e){var i;void 0===i&&(i=new pc.Vec3);const o=(new pc.Vec3).copy(t);return i.copy(o).project(e),o.sub(i)},PlayerControl.prototype.projectOnPlane2=function(t,e){var i=(new pc.Vec3).copy(t),o=(new pc.Vec3).copy(e);new pc.Vec3;return i.sub(o.mulScalar(i.dot(o)))},PlayerControl.prototype.jump=function(){this.entity.rigidbody.applyImpulse(new pc.Vec3(0,this.jumpImpulseY*this.entity.rigidbody.mass,0)),this.jumpTimer=0},PlayerControl.prototype.shortestDistDegrees=function(t,e){const i=(e-t)%360;let o=180-Math.abs(Math.abs(i)-180);return o*=(i+360)%360<180?1:-1};var Player=pc.createScript("player");Player.attributes.add("bullet",{type:"entity"}),Player.attributes.add("maxBullet",{type:"number",default:5}),Player.attributes.add("materials",{type:"asset",assetType:"material",array:!0,title:"Materials"}),Player.prototype.initialize=function(){const t=this.app;pc.platform.mobile||pc.platform.touch?this.app.root.findByName("Mobile UI"):this.app.root.findByName("Desktop UI");this.body=this.entity.findByName("Body"),this.camera=this.entity.findByName("Camera"),this.disableBorn=!1,this.disableFire=!1,this.texture=0,this.frame=t.root.findByName("Frame"),this.eggCount=0,this.eggGroup=t.root.findByName("Egg Group"),t.on("player:set",(function(t,e){this[t]=e}),this),t.on("player:setRigidbody",(function(t){this.entity.rigidbody.type=t}),this),t.on("player:teleport",(function(t){this.entity.rigidbody.teleport(t)}),this),t.on("player:born",(function(){this.onBorn()}),this),t.on("player:enableBorn",(function(){this.disableBorn=!1}),this),t.on("player:disableBorn",(function(){this.disableBorn=!0}),this),t.on("player:resetBorn",(function(){this.resetBorn()}),this)},Player.prototype.update=function(t){this.app.keyboard.wasPressed(pc.KEY_E)&&this.onBorn()},Player.prototype.getMaterial=function(t){if(this.materials.length>=t)return this.materials[t].resource},Player.prototype.onCollision=function(t){let e=t.other;e.rigidbody&&"Scavenger"===e.name&&(e.enabled=!1)},Player.prototype.onBorn=function(){let t=null;if(this.app.root.findByName("Born Position")&&(t=this.app.root.findByName("Born Position")),!this.disableBorn&&null!==t){var e=this.body.forward,i=(this.body.right,this.bullet.clone());i.setPosition(t.getPosition()),i.enabled=!0,console.log(this.eggGroup),this.eggGroup.addChild(i),i.rigidbody.applyForce(e.add(new pc.Vec3(pc.math.random(-1,1),0,pc.math.random(-1,1))).scale(pc.math.random(.5,.8))),i.rigidbody.applyTorqueImpulse(new pc.Vec3(pc.math.random(-1,1),pc.math.random(-1,1),pc.math.random(-1,1)).scale(pc.math.random(.1,.2))),setTimeout((()=>{i.destroy(),this.eggCount--}),6e4),this.eggCount++,this.eggCount>=this.maxBullet&&(this.eggGroup.children[0].destroy(),this.eggCount--)}},Player.prototype.resetBorn=function(){for(;this.eggGroup.children[0];)this.eggGroup.children[0].destroy()};var CameraControl=pc.createScript("cameraControl");CameraControl.attributes.add("camera",{type:"entity"}),CameraControl.attributes.add("follow",{type:"entity"}),CameraControl.attributes.add("lookAt",{type:"entity"}),CameraControl.attributes.add("mouseSpeed",{type:"number",default:.5,description:"Mouse Sensitivity"}),CameraControl.attributes.add("cameraSpeed",{type:"number",default:.2,min:0,max:1}),CameraControl.attributes.add("startDistance",{type:"number",default:5}),CameraControl.attributes.add("minDistance",{type:"number",default:3}),CameraControl.attributes.add("maxDistance",{type:"number",default:15}),CameraControl.attributes.add("topDegree",{type:"number",default:80}),CameraControl.attributes.add("bottomDegree",{type:"number",default:-80}),CameraControl.attributes.add("excludeTagName",{type:"string"}),CameraControl.prototype.initialize=function(){const t=this.app,e=this.follow,o=this.lookAt;this.startEulers=new pc.Vec3,this.eulers=new pc.Vec3(this.camera.getEulerAngles().y,0,0),this.oldEulers=this.eulers.clone(),this.eulersEase=this.eulers.clone(),this.delta=new pc.Vec3,this.zoom=this.startDistance,this.zoomEase=this.startDistance,this.cameraPos=this.camera.getPosition(),this.newFollowPos=this.follow?this.follow.getPosition().clone():this.cameraPos.clone(),this.newLookAtPos=this.lookAt?this.lookAt.getPosition().clone():this.cameraPos.clone(),this.disableMove=!1,this.followSpeed=1-this.cameraSpeed,this.lookAtSpeed=1-this.cameraSpeed,pc.platform.mobile||pc.platform.touch?(console.log("touch"),this.touchStartPos=new pc.Vec3,this.touchPos=new pc.Vec3,this.touchDetla=new pc.Vec3,this.touchId=-1,t.touch.on(pc.EVENT_TOUCHSTART,this.onTouchStart,this)):(console.log("mouse"),t.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),t.mouse.on(pc.EVENT_MOUSEWHEEL,this.onMouseWheel,this)),t.on("playerCamera:changeTarget",(function(t,e){this.oldEulers.copy(this.eulers),this.eulers.copy(pc.Vec3.ZERO),this.follow=t,this.lookAt=e,this.followSpeed=.6,this.lookAtSpeed=.6}),this),t.on("playerCamera:resetTarget",(function(){this.eulers.copy(this.oldEulers),this.follow=e,this.lookAt=o,this.zoom=this.startDistance,this.followSpeed=1-this.cameraSpeed,this.lookAtSpeed=1-this.cameraSpeed}),this),t.on("playerCamera:startFromPlayer",(function(){this.newFollowPos=this.follow.getPosition(),this.newLookAtPos=this.lookAt.getPosition()}),this),t.on("playerCamera:set",(function(t,e){this[t]=e}),this),t.on("playerCamera:enable",(function(){this.disableMove=!1}),this),t.on("playerCamera:disable",(function(){this.disableMove=!0}),this),t.on("playerCamera:reset",(function({x:t,y:e}){this.eulers.x=e,this.eulers.y=t}),this)},CameraControl.prototype.onTouchStart=function(t){t.event.stopPropagation(),t.event.preventDefault();for(var e=t.changedTouches,o=0,s=e.length;o<s;o+=1){var i=e[o];if(i.id===this.touchId||-1===this.touchId){var a=this.app;this.touchStartPos.x=i.x,this.touchStartPos.y=i.y,this.screenPos=this.getScreenPos(this.touchStartPos),this.screenPos.x>0&&(this.touchId=i.id,a.touch.on(pc.EVENT_TOUCHMOVE,this.onTouchMove,this),a.touch.on(pc.EVENT_TOUCHEND,this.onTouchEnd,this))}}},CameraControl.prototype.onTouchMove=function(t){t.event.stopPropagation();for(var e=0;e<t.changedTouches.length;e++){var o=t.changedTouches[e];o.id===this.touchId&&(this.touchDetla.x=this.touchStartPos.x-o.x,this.touchDetla.y=this.touchStartPos.y-o.y,this.eulers.x+=3*this.mouseSpeed*this.touchDetla.x%360,this.eulers.y-=3*this.mouseSpeed*this.touchDetla.y%360,this.eulers.y=pc.math.clamp(this.eulers.y,this.bottomDegree,this.topDegree),this.touchStartPos.x=o.x,this.touchStartPos.y=o.y)}},CameraControl.prototype.onTouchEnd=function(t){t.event.stopPropagation();for(var e=0;e<t.changedTouches.length;e++){if(t.changedTouches[e].id===this.touchId){var o=this.app;this.touchId=-1,o.touch.off(pc.EVENT_TOUCHMOVE,this.onTouchMove,this),o.touch.off(pc.EVENT_TOUCHEND,this.onTouchEnd,this)}}},CameraControl.prototype.onMouseDown=function(t){t.event.preventDefault();var e=this.app;this.disableMove||(this.startEulers.x=t.dx,this.startEulers.y=t.dy,e.mouse.on(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),e.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this))},CameraControl.prototype.onMouseMove=function(t){t.event.preventDefault(),this.disableMove||(this.delta.x=t.dx-this.startEulers.x,this.delta.y=t.dy-this.startEulers.y,this.eulers.x-=this.mouseSpeed*this.delta.x%360,this.eulers.y+=this.mouseSpeed*this.delta.y%360,this.eulers.y=pc.math.clamp(this.eulers.y,this.bottomDegree,this.topDegree))},CameraControl.prototype.onMouseUp=function(t){t.event.preventDefault();var e=this.app;this.delta=new pc.Vec3,this.startEulers=new pc.Vec3,e.mouse.off(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),e.mouse.off(pc.EVENT_MOUSEUP,this.onMouseUp,this)},CameraControl.prototype.onMouseWheel=function(t){this.disableMove||(this.zoom+=t.wheelDelta/2,this.zoom=pc.math.clamp(this.zoom,this.minDistance,this.maxDistance))},CameraControl.prototype.update=function(t){if(this.follow&&this.lookAt){const e=this.follow.getPosition(),o=this.lookAt.getPosition();this.zoomEase+=(this.zoom-this.zoomEase)*(t/.2),this.eulersEase.lerp(this.eulersEase,this.eulers,t/this.followSpeed),this.newFollowPos.lerp(this.newFollowPos,e,t/this.followSpeed),this.newLookAtPos.lerp(this.newLookAtPos,o,t/this.lookAtSpeed);const s=(90-this.eulersEase.y)*Math.PI/180,i=(90-this.eulersEase.x)*Math.PI/180;let a=new pc.Vec3(this.newFollowPos.x+this.zoomEase*Math.sin(s)*Math.cos(i),this.newFollowPos.y+this.zoomEase*Math.cos(s),this.newFollowPos.z+this.zoomEase*Math.sin(s)*Math.sin(i));a=this.getCollectionPoint(a),this.camera.setPosition(a),this.camera.lookAt(this.newLookAtPos),this.app.fire("mapController:rotateCamera",90-i/Math.PI*180)}},CameraControl.prototype.zoomTo=function(t){this.zoom=t},CameraControl.prototype.getCollectionPoint=function(t){const e=this.follow.getPosition(),o=t,s=e.clone().sub(o.clone()).normalize(),i=this.app.systems.rigidbody.raycastFirstExcludeTag(e,o,this.excludeTagName);return i?i.point.add(s.scale(.1)):o},CameraControl.prototype.getScreenPos=function(t){var e=this.app.graphicsDevice,o=t.x*window.devicePixelRatio-e.width/2,s=-t.y*window.devicePixelRatio+e.height/2;return new pc.Vec3(o,s,0)};var ObjectPicker=pc.createScript("objectPicker");ObjectPicker.prototype.initialize=function(){this.moveEntity,pc.platform.mobile||pc.platform.touch?this.app.touch.on(pc.EVENT_TOUCHSTART,this.onSelect,this):this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onSelect,this),this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onMove,this)},ObjectPicker.prototype.onSelect=function(t){this.canvas=document.querySelector("#application-canvas"),t.event.stopPropagation(),t.event.preventDefault();var e,i,r=this;if(r.entity.camera){if(pc.platform.mobile||pc.platform.touch)for(var o=t.changedTouches,c=0,a=o.length;c<a;c+=1){var s=o[c];e=s.x,i=s.y}else e=t.x,i=t.y;var n=r.entity.camera.screenToWorld(e,i,r.entity.camera.nearClip),p=r.entity.camera.screenToWorld(e,i,r.entity.camera.farClip),l=r.app.systems.rigidbody.raycastFirst(n,p);if(l){var m=l.entity;if(m.script)if(m.script.link&&m.script.link.openLink(),m.script.caption&&m.script.caption.openCaption(),m.script.infoControl&&m.script.infoControl.infoOpen(),m.script.podium&&r.app.fire("podium:enter"),m.script.seatLogic&&m.script.seatLogic.sit(),m.script.lookAtme&&m.script.lookAtme.look(),m.script.rmobjectEvent&&m.script.rmobjectEvent.checkEvent(),m.script.iframePlane){m.script.iframePlane.iframeUrl}else this.canvas.focus();else this.canvas.focus()}else this.canvas.focus()}},ObjectPicker.prototype.onMove=function(t){t.event.stopPropagation(),t.event.preventDefault();var e,i,r=this;r.entity.camera&&(e=t.x,i=t.y);var o=r.entity.camera.screenToWorld(e,i,r.entity.camera.nearClip),c=r.entity.camera.screenToWorld(e,i,r.entity.camera.farClip),a=r.app.systems.rigidbody.raycastFirst(o,c);if(a){var s=a.entity;void 0!==this.moveEntity&&this.moveEntity.particlesystem&&this.moveEntity!==s&&!0===this.moveEntity.particlesystem.isPlaying()&&this.moveEntity.particlesystem.stop(),s.particlesystem&&(s.particlesystem.play(),this.moveEntity=s)}};var Compound=pc.createScript("compound");Compound.prototype.initialize=function(){this.entity.collision.type="compound"},Compound.prototype.update=function(o){};var Ccd=pc.createScript("ccd");Ccd.attributes.add("motionThreshold",{type:"number",default:1,title:"Motion Threshold",description:"Number of meters moved in one frame before CCD is enabled"}),Ccd.attributes.add("sweptSphereRadius",{type:"number",default:.2,title:"Swept Sphere Radius",description:"This should be below the half extent of the collision volume. E.g For an object of dimensions 1 meter, try 0.2"}),Ccd.prototype.initialize=function(){var e;(e=this.entity.rigidbody.body).setCcdMotionThreshold(this.motionThreshold),e.setCcdSweptSphereRadius(this.sweptSphereRadius),this.on("attr:motionThreshold",(function(t,i){(e=this.entity.rigidbody.body).setCcdMotionThreshold(t)})),this.on("attr:sweptSphereRadius",(function(t,i){(e=this.entity.rigidbody.body).setCcdSweptSphereRadius(t)}))};!function(){var t=new pc.Vec3;pc.RigidBodyComponentSystem.prototype.raycastFirstExcludeTag=function(n,r,a){for(var e=Number.MAX_VALUE,i=null,s=this.app.systems.rigidbody.raycastAll(n,r),o=0;o<s.length;++o){var c=s[o];if(!c.entity.tags.has(a)){t.sub2(c.point,n);var p=t.lengthSq();p<e&&(e=p,i=c)}}return i}}();gsap.registerEffect({name:"position",effect:(e,t)=>{let i,n=e.map((e=>e.entity)),o=n.map((e=>e.getPosition())),a=t.onUpdate;return t.onUpdate=()=>{n.forEach(((e,t)=>e.setPosition(o[t]))),a&&a.call(i)},i=gsap.to(o,t),i},extendTimeline:!0});pc.extend(pc,function(){"use strict";var epsilon=function(e){return Math.abs(e)<1e-10?0:e},e=pc.Application.getApplication(),getCameraCSSMatrix=function(e){var t=e.data;return"matrix3d("+epsilon(t[0])+","+epsilon(-t[1])+","+epsilon(t[2])+","+epsilon(t[3])+","+epsilon(t[4])+","+epsilon(-t[5])+","+epsilon(t[6])+","+epsilon(t[7])+","+epsilon(t[8])+","+epsilon(-t[9])+","+epsilon(t[10])+","+epsilon(t[11])+","+epsilon(t[12])+","+epsilon(-t[13])+","+epsilon(t[14])+","+epsilon(t[15])+")"},Css3Renderer=function(){if(e.css3Renderer)return e.css3Renderer;e.css3Renderer=this,this._stageElement=null,this._cameras=[],this._cameraElements=[],this._defaultCameraElement=null,this._css3Targets=[],this._cameraInvertMat=new pc.Mat4,this._cameraHalfSize=new pc.Vec2;var t=document.createElement("div");t.style.overflow="hidden",t.style.pointerEvents="auto",t.style.position="absolute",t.style.zIndex="1",document.body.appendChild(t);var s=e.touch;s&&s.attach(t),e.elementInput&&e.elementInput.attach(t);var i=document.getElementById("application-canvas");i.style.pointerEvents="none",document.body.insertBefore(t,i),this._stageElement=t,this._defaultCameraElement=this.addCamera(e.root.findComponent("camera"));var n=this;function onWindowResize(){n._width=window.innerWidth,n._height=window.innerHeight,n._widthHalf=n._width/2,n._heightHalf=n._height/2,n._stageElement.style.width=n._width+"px",n._stageElement.style.height=n._height+"px";for(var e=0;e<n._cameraElements.length;e++)n._cameraElements[e].style.width=n._width+"px",n._cameraElements[e].style.height=n._height+"px"}onWindowResize(),window.addEventListener("resize",onWindowResize,!1)};Css3Renderer.prototype={render:function(){this._isRendering||(this._isRendering=!0,e.on("update",this._renderElements,this))},cancelRender:function(){e.off("update",this._renderElements,this),this._isRendering=!1},addCamera:function(e){if(!e)return this._defaultCameraElement;if(this._cameras.indexOf(e)>-1)return this._cameraElements[this._cameras.indexOf(e)];var t=document.createElement("div");return t.style.WebkitTransformStyle="preserve-3d",t.style.transformStyle="preserve-3d",t.style.pointerEvents="none",this._stageElement.appendChild(t),this._cameras.push(e),this._cameraElements.push(t),t},addTarget:function(e){this._css3Targets.indexOf(e)<=-1&&this._css3Targets.push(e)},removeTarget:function(e){var t=this._css3Targets.indexOf(e);-1!==t&&this._css3Targets.splice(t,1)},blockEvents:function(e){for(var t=0;t<this._css3Targets.length;this._css3Targets[t++].blockEvents(e));},_renderElements:function(){for(var e=0;e<this._cameras.length;e++){var t,s,i,n=this._cameras[e],a=this._cameraElements[e],r=n.projectionMatrix.data[5]*this._heightHalf;n.projection==pc.PROJECTION_PERSPECTIVE?(this._stageElement.style.WebkitPerspective=r+"px",this._stageElement.style.perspective=r+"px"):(this._stageElement.style.WebkitPerspective="",this._stageElement.style.perspective=""),n.projection==pc.PROJECTION_ORTHOGRAPHIC&&(pc.Mat4._getPerspectiveHalfSize(this._cameraHalfSize,n.fov,n.aspectRatio,n.nearClip,n.horizontalFov),t=-(this._cameraHalfSize.x-this._cameraHalfSize.x)/2,s=(this._cameraHalfSize.y-this._cameraHalfSize.y)/2),this._cameraInvertMat.copy(n.entity.getWorldTransform()).invert(),i=(n.projection==pc.PROJECTION_ORTHOGRAPHIC?"scale("+r+")translate("+epsilon(t)+"px,"+epsilon(s)+"px)"+getCameraCSSMatrix(this._cameraInvertMat):"translateZ("+r+"px)"+getCameraCSSMatrix(this._cameraInvertMat))+"translate("+this._widthHalf+"px,"+this._heightHalf+"px)",a.style.WebkitTransform=i,a.style.transform=i}for(var h=0;h<this._css3Targets.length;this._css3Targets[h++].updateTransform());}};var Css3Plane=function(t,s,i,n){e.css3Renderer||(e.css3Renderer=new pc.Css3Renderer),this._renderer=e.css3Renderer,t||((t=document.createElement("div")).innerHTML="CSS3 Plane",t.style.backgroundColor="rgb("+Math.round(255*Math.random())+","+Math.round(255*Math.random())+","+Math.round(255*Math.random())+")",t.style.textAlign="center"),t.style.position="absolute",t.style.pointerEvents="auto",this.dom=t,s||(s=new pc.Entity,e.root.addChild(s)),this.entity=s,this.cameraElement=this._renderer.addCamera(n),this.cameraElement.appendChild(t),this._maxWidth=1920,this._maxHeight=1080,i=i||this._maxWidth,this.pixelsPerWorldUnit=new pc.Vec2(i,i),this._renderer.addTarget(this),this._renderer.render()};return Css3Plane.prototype={updateTransform:function(){var e,t,s,i=this.entity.getWorldTransform(),n=i.getScale(),a=Math.min(n.x*this.pixelsPerWorldUnit.x,this._maxWidth),r=Math.min(n.z*this.pixelsPerWorldUnit.y,this._maxHeight),h=(e=a,t=r,s=i.data,"translate(-50%,-50%)matrix3d("+epsilon(s[0]/e)+","+epsilon(s[1]/e)+","+epsilon(s[2]/e)+","+epsilon(s[3]/e)+","+epsilon(s[8]/t)+","+epsilon(s[9]/t)+","+epsilon(s[10]/t)+","+epsilon(s[11]/t)+","+epsilon(s[4])+","+epsilon(s[5])+","+epsilon(s[6])+","+epsilon(s[7])+","+epsilon(s[12])+","+epsilon(s[13])+","+epsilon(s[14])+","+epsilon(s[15])+")");this.dom.style.width=Math.round(a)+"px",this.dom.style.height=Math.round(r)+"px",this.dom.style.lineHeight=this.dom.style.height,this.dom.style.WebkitTransform=h,this.dom.style.transform=h},blockEvents:function(e){this.dom.style.pointerEvents=e?"none":"auto"},attachPlane:function(e){this.entity=e},disable:function(){this.cameraElement.removeChild(this.dom),this._renderer.removeTarget(this)},enable:function(){this.cameraElement.appendChild(this.dom),this._renderer.addTarget(this)}},{Css3Renderer:Css3Renderer,Css3Plane:Css3Plane}}());pc.script.createLoadingScreen((function(e){var t,a;t=["body {","    background-color: #000000;","}","","#application-splash-wrapper {","    position: absolute;","    top: 0;","    left: 0;","    height: 100%;","    width: 100%;","    background-color: #000000;","}","","#application-splash {","    position: absolute;","    top: 50%;","    width: 400px;","    height: 200px;","    left: 50%;","    transform: translate(-50%, -50%);","}","","#application-splash img {","    width: 100%;","}","","#progress-bar-container {","    margin: 20px auto 0 auto;","    height: 2px;","    width: 100%;","    background-color: #fff;","}","","#progress-bar {","    width: 0%;","    height: 100%;","    background-color: #f23d2a;","}","","@media (max-width: 480px) {","    #application-splash {","        width: 200px;","        left: calc(50% - 100px);","    }","}"].join("\n"),(a=document.createElement("style")).type="text/css",a.styleSheet?a.styleSheet.cssText=t:a.appendChild(document.createTextNode(t)),document.head.appendChild(a),function(){var e=document.createElement("div");e.id="application-splash-wrapper",document.body.appendChild(e);var t=document.createElement("div");t.id="application-splash",e.appendChild(t),t.style.display="none";var a=document.createElement("img");a.src="https://play.grwth.hk/icon.png",t.appendChild(a),a.onload=function(){t.style.display="block"};var o=document.createElement("div");o.id="progress-bar-container",t.appendChild(o);var n=document.createElement("div");n.id="progress-bar",o.appendChild(n)}(),e.on("preload:end",(function(){e.off("preload:progress")})),e.on("preload:progress",(function(e){var t=document.getElementById("progress-bar");t&&(e=Math.min(1,Math.max(0,e)),t.style.width=100*e+"%")})),e.on("start",(function(){var e=document.getElementById("application-splash-wrapper");e.parentElement.removeChild(e)}))}));var FaceTocamera=pc.createScript("faceTocamera");FaceTocamera.prototype.initialize=function(){const a=this.app;this.camera=a.root.findByName("Camera")},FaceTocamera.prototype.update=function(a){var t=this.camera.getPosition();this.entity.lookAt(t),this.entity.rotateLocal(0,180,0)};var YoutubeControls=pc.createScript("youtubeControls");YoutubeControls.attributes.add("youTubePlane",{type:"entity"}),YoutubeControls.attributes.add("playButton",{type:"entity"}),YoutubeControls.attributes.add("muteButton",{type:"entity"}),YoutubeControls.attributes.add("playIcon",{type:"asset",assetType:"texture"}),YoutubeControls.attributes.add("pauseIcon",{type:"asset",assetType:"texture"}),YoutubeControls.attributes.add("unmuteIcon",{type:"asset",assetType:"texture"}),YoutubeControls.attributes.add("muteIcon",{type:"asset",assetType:"texture"}),YoutubeControls.prototype.initialize=function(){const t=this.app;this.mute=!0,this.youTubePlane.on("youtubeready",this._onYouTubePlaneReady,this),this.playButton.element.on("click",(function(){1===this._player.getPlayerState()||3===this._player.getPlayerState()?t.fire("youtube:pause"):t.fire("youtube:play")}),this),this.muteButton.element.on("click",(function(){this._player.isMuted()?(t.fire("youtube:unmute"),t.fire("sound:pause","BG Music")):(t.fire("youtube:mute"),t.fire("sound:play","BG Music"))}),this),t.on("youtubeControl:play",(function(){this.playButton.element.texture=this.pauseIcon.resource}),this),t.on("youtubeControl:pause",(function(){this.playButton.element.texture=this.playIcon.resource}),this),t.on("youtube:play",(function(){this.playButton.element.texture=this.pauseIcon.resource,this._player.playVideo()}),this),t.on("youtube:pause",(function(){this.playButton.element.texture=this.playIcon.resource,this._player.pauseVideo()}),this),t.on("youtube:unmute",(function(){this._player.isMuted()&&(this.muteButton.element.texture=this.unmuteIcon.resource,this._player.unMute())}),this),t.on("youtube:mute",(function(){this._player.isMuted()||(this.muteButton.element.texture=this.muteIcon.resource,this._player.mute())}),this)},YoutubeControls.prototype._onYouTubePlaneReady=function(t){this._player=t};var YoutubePlane=pc.createScript("youtubePlane");function onYouTubeIframeAPIReady(){window.youTubeReady=!0}if(YoutubePlane.attributes.add("videoId",{type:"string"}),window.youTubeReady=!1,window.document){var tag=document.createElement("script");tag.src="https://www.youtube.com/iframe_api";var firstScriptTag=document.getElementsByTagName("script")[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag)}YoutubePlane.prototype.initialize=function(){this._createdPlane=!1},YoutubePlane.prototype.update=function(e){window.YT&&window.YT.loaded&&!this._createdPlane&&(this.onYoutubeApiReady(),this._createdPlane=!0)},YoutubePlane.prototype.onYoutubeApiReady=function(){var e=this,t=null,i=document.createElement("div");i.id=this.entity.getGuid(),i.style.width="100%",i.style.height="100%",i.style.border="0px",i.style.pointerEvents="none",(t=document.createElement("div")).style.width="100%",t.style.height="100%",t.style.border="0px",t.appendChild(i),this._css3Plane=new pc.Css3Plane(t,this.entity,this.pixelsPerUnit),this._player=new YT.Player(this.entity.getGuid(),{height:"100%",width:"100%",events:{onReady:function(){e.entity.fire("youtubeready",e._player)}}}),document.getElementById(e.entity.getGuid()).src="https://www.youtube.com/embed/"+this.videoId+"?enablejsapi=1&controls=0&playsinline=1&origin="+encodeURI(window.location.origin);var n=new pc.StandardMaterial;n.depthWrite=!0,n.redWrite=!1,n.greenWrite=!1,n.blueWrite=!1,n.alphaWrite=!1,n.blendType=pc.BLEND_NONE,n.opacity=0,n.update(),this.entity.render.material=n,this.on("destroy",(function(){this._css3Plane.disable()}),this)};var TvScreen=pc.createScript("tvscreen");TvScreen.prototype.initialize=function(){this.app.on("tv:play",(function(e,i){if(i.resource){var p=i.resource;p.diffuseMap=e,p.emissiveMap=e,p.update()}i.diffuseMap&&(i.diffuseMap=e,i.emissiveMap=e,i.update())}),this)};var VideoControl=pc.createScript("videoControl");VideoControl.attributes.add("screen",{title:"Video",type:"entity"}),VideoControl.prototype.initialize=function(){this.entity.element.on("mousedown",this._onPress,this),this.entity.element.on("touchstart",this._onPress,this);this.entity},VideoControl.prototype._onPress=function(t){this.screen.script.videoTexture.control(this.entity)};var VideoStatus=pc.createScript("videoStatus");VideoStatus.attributes.add("play",{type:"asset",assetType:"texture"}),VideoStatus.attributes.add("pause",{type:"asset",assetType:"texture"}),VideoStatus.prototype.initialize=function(){this.app.on("video:playing",(function(t){t.children[0].element.texture=this.pause.resource}),this),this.app.on("video:paused",(function(t){t.children[0].element.texture=this.play.resource}),this)};var JumpPad=pc.createScript("jumpPad");JumpPad.attributes.add("springFace",{type:"entity"}),JumpPad.attributes.add("impulse",{type:"number",default:5}),JumpPad.prototype.initialize=function(){this.springFace.collision.on("collisionstart",this.onCollisionStart,this)},JumpPad.prototype.onCollisionStart=function(i){const t=i.contacts[0].normal,s=i.other;s.rigidbody.applyImpulse(this.impulse*s.rigidbody.mass*t.x,this.impulse*s.rigidbody.mass*Math.abs(t.y),this.impulse*s.rigidbody.mass*t.z)};var Teleport=pc.createScript("teleport");Teleport.attributes.add("target",{type:"entity"}),Teleport.attributes.add("goToRoom",{type:"string"}),Teleport.attributes.add("launcher",{type:"entity"}),Teleport.prototype.initialize=function(t){const e=this,o=this.app;this.playerControl=o.root.findByName("Player").script.playerControl,this.camera=o.root.findByName("Camera"),this.raycastEndPoint=o.root.findByName("RaycastEndPoint"),this.targetScript=this.target.script.teleport,this.privateRoomPanel=o.root.findByName("Private Room UI"),this.privateRoomPanelSubmitBtn=this.privateRoomPanel.findByName("Enter Button"),this.network=o.root.findByName("Root").script.network,this.socket=this.network.socket,this.teleportPositionEntity=this.target.findByName("Teleport Position"),this.teleportPosition=this.teleportPositionEntity.getPosition(),this.isPrivateRoom=!1,this.on("enable",this.onEnable,this),this.on("disable",this.onDisable,this),this.onEnable(),this.teleportEntity=null,this.socket.on("privateRoomStatus",(function(t){e.teleportEntity&&("success"===t.status?(e.changeRoom(e.teleportEntity),e.privateRoomPanelSubmitBtn.script.submit.reset()):e.privateRoomPanelSubmitBtn.script.submit.fail())}))},Teleport.prototype.onEnable=function(){this.entity.collision.on("triggerenter",this.onTriggerEnter,this)},Teleport.prototype.onDisable=function(){this.entity.collision.off("triggerenter",this.onTriggerEnter,this)},Teleport.prototype.findIndex=function(){const t=this.app.root.findByName("Entrance").children;for(var e in t)if(this.entity.name===t[e].name)return e},Teleport.prototype.onTriggerEnter=function(t){"Player"===t.name&&(this.app.fire("playerControl:disable"),this.isPrivateRoom?(this.teleportEntity=t,this.privateRoomPanel.enabled=!0,this.privateRoomPanelSubmitBtn.script.submit.toRoomIdx=this.findIndex(),this.privateRoomPanelSubmitBtn.script.submit.toRoom=this.goToRoom):this.changeRoom(t))},Teleport.prototype.converToDegrees=function(t){var e=new pc.Vec3;return t.transformVector(pc.Vec3.FORWARD,e),Math.atan2(-e.x,-e.z)*pc.math.RAD_TO_DEG},Teleport.prototype.changeRoom=function(t){if(t){const e=this.app,o=new pc.Vec3(0,this.converToDegrees(this.teleportPositionEntity.getLocalRotation()),0);t.findByName("Body");this.privateRoomPanel.enabled=!1,gsap.to(this.camera.camera,1,{fov:80,ease:"power3.in",onComplete:()=>{t.findByName("Face")&&t.findByName("Face").script.webCamPlane.leave(),this.camera&&e.fire("playerCamera:reset",{x:0,y:o.y}),e.fire("playerControl:rotate",o.y),e.fire("playerControl:reset",o.y),t.rigidbody.linearVelocity=pc.Vec3.ZERO,t.rigidbody.angularVelocity=pc.Vec3.ZERO,t.rigidbody.teleport(this.teleportPosition),setTimeout((()=>{e.fire("playerControl:enable")}),500),this.launcher&&(this.launcher.enabled?this.launcher.enabled=!1:this.launcher.enabled=!0),this.teleportEntity=null,this.socket.emit("changeRoom",{roomId:this.goToRoom}),gsap.to(this.camera.camera,.6,{fov:45,ease:"power3.out"})}})}};var Link=pc.createScript("link");Link.attributes.add("url",{type:"string"}),Link.attributes.add("popup",{type:"boolean"}),Link.prototype.initialize=function(){},Link.prototype.openLink=function(){this.popup?""!==this.url&&this.app.fire("popup:open",this.url):window.open(this.url,"_blank")};var ScreenFocus=pc.createScript("screenFocus");ScreenFocus.prototype.initialize=function(){this.app;this.entity.element.on("mousedown",this.onPress,this),this.entity.element.on("touchstart",this.onPress,this)},ScreenFocus.prototype.onPress=function(e){this.app;this.app.fire("lookAt:screen")};var SeatLogic=pc.createScript("seatLogic");SeatLogic.prototype.initialize=function(){var i=this.app;this.player=i.root.findByName("Player"),this.pos=this.entity.findByName("SitPosition")},SeatLogic.prototype.sit=function(){var i=this.pos.getPosition();this.player.rigidbody.linearVelocity=pc.Vec3.ZERO,this.player.rigidbody.angularVelocity=pc.Vec3.ZERO,this.player.rigidbody.teleport(i),this.app.fire("playerCamera:set","zoom",15)};var Lock=pc.createScript("lock");Lock.attributes.add("targetTeleport",{type:"entity"}),Lock.prototype.initialize=function(){this.networkScript=this.app.root.findByName("Root").script.network,this.socket=this.networkScript.socket},Lock.prototype.onTrigger=function(){var t=this.targetTeleport;this.socket.emit("lockRoom",{id:this.networkScript.id,teleportName:t.name})};var LookAtme=pc.createScript("lookAtme");LookAtme.prototype.initialize=function(){this.active=!1,this.player=this.app.root.findByName("Player"),this.app.on("lookAt:screen",(function(){this.look("Screen")}),this)},LookAtme.prototype.look=function(e){var a=this.app;if(this.active)this.active=!1,a.fire("playerCamera:resetTarget"),a.fire("playerCamera:enable"),this.player.tags.has("Speaker")||(a.fire("playerControl:enable"),a.fire("player:hideName",!1));else{this.active=!0;const t=a.root.findByName(`${e} Camera Point`),r=a.root.findByName(`${e} LookAt Point`);t&&r&&(this.player.tags.has("Speaker")||(a.fire("playerControl:disable"),a.fire("player:hideName",!0)),a.fire("playerCamera:changeTarget",t,r),a.fire("playerCamera:disable"))}};var FireButton=pc.createScript("fireButton");FireButton.prototype.initialize=function(){this.app;this.entity.element.on("touchstart",this.onTouchStart,this)},FireButton.prototype.onTouchStart=function(t){this.app.fire("playerControl:jump")};var SceneManager=pc.createScript("sceneManager");SceneManager.attributes.add("sceneRootEntity",{type:"entity"}),SceneManager.prototype.initialize=function(){const e=this.app,o=pc.platform.mobile||pc.platform.touch?this.app.root.findByName("Mobile UI"):this.app.root.findByName("Desktop UI");this.inGameUI=o.findByName("In-game UI"),this.loading=e.root.findByName("Scene Progress Bar"),e.on("sceneManager:loadScene",(function(e,o,n,t){this.loadScene(e,o,n,t)}),this)},SceneManager.prototype.loadScene=function(e,o,n,t){const a=this,r=this.app,i=this.app.scenes.find(e);this.loading.enabled=!0,this.inGameUI.enabled=!1,r.fire("playerControl:disable"),r.fire("player:setRigidbody","static"),r.fire("loadAssetsManager:loadAssets",e,(function(){r.scenes.loadSceneHierarchy(i.url,(function(i,s){if(i)console.error(i);else{r.fire("loadAssetsManager:unLoadAssets",e),a.sceneRootEntity.children.length>0&&(console.log(a.sceneRootEntity.children[0]),a.sceneRootEntity.children[0].destroy()),s.reparent(a.sceneRootEntity),console.log("startPointName",e,n);const i=a.sceneRootEntity.findByName(n),c=new pc.Vec3(0,a.converToDegrees(i.getLocalRotation()),0);r.fire("playerControl:rotate",c.y),r.fire("playerControl:reset"),r.fire("playerControl:enable"),r.fire("player:teleport",i.getPosition()),r.fire("playerCamera:startFromPlayer"),r.fire("player:setRigidbody","dynamic"),r.fire("fullmap:hide"),r.fire("minimap:show"),r.fire("playerCamera:enable"),r.fire("socket:changeRoom",e,o),console.log("callback",t),t(e,n,i),"RoomMaker"===e&&r.fire("ModelJsonReader:EnterRoom"),a.loading.enabled=!1,a.app.fire("ModelJsonReader:EnterRoom"),console.log("Now the Scene is: "+e,i.getPosition())}}))}))},SceneManager.prototype.converToDegrees=function(e){var o=new pc.Vec3;return e.transformVector(pc.Vec3.FORWARD,o),Math.atan2(-o.x,-o.z)*pc.math.RAD_TO_DEG};var ChangeScene=pc.createScript("changeScene");ChangeScene.attributes.add("targetStartPoint",{type:"string",default:"Start Point"}),ChangeScene.attributes.add("enterPointName",{type:"string",default:"Undefined"}),ChangeScene.prototype.initialize=function(e){this.app;const t=pc.platform.mobile||pc.platform.touch?this.app.root.findByName("Mobile UI"):this.app.root.findByName("Desktop UI");this.privateRoomUI=t.findByName("Private Room UI"),this.roomMakerUI=t.findByName("Room Maker UI"),this.inGameUI=t.findByName("In-game UI"),this.on("enable",this.onEnable,this),this.on("disable",this.onDisable,this),this.onEnable()},ChangeScene.prototype.onEnable=function(){this.entity.collision.on("triggerenter",this.onTriggerEnter,this)},ChangeScene.prototype.onDisable=function(){this.entity.collision.off("triggerenter",this.onTriggerEnter,this)},ChangeScene.prototype.onTriggerEnter=function(e){if(console.log(e.name),"Player"===e.name){const t=this.app,n=this.entity.name;t.fire("socket:setRoomIdx",n),"RoomMaker"!==n?(e.findByName("Face")&&e.findByName("Face").script.webCamPlane.leave(),console.log(this.targetStartPoint,"this.targetStartPoint"),t.fire("sceneManager:loadScene",n,this.enterPointName,this.targetStartPoint,(function(e,t){}))):(this.roomMakerUI.enabled=!0,this.inGameUI.enabled=!1,t.fire("playerControl:disable"))}},ChangeScene.prototype.findEntityIndex=function(){const e=this.app.root.findByName("Teleports");if(!e)return null;{const n=e.children;for(var t in n)if(this.entity.name===n[t].name)return t}};var LoadAssetsManager=pc.createScript("loadAssetsManager");LoadAssetsManager.prototype.initialize=function(){const s=this.app;this.progressBar=s.root.findByName("Scene Progress Bar"),this.progressBarText=this.progressBar.findByName("Text"),this.oldTag="Entrance",s.on("loadAssetsManager:unLoadAssets",(function(s){this.unLoadAssets(s)}),this),s.on("loadAssetsManager:loadAssets",(function(s,t){this.loadAssets(s,t)}),this)},LoadAssetsManager.prototype.unLoadAssets=function(s){var t=this.app.assets.findByTag(this.oldTag);this.progressBarText.element.text="";for(var e=0;e<t.length;e++)t[e].tags.has(s)||t[e].unload(),t.length;this.oldTag=s},LoadAssetsManager.prototype.loadAssets=function(s,t){const e=this;var a=this.app.assets.findByTag(s),o=0;this.progressBarText.element.text="0%";for(var n=0;n<a.length;n++)a[n].ready((function(){o++,e.progressBarText.element.text=Math.round(o/a.length*100)+"%",o===a.length&&t()})),this.app.assets.load(a[n])};var Podium=pc.createScript("podium");Podium.attributes.add("roomId",{type:"string"}),Podium.prototype.initialize=function(){const t=this.app;this.network=t.root.findByName("Root").script.network,this.socket=this.network.socket,this.player=t.root.findByName("Player"),this.pos=this.entity.findByName("Presenter Position"),this.active=!1,t.on("podium:enter",(function(){console.log("podium:enter"),t.fire("socket:speaking")}),this),t.on("podium:success",(function(){if(console.log("podium:success"),!this.active&&!0===this.network.haveSpeaker){if(console.log("podium:success if"),this.active=!0,t.fire("playerControl:reset"),this.pos){var e=this.pos.getPosition();this.player.rigidbody.teleport(e)}t.fire("playerControl:rotate",90),t.fire("playerCamera:set","zoom",15),this.network.applyToken({channel:this.roomId,token:this.network.token,type:"localScreen"})}}),this),t.on("podium:leave",(function(){this.active=!1,t.fire("playerControl:enable"),t.fire("socket:stopSpeaking")}),this)};var StageLogo=pc.createScript("stageLogo");StageLogo.attributes.add("material",{type:"asset",assetType:"material"}),StageLogo.prototype.initialize=function(){const e=this,t=this.app;t.on("stageLogo:update",(function(a){t.assets.loadFromUrl(a,"texture",(function(t,a){t?console.log(t):a&&(e.material.resource.diffuseMap=a.resource,e.material.resource.emissiveMap=a.resource,e.material.resource.update())}))}),this)};var SpeakerScreenPlane=pc.createScript("speakerScreenPlane");SpeakerScreenPlane.attributes.add("uniqueId",{type:"string"}),SpeakerScreenPlane.attributes.add("pixelsPerUnit",{type:"number",default:640,description:"Number of canvas pixels per unit of world space. The larger the number, the higher the resolution of the iframe."}),SpeakerScreenPlane.prototype.initialize=function(){this.player=this.app.root.findByName("Player"),this.networkScript=this.app.root.findByName("Root").script.network,this.div=document.createElement("div"),this.div.id=`speakerscreen${this.uniqueId}_stream`,this.div.style="width:100%;height:100%;position: relative;",this.client=null,this.initWebPage()},SpeakerScreenPlane.prototype.initWebPage=function(){var e=document.createElement("div");e.appendChild(this.div),this._css3Plane=new pc.Css3Plane(e,this.entity,this.pixelsPerUnit);var t=new pc.StandardMaterial;t.depthWrite=!0,t.redWrite=!1,t.greenWrite=!1,t.blueWrite=!1,t.alphaWrite=!1,t.blendType=pc.BLEND_NONE,t.opacity=0,t.update(),this.entity.model.material=t},SpeakerScreenPlane.prototype.initAgoraEvent=function(){const e=this;var handlePeerLeave=function(t){var i=t.stream,n=t.uid;n===e.uid&&(i.isPlaying()&&i.stop(),console.log("peer-leave: ",n),e.client.off("peer-leave",handlePeerLeave),e.client.off("stream-added",handleStreamAdded),e.client.off("stream-subscribed",handleStreamSubscribed),e.client.off("stream-removed",handleStreamRemoved))},handleStreamAdded=function(t){var i=t.stream,n=i.getId();n===e.uid&&(console.log("subscribe stream: "+n),e.client.subscribe(i))},handleStreamSubscribed=function(t){console.log("subscribed");var i=t.stream,n=i.getId();i.muteAudio(),i.play(`speakerscreen${e.uniqueId}_stream`),console.log("stream-subscribed remote-uid: ",n)},handleStreamRemoved=function(t){var i=t.stream,n=i.getId();i.isPlaying()&&i.stop(),console.log("stream-removed remote-uid: ",n),e.client.off("peer-leave",handlePeerLeave),e.client.off("stream-added",handleStreamAdded),e.client.off("stream-subscribed",handleStreamSubscribed),e.client.off("stream-removed",handleStreamRemoved)};this.client.on("peer-leave",handlePeerLeave),this.client.on("stream-added",handleStreamAdded),this.client.on("stream-subscribed",handleStreamSubscribed),this.client.on("stream-removed",handleStreamRemoved)},SpeakerScreenPlane.prototype.initAgora=function(e,t){var i=this;null!==this.client&&this.client.leave(),this.client=AgoraRTC.createClient({mode:"live",codec:"h264"});var n={appID:"a9ae41017a9b46789e033fe65d79bdc7",channel:e||"Ambience",token:t,uid:null};this.initAgoraEvent(),this.client.init(n.appID,(function(){i.client.join(n.token?n.token:null,n.channel,n.uid?+n.uid:null,(function(e){console.log("join channel: "+n.channel+" success, uid: "+e)}))}))},SpeakerScreenPlane.prototype.leave=function(){null!==this.client&&this.client.leave(),null!==this.uidt&&(this.uid=null)};var ShareScreenPlane=pc.createScript("shareScreenPlane");ShareScreenPlane.attributes.add("pixelsPerUnit",{type:"number",default:640,description:"Number of canvas pixels per unit of world space. The larger the number, the higher the resolution of the iframe."});const isFirefox=()=>navigator.userAgent.toLowerCase().indexOf("firefox")>-1,isCompatibleChrome=()=>-1!=navigator.userAgent.indexOf("Chrome");ShareScreenPlane.prototype.initialize=function(){this.player=this.app.root.findByName("Player"),this.networkScript=this.app.root.findByName("Root").script.network,this.div=document.createElement("div"),this.div.id="screen_stream",this.div.style="width:100%;height:100%;position: relative;",this.client=null,this.screenStream=null,this.initWebPage()},ShareScreenPlane.prototype.initWebPage=function(){var e=document.createElement("div");e.appendChild(this.div),this._css3Plane=new pc.Css3Plane(e,this.entity,this.pixelsPerUnit);var t=new pc.StandardMaterial;t.depthWrite=!0,t.redWrite=!1,t.greenWrite=!1,t.blueWrite=!1,t.alphaWrite=!1,t.blendType=pc.BLEND_NONE,t.opacity=0,t.update(),this.entity.render.material=t},ShareScreenPlane.prototype.initAgoraEvent=function(){const e=this;var handlePeerLeave=function(t){var i=t.stream,n=t.uid;n===e.uid&&(i.isPlaying()&&i.stop(),console.log("peer-leave: ",n),e.client.off("peer-leave",handlePeerLeave),e.client.off("stream-added",handleStreamAdded),e.client.off("stream-subscribed",handleStreamSubscribed),e.client.off("stream-removed",handleStreamRemoved))},handleStreamAdded=function(t){var i=t.stream,n=i.getId();n===e.uid&&(console.log("subscribe stream: "+n),e.client.subscribe(i))},handleStreamSubscribed=function(e){console.log("subscribed");var t=e.stream,i=t.getId();t.play("screen_stream"),console.log("stream-subscribed remote-uid: ",i)},handleStreamRemoved=function(t){var i=t.stream,n=i.getId();i.isPlaying()&&i.stop(),console.log("stream-removed remote-uid: ",n),e.client.off("peer-leave",handlePeerLeave),e.client.off("stream-added",handleStreamAdded),e.client.off("stream-subscribed",handleStreamSubscribed),e.client.off("stream-removed",handleStreamRemoved)};this.client.on("peer-leave",handlePeerLeave),this.client.on("stream-added",handleStreamAdded),this.client.on("stream-subscribed",handleStreamSubscribed),this.client.on("stream-removed",handleStreamRemoved)},ShareScreenPlane.prototype.initAgora=function(e,t,i){var n=this;null!==this.screenStream&&this.screenStream.stop(),null!==this.client&&this.client.leave(),this.client=AgoraRTC.createClient({mode:"live",codec:"h264"});var r={appID:"a9ae41017a9b46789e033fe65d79bdc7",channel:e||"CocaCola",token:t,uid:null};i&&this.initAgoraEvent(),this.client.init(r.appID,(function(){n.client.join(r.token?r.token:null,r.channel,r.uid?+r.uid:null,(function(e){if(!i){const t={streamID:e,audio:!1,video:!1,screen:!0};navigator.userAgent.toLowerCase().indexOf("firefox")>-1?t.mediaSource="window":-1==navigator.userAgent.indexOf("Chrome")&&(t.extensionId="minllpmhdgpndnkomcoccfekfegnlikg"),n.screenStream=AgoraRTC.createStream(t),n.screenStream.init((function(){n.networkScript.socket.emit("setShareScreenUID",{id:n.networkScript.id,shareScreenUID:e}),n.screenStream.play("screen_stream"),n.screenStream.on("stopScreenSharing",(e=>{n.screenStream.isPlaying()&&(n.screenStream.stop(),n.app.fire("podium:leave"),n.networkScript.socket.emit("closeAllPlayersSpeakerScreen",{id:n.networkScript.id}))})),n.client.publish(n.screenStream)}),(function(e){console.log(e),n.app.fire("podium:leave"),n.networkScript.socket.emit("closeAllPlayersSpeakerScreen",{id:n.networkScript.id})}))}}),(function(e){console.log(e)}))}))},ShareScreenPlane.prototype.leave=function(){null!==this.screenStream&&this.screenStream.stop(),null!==this.client&&this.client.leave(),this.uid&&(this.uid=null)};var InitStyle=pc.createScript("initStyle");InitStyle.attributes.add("css",{type:"asset",assetType:"css",title:"CSS Asset"}),InitStyle.prototype.initialize=function(){var t=document.createElement("style");document.head.appendChild(t),t.innerHTML=this.css.resource||""};var InitialUI=pc.createScript("initialUI");InitialUI.prototype.initialize=function(){this.app;const i=this.app.root.findByName("Desktop UI"),t=this.app.root.findByName("Mobile UI");(pc.platform.mobile||pc.platform.touch)&&(i.enabled=!1,t.enabled=!0)};var Initial=pc.createScript("initial");Initial.prototype.initialize=function(){const i=this.app;this.orientationUI=i.root.findByName("Orientation UI"),(pc.platform.mobile||pc.platform.touch)&&(this.calculateDimensions(),window.addEventListener("orientationchange",this.calculateDimensions.bind(this),!1),window.addEventListener("resize",this.calculateDimensions.bind(this),!1))},Initial.prototype.calculateDimensions=function(){window.innerWidth,window.innerHeight},Initial.prototype.onChangeScene=function(i){},Initial.prototype.converToDegrees=function(i){var t=new pc.Vec3;return i.transformVector(pc.Vec3.FORWARD,t),Math.atan2(-t.x,-t.z)*pc.math.RAD_TO_DEG};var WebCamPlane=pc.createScript("webCamPlane");WebCamPlane.attributes.add("css",{type:"asset",assetType:"css",title:"CSS Asset"}),WebCamPlane.prototype.initialize=function(){var e=document.createElement("style");const t=this.app;this.hasVideo=!0,this.hasAudio=!0,document.head.appendChild(e),e.innerHTML=this.css.resource||"",this.div=document.createElement("div"),this.div.id="streamWrap";var i=document.createElement("div");i.id="local_stream",this.div.appendChild(i),this.client=null,this.localStream=null,this.networkScript=t.root.findByName("Root").script.network,this.pixelsPerUnit=window.innerWidth,this.initWebPage(),t.on("webCam:disableVideo",this.disableVideo,this),t.on("webCam:enableVideo",this.enableVideo,this),t.on("webCam:muteAudio",this.muteAudio,this),t.on("webCam:unmuteAudio",this.unmuteAudio,this),t.on("webCam:leave",this.leave,this)},WebCamPlane.prototype.disableVideo=function(){this.localStream&&(this.localStream.muteVideo(),this.hasVideo=!1)},WebCamPlane.prototype.enableVideo=function(){this.localStream&&(this.localStream.enableVideo(),this.hasVideo=!0)},WebCamPlane.prototype.unmuteAudio=function(){this.localStream&&(this.localStream.unmuteAudio(),this.hasAudio=!0)},WebCamPlane.prototype.muteAudio=function(){this.localStream&&(this.localStream.muteAudio(),this.hasAudio=!1)},WebCamPlane.prototype.initWebPage=function(){var e=document.createElement("div");e.appendChild(this.div),this._css3Plane=new pc.Css3Plane(e,this.entity,this.pixelsPerUnit);var t=new pc.StandardMaterial;t.depthWrite=!0,t.redWrite=!1,t.greenWrite=!1,t.blueWrite=!1,t.alphaWrite=!1,t.blendType=pc.BLEND_NONE,t.opacity=0,t.update(),this.entity.render.material=t},WebCamPlane.prototype.initAgora=function(e,t){var i=this;null!==this.localStream&&this.localStream.stop(),null!==this.client&&this.client.leave(),this.client=AgoraRTC.createClient({mode:"live",codec:"h264"});var a={appID:"a9ae41017a9b46789e033fe65d79bdc7",channel:e||"public",token:t,uid:null};this.client.init(a.appID,(function(){i.client.join(a.token?a.token:null,a.channel,a.uid?+a.uid:null,(function(e){console.log("join channel: "+a.channel+" success, uid: "+e),navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then((function(t){var a=t.getVideoTracks()[0],o=t.getAudioTracks()[0];i.localStream=AgoraRTC.createStream({streamID:e,video:!0,audio:!0,videoSource:a,audioSource:o}),i.localStream.init((function(){console.log("init local stream success"),networkScript=i.app.root.findByName("Root").script.network,networkScript.socket.emit("setWebCamUID",{id:networkScript.id,webCamUID:e}),i.localStream.play("local_stream"),i.client.publish(i.localStream),i.hasVideo||i.disableVideo(),i.hasAudio||i.muteAudio()}))}))}))}))},WebCamPlane.prototype.leave=function(){this.localStream&&this.localStream.stop(),this.client&&this.client.leave()};var LoginUi=pc.createScript("loginui");LoginUi.attributes.add("css",{type:"asset",assetType:"css",title:"CSS Asset"}),LoginUi.attributes.add("html",{type:"asset",assetType:"html",title:"HTML Asset"}),LoginUi.attributes.add("images",{type:"asset",assetType:"texture",array:!0,title:"Texture Images"}),LoginUi.prototype.initialize=function(){var e=document.createElement("style");document.head.appendChild(e),e.innerHTML=this.css.resource||"",this.div=document.createElement("div"),this.div.classList.add("loginUI"),this.div.innerHTML=this.html.resource||"",document.body.appendChild(this.div),this.loginWrap=this.div.querySelector("#loginWrap"),this.textureWrap=this.div.querySelector("#textureSelectionWrap"),this.uploadImageBlock=this.textureWrap.querySelectorAll("li")[3],this.isUploading=!1,this.player=this.app.root.findByName("Player"),this.playerScript=this.player.script,this.networkScript=this.app.root.findByName("Root").script.network,this.loginclicked=!1,this.textureclicked=!1,this.initImages(),this.bindLoginEvent(),this.bindTextureSelectionEvent(),this.bindUploadImageEvent()},LoginUi.prototype.initImages=function(){this.textureItemImg=this.textureWrap.querySelectorAll("img"),this.textureItemImg.forEach(((e,t)=>{e.setAttribute("src",this.app.assets.find(this.images[t].name).getFileUrl())}))},LoginUi.prototype.bindLoginEvent=function(){var e=this,t=e.div,i=t.querySelector("#loginWrap form"),r=t.querySelector("#loginWrap email"),n=t.querySelector("#loginWrap pw"),o=t.querySelector("#loginWrap #submit");i.addEventListener("submit",(function(t){t.preventDefault(),e.loginclicked||(e.loginclicked=!0,e.networkScript.socket.emit("login",{email:r,pw:n}),o.innerText="Logging in...",console.log("Logging in..."))}))},LoginUi.prototype.bindTextureSelectionEvent=function(){var e=this,t=e.div,i=t.querySelector("#textureSelectionWrap form"),r=t.querySelectorAll("#textureSelectionWrap li"),n=t.querySelector("#textureSelectionWrap #textureIdx"),o=t.querySelector("#textureSelectionWrap #name"),s=t.querySelector("#textureSelectionWrap #submit"),a=t.querySelector("#textureSelectionWrap #submit p");r.forEach((function(t){t.addEventListener("click",(function(t){if(!e.isUploading){var i=this.getAttribute("data-idx");n.value=i,r.forEach((function(e){e.classList.remove("active")})),i<3?s.removeAttribute("disabled"):s.disabled=!0,this.classList.add("active")}}),!1)})),i.addEventListener("submit",(function(t){t.preventDefault(),e.textureclicked||(e.textureclicked=!0,e.networkScript.socket.emit("initData",{id:e.networkScript.id,name:o.value?o.value:"unnamed",textureIdx:n.value?n.value:0}),a.innerText="Creating Character...")}))},LoginUi.prototype.bindUploadImageEvent=function(){var e=this,t=this.div,i=t.querySelector("#textureSelectionWrap #image"),r=t.querySelector("#textureSelectionWrap #progressBar span"),n=new SocketIOFileUpload(this.networkScript.socket),o=t.querySelector("#textureSelectionWrap #submit"),s=t.querySelector("#textureSelectionWrap #submit p");n.listenOnInput(i),n.addEventListener("start",(t=>{console.log("start upload"),i.disabled=!0,e.isUploading=!0}),!1),n.addEventListener("progress",(e=>{var t=e.bytesLoaded/e.file.size;r.style.transform=`translate3d(0,0,0) scaleX(${t})`,s.innerText=`Uploading...(${Math.round(100*t)}%)`}),!1),n.addEventListener("complete",(t=>{t.success?(console.log("upload completed"),e.isUploading=!1,i.removeAttribute("disabled"),s.innerText="Confirm",o.removeAttribute("disabled")):console.log("error")}),!1)};var ChatUi=pc.createScript("chatui");ChatUi.attributes.add("css",{type:"asset",assetType:"css",title:"CSS Asset"}),ChatUi.attributes.add("html",{type:"asset",assetType:"html",title:"HTML Asset"}),ChatUi.prototype.initialize=function(){var t=this.app,e=document.createElement("style");this.isInsideWater=!1,t.on("chat:insideWater",(function(){this.isInsideWater=!0}),this),t.on("chat:outsideWater",(function(){this.isInsideWater=!1}),this),document.head.appendChild(e),e.innerHTML=this.css.resource||"",this.div=document.createElement("div"),this.div.classList.add("chatUI"),this.div.innerHTML=this.html.resource||"",document.body.appendChild(this.div),this.player=this.app.root.findByName("Player"),this.playerScript=this.player.script,this.networkScript=this.app.root.findByName("Root").script.network,this.bindChatEvent()},ChatUi.prototype.bindChatEvent=function(){var t=this,e=this.div.querySelector("#chatWrap form"),i=this.div.querySelector("#chatWrap #input");i.addEventListener("fouse",(function(){t.playerScript.enabled=!1}),!1),i.addEventListener("blur",(function(){t.playerScript.enabled=!0}),!1),e.addEventListener("submit",(function(e){e.preventDefault(),i.blur(),t.isInsideWater?(t.player.findByName("ChatBox").children[0].element.text="bulubulu",t.networkScript.socket.emit("chatUpdate",{id:t.networkScript.id,chat:"bulubulu"})):(t.player.findByName("ChatBox").children[0].element.text=i.value,t.networkScript.socket.emit("chatUpdate",{id:t.networkScript.id,chat:i.value})),i.value="",setTimeout((()=>{t.clearChat()}),3e3)}),!1)},ChatUi.prototype.clearChat=function(){this.player.findByName("ChatBox").children[0].element.text=""};var WebCamRemotePlane=pc.createScript("webCamRemotePlane");WebCamRemotePlane.attributes.add("css",{type:"asset",assetType:"css",title:"CSS Asset"}),WebCamRemotePlane.prototype.initialize=function(){var e=document.createElement("style");document.head.appendChild(e),e.innerHTML=this.css.resource||"",this.div=document.createElement("div"),this.div.id="streamWrap";var t=document.createElement("div");t.id="remote_stream",this.div.appendChild(t),this.added=!1,this.client=null,this.networkScript=this.app.root.findByName("Root").script.network,this.pixelsPerUnit=window.innerWidth,this.initWebPage()},WebCamRemotePlane.prototype.setVolume=function(e){this.remoteStream&&this.remoteStream.isPlaying()&&this.remoteStream.setAudioVolume(e)},WebCamRemotePlane.prototype.initWebPage=function(){var e=document.createElement("div");e.appendChild(this.div),this._css3Plane=new pc.Css3Plane(e,this.entity,this.pixelsPerUnit);var t=new pc.StandardMaterial;t.depthWrite=!0,t.redWrite=!1,t.greenWrite=!1,t.blueWrite=!1,t.alphaWrite=!1,t.blendType=pc.BLEND_NONE,t.opacity=0,t.update(),this.entity.model.material=t},WebCamRemotePlane.prototype.initAgora=function(e,t){var i=this;null!==this.client&&void 0!==this.client&&this.client.leave(),this.client=AgoraRTC.createClient({mode:"live",codec:"h264"});var a={appID:"a9ae41017a9b46789e033fe65d79bdc7",channel:e||"Entrance",token:t,uid:null};function handlePeerLeave(e){var t=e.stream,a=e.uid;a===i.uid&&(t.isPlaying()&&t.stop(),i.removeView(a),console.log("peer-leave: ",a),i.client.off("peer-leave",handlePeerLeave),i.client.off("stream-added",handleStreamAdded),i.client.off("stream-subscribed",handleStreamSubscribed),i.client.off("stream-removed",handleStreamRemoved))}function handleStreamAdded(e){var t=e.stream,a=t.getId();a!==i.uid||i.added||(i.added=!0,console.log("add"),i.div.querySelector("#remote_stream").id="remote_stream_"+a,i.client.subscribe(t),console.log("stream-added remote-uid: ",a))}function handleStreamSubscribed(e){console.log("subscribed");var t=e.stream,a=t.getId();i.remoteStream=t,t.play("remote_stream_"+a),console.log("stream-subscribed remote-uid: ",a)}function handleStreamRemoved(e){var t=e.stream,a=t.getId();a===i.uid&&(t.isPlaying()&&t.stop(),i.removeView(a),console.log("stream-removed remote-uid: ",a),i.client.off("peer-leave",handlePeerLeave),i.client.off("stream-added",handleStreamAdded),i.client.off("stream-subscribed",handleStreamSubscribed),i.client.off("stream-removed",handleStreamRemoved))}this.removeView=function(e){i.div&&i.div.parentNode.remove()},this.removeEvent=function(){i.client.off("stream-added",handleStreamAdded),i.client.off("stream-subscribed",handleStreamSubscribed),i.client.off("stream-removed",handleStreamRemoved)},this.client.on("peer-leave",handlePeerLeave),this.client.on("stream-added",handleStreamAdded),this.client.on("stream-subscribed",handleStreamSubscribed),this.client.on("stream-removed",handleStreamRemoved),this.client.init(a.appID,(function(){i.client.join(a.token?a.token:null,a.channel,a.uid?+a.uid:null,(function(e){console.log("join channel: "+a.channel+" success, uid: "+e)}))}))},WebCamRemotePlane.prototype.leave=function(){this.client&&this.client.leave(),this.removeView&&this.removeView(this.uid),this.uid&&(this.uid=null)};var Instruction=pc.createScript("instruction");Instruction.prototype.initialize=function(){const e=this.app,i=pc.platform.mobile||pc.platform.touch?this.app.root.findByName("Mobile UI"):this.app.root.findByName("Desktop UI");this.inGameUI=i.findByName("In-game UI"),e.fire("playerCamera:disable"),e.fire("playerControl:disable"),e.on("instruction:open",(function(){e.fire("playerCamera:disable"),e.fire("playerControl:disable"),this.entity.enabled=!0}),this),e.on("instruction:close",(function(){e.fire("playerCamera:enable"),e.fire("playerControl:enable"),e.fire("playerCamera:set","wheelY",2.5),e.fire("minimapController:show"),this.entity.enabled=!1,this.inGameUI.enabled=!0}),this)};var Slider=pc.createScript("slider");Slider.attributes.add("slides",{type:"entity"}),Slider.attributes.add("nextBtn",{type:"entity"}),Slider.attributes.add("rmBtn",{type:"entity"}),Slider.attributes.add("prevBtn",{type:"entity"}),Slider.attributes.add("eventBtn",{type:"entity"}),Slider.attributes.add("finishBtn",{type:"entity"}),Slider.prototype.initialize=function(){const t=this.app;this.idx=0,this.lth=this.slides.children.length,this.child=this.slides.children,this.nextBtn&&this.nextBtn.element.on("click",this.onNext,this),this.rmBtn&&this.rmBtn.element.on("click",this.onNext,this),this.prevBtn&&this.prevBtn.element.on("click",this.onPrev,this),this.eventBtn&&this.eventBtn.element.on("click",this.onEvent,this),this.finishBtn&&this.finishBtn.element.on("click",this.onFin,this),t.on("slider:reset",(function(){this.idx=0;for(let t=0;t<this.lth;t++){const i=this.child[t];i.enabled=0===t}}),this)},Slider.prototype.onNext=function(){this.child[this.idx++].enabled=!1,this.child[this.idx].enabled=!0},Slider.prototype.onPrev=function(){this.child[this.idx--].enabled=!1,this.child[this.idx].enabled=!0},Slider.prototype.onEvent=function(){const t=this.app;t.fire("instruction:close"),t.fire("slider:reset"),this.entity.enabled=!1,t.root.findByName("Event Teleport")&&t.fire("player:teleport",t.root.findByName("Event Teleport").getPosition())},Slider.prototype.onFin=function(){const t=this.app;t.fire("instruction:close"),t.fire("slider:reset"),this.entity.enabled=!1};var Input=pc.createScript("input");Input.attributes.add("placeholder",{type:"string"}),Input.attributes.add("linked",{type:"entity"}),Input.attributes.add("submitBtn",{type:"entity"});const MAX_CHARS=15;Input.prototype.initialize=function(){this.text=this.entity.findByName("Text"),this.textScript=null,this.linkedScript=null,this.text.script&&(this.textScript=this.text.script.updateTextElements||null),this.linked&&this.linked.script&&(this.linkedScript=this.linked.script.updateTextElements||null),this.border=this.entity.findByName("Border"),this.input=document.createElement("input"),this.input.id=this.entity.name.toLowerCase(),this.input.setAttribute("type","text"),this.input.setAttribute("value",this.placeholder),this.input.setAttribute("autocomplete","off"),this.input.style.opacity=0,this.input.style.position="absolute",this.input.style.left="-999px",this.text.element.text=this.placeholder,this.textScript&&this.textScript.onChangeText(this.placeholder),this.linked&&(this.linked.element.text=this.placeholder,this.linkedScript&&this.linkedScript.onChangeText(this.placeholder)),this.active=!1,this.submit=this.submitBtn?this.submitBtn.script.submit:null,document.body.appendChild(this.input),this.fixInputEvent(),this.initInputEvent()},Input.prototype.update=function(t){this.app.keyboard.wasPressed(pc.KEY_ENTER)&&this.active&&this.submit&&(this.triggerSubmitBtn(),this.input.blur())},Input.prototype.fixInputEvent=function(t){this.entity.element.on("click",(function(t){t.event.stopPropagation()}),this),pc.platform.mobile||pc.platform.touch?(this.app.touch.on(pc.EVENT_TOUCHEND,(function(t){t.event.preventDefault(),this.input.blur()}),this),this.entity.element.on("touchend",(function(t){t.event.stopPropagation(),this.input.focus()}),this)):(this.app.mouse.on(pc.EVENT_MOUSEDOWN,(function(t){t.event.preventDefault(),this.input.blur()}),this),this.entity.element.on("mousedown",(function(t){t.event.stopPropagation(),setTimeout((()=>this.input.focus()),0)}),this))},Input.prototype.initInputEvent=function(t){const e=this;this.input.addEventListener("input",(function(t){window.value=this.value,this.value.length>15&&(this.value=this.value.substr(0,15)),e.text.element.text=this.value,e.textScript&&e.textScript.onChangeText(this.value),e.linked&&(e.linked.element.text=this.value),e.linkedScript&&e.linkedScript.onChangeText(this.value)}),!1),this.input.addEventListener("focus",(function(t){""!==this.value&&this.value!==e.placeholder||(this.value="",e.text.element.text="",e.textScript&&e.textScript.onChangeText(""),e.linked&&(e.linked.element.text=""),e.linkedScript&&e.linkedScript.onChangeText("")),e.active=!0,e.app.fire("playerControl:disable"),e.app.fire("player:disableFire")}),!1),this.input.addEventListener("blur",(function(t){console.log("blur"),""!==this.value&&this.value!==e.placeholder||e.reset(),e.active=!1,e.entity.tags.has("login")||(e.app.fire("playerControl:enable"),e.app.fire("player:enableFire"))}),!1)},Input.prototype.triggerSubmitBtn=function(){this.submit.submit()},Input.prototype.reset=function(){this.input&&(this.input.value=""),this.text&&(this.text.element.text=this.placeholder),this.textScript&&this.textScript.onChangeText(this.placeholder),this.linked&&(this.linked.element.text=this.placeholder),this.linkedScript&&this.linkedScript.onChangeText(this.placeholder)},Input.prototype.clean=function(){this.input&&(this.input.value=""),this.text&&(this.text.element.text=""),this.textScript&&this.textScript.onChangeText(""),this.linked&&(this.linked.element.text=""),this.linkedScript&&this.linkedScript.onChangeText("")};var Uiposition=pc.createScript("uiposition");Uiposition.prototype.initialize=function(){this.wrap=this.entity.findByName("Wrap"),(pc.platform.mobile||pc.platform.touch)&&(this.wrap.setLocalPosition(new pc.Vec3(0,0,0)),this.wrap.setLocalEulerAngles(new pc.Vec3(0,0,0)))};var File=pc.createScript("file");File.prototype.initialize=function(){const t=this.app;this.socket=t.root.findByName("Root").script.network.socket,this.confirmButton=t.root.findByName("Confirm Button"),this.confirmButtonText=this.confirmButton.findByName("Text"),this.progressBar=t.root.findByName("Progress Bar"),this.progress=this.progressBar.findByName("Progress"),this.input=document.createElement("input"),this.input.id=this.entity.name.toLowerCase(),this.input.setAttribute("type","file"),this.input.setAttribute("accept","image/*"),this.input.style.opacity=0,this.input.style.position="absolute",this.input.style.left="-999px",document.body.appendChild(this.input),this.initEvent(),this.initInputEvent()},File.prototype.initEvent=function(){const t=this,e=new SocketIOFileUpload(this.socket);e.listenOnInput(this.input),e.addEventListener("start",(e=>{console.log("start upload"),t.entity.element.useInput=!1,gsap.to(t.confirmButton.element,{duration:1,width:400,height:40,ease:"power4.out",onComplete:function(){t.progressBar.enabled=!0}}),t.confirmButton.element.useInput=!1}),!1),e.addEventListener("progress",(e=>{const n=e.bytesLoaded/e.file.size;gsap.to(t.progress.element,{duration:.6,width:400*n,ease:"power4.out"}),t.confirmButtonText.element.text=`Uploading...(${Math.round(100*n)}%)`}),!1),e.addEventListener("complete",(e=>{e.success?(console.log("upload completed"),t.confirmButtonText.element.text="Confirm",t.progressBar.enabled=!1,gsap.to(t.confirmButton.element,{duration:.6,width:200,height:50,overwrite:!0,ease:"power4.out"}),t.confirmButton.element.useInput=!0,t.entity.element.useInput=!0):console.log("error")}),!1)},File.prototype.initInputEvent=function(){const t=this;this.entity.element.on("click",(function(e){t.input.click()}))};var Select=pc.createScript("select");Select.prototype.initialize=function(){this.value=0,this.body=0,this.color=0,this.app.on("select:set",(function(t,e){console.log(t.toLowerCase(),e),this[t.toLowerCase()]=e}),this)};var Submit=pc.createScript("submit");Submit.attributes.add("inputFields",{type:"entity"}),Submit.attributes.add("selectFields",{type:"entity"}),Submit.attributes.add("defaultText",{type:"string"}),Submit.attributes.add("loadingText",{type:"string"}),Submit.attributes.add("failText",{type:"string"}),Submit.prototype.initialize=function(){const t=this.app;this.text=this.entity.findByName("Text"),this.select=this.selectFields?this.selectFields.script.select:null,this.clicked=!1,this.isInsideWater=!1,this.bubbles=t.root.findByName("Bubbles").particlesystem,this.initEvent(),t.on("submit:fail",(function(){const t=this.entity.children[0].element;t&&(t.text=this.failText),setTimeout((()=>{this.clicked=!1,t&&(t.text=this.defaultText)}),2e3)}),this),t.on("chat:insideWater",(function(){this.isInsideWater=!0}),this),t.on("chat:outsideWater",(function(){this.isInsideWater=!1}),this)},Submit.prototype.initEvent=function(){this.entity.element.on("click",(function(t){t.event.stopPropagation(),this.clicked||this.submit()}),this)},Submit.prototype.submit=function(t){const e=this.app,i=this.inputFields.children;switch(this.clicked=!0,t||this.entity.name){case"Login Button":const t=i[0].findByName("Text").element.text,s=i[1].findByName("Text").element.text;e.fire("socket:login",t,s),this.text.element.text=this.loadingText,console.log(this.loadingText);break;case"Confirm Button":let n=i[0].findByName("Text").element.text,o=e.root.findByName("Player");n===i[0].findByName("Name").script.input.placeholder&&(n="unnamed");const l=this.select.body;e.fire("socket:initData",n||"unnamed",l),e.fire("playerCamera:changeTarget",o,o),this.text.element.text=this.loadingText,console.log(this.loadingText);break;case"Send Button":let a=i[0].findByName("Text").element.text;const c=i[0].findByName("Message").script.input.placeholder;this.isInsideWater&&(a="bulu bulu...",this.bubbles.reset(),this.bubbles.play()),""!==a&&a!==c&&(e.fire("socket:sendMessage",a),console.log(this.defaultText)),this.clicked=!1;break;case"Enter Private Room Button":const r=+i[0].findByName("Text").element.text;e.fire("socket:sendPasscode",r),this.clicked=!1,this.text.element.text=this.loadingText,console.log(this.loadingText);break;case"Room Enter Button":let d=i[0].findByName("Text").element.text;e.fire("RoomMaker:setRoomName",d),this.clicked=!1}if("Confirm Button"!==(t||this.entity.name))for(var s in i)i[s].script.input&&i[s].script.input.reset()},Submit.prototype.fail=function(){this.text.element.text=this.failText,console.log(this.failText),setTimeout((()=>{this.reset()}),3e3)},Submit.prototype.reset=function(){const t=this.inputFields.children;for(let e=0,i=t.length;e<i;e++){t[e].script.input.reset()}this.clicked=!1,this.text.element.text=this.defaultText};var Joystick=pc.createScript("joystick");Joystick.attributes.add("joystickBG",{type:"entity"}),Joystick.prototype.initialize=function(){this.device=this.app.graphicsDevice,this.isDragging=!1,this.mousePos=(new pc.Vec3).copy(this.entity.getLocalPosition()),this.center=(new pc.Vec3).copy(this.entity.getLocalPosition()),this.screen=this.getUIScreenComponent(),this.joystickBGPos=(new pc.Vec3).copy(this.joystickBG.getLocalPosition()),this.joystickBGOriginalPos=(new pc.Vec3).copy(this.joystickBG.getLocalPosition()),this.maxDistance=120,this.screenPos=new pc.Vec3,this.touchId=-1,this.devicePixelRatio=window.devicePixelRatio,this.initEvent()},Joystick.prototype.getUIScreenComponent=function(){return this.entity.element.screen.screen},Joystick.prototype.initEvent=function(){var t=this.app;this.onResize(),t.touch.on(pc.EVENT_TOUCHSTART,this.onTouchStart,this),window.addEventListener("resize",this.onResize.bind(this),!1)},Joystick.prototype.onResize=function(){this.device=this.app.graphicsDevice,this.screenWidth=this.device.width/this.devicePixelRatio,this.screenHeight=this.device.height/this.devicePixelRatio},Joystick.prototype.onTouchStart=function(t){t.event.stopPropagation(),t.event.preventDefault();for(var i=t.changedTouches,e=0,s=i.length;e<s;e+=1){var o=i[e];if(o.id===this.touchId||-1===this.touchId){var c=this.app;this.mousePos.x=o.x,this.mousePos.y=o.y,this.screenPos=this.getScreenPos(this.mousePos),this.mousePos.x<this.screenWidth/2&&this.mousePos.y>this.screenHeight/2&&(this.isDragging=!0,this.touchId=o.id,this.center.copy(this.screenPos),c.touch.on(pc.EVENT_TOUCHMOVE,this.onTouchMove,this),c.touch.on(pc.EVENT_TOUCHEND,this.onTouchEnd,this))}}},Joystick.prototype.onTouchMove=function(t){t.event.stopPropagation();for(var i=0;i<t.changedTouches.length;i++){var e=t.changedTouches[i];e.id===this.touchId&&(this.mousePos.x=e.x,this.mousePos.y=e.y)}},Joystick.prototype.onTouchEnd=function(t){t.event.stopPropagation();for(var i=0;i<t.changedTouches.length;i++){if(t.changedTouches[i].id===this.touchId){var e=this.app;this.touchId=-1,this.isDragging=!1,this.reset(),e.touch.off(pc.EVENT_TOUCHMOVE,this.onTouchMove,this),e.touch.off(pc.EVENT_TOUCHEND,this.onTouchEnd,this)}}},Joystick.prototype.getDistance=function(t,i){return t.distance(i)},Joystick.prototype.getDirection=function(t,i){var e=t.x-i.x,s=t.y-i.y,o=t.z-i.z;return new pc.Vec3(e,s,o).normalize()},Joystick.prototype.moveHandle=function(t,i,e){this.getDistance(t,i);this.joystickBG.setLocalPosition(this.joystickBGPos)},Joystick.prototype.getScreenPos=function(t){var i=1/this.screen.scale,e=this.entity.element.anchor.x*this.screenWidth,s=(1-this.entity.element.anchor.y)*this.screenHeight,o=(t.x+e)*i*this.devicePixelRatio,c=(s+t.y)*i*this.devicePixelRatio;return new pc.Vec3(o,-c,0)},Joystick.prototype.updateHandle=function(){if(this.isDragging){this.screenPos=this.getScreenPos(this.mousePos),this.moveHandle(this.screenPos,this.center,this.maxDistance);var t=this.getDistance(this.screenPos,this.center),i=this.getDirection(this.screenPos,this.center);if(i.normalize(),t>this.maxDistance){this.maxDistance,this.center.clone();this.entity.setLocalPosition(i.scale(this.maxDistance))}else this.entity.setLocalPosition(i.scale(t))}},Joystick.prototype.update=function(t){this.updateHandle()},Joystick.prototype.reset=function(){this.screenPos.copy(this.joystickBGOriginalPos),this.center.copy(this.joystickBGOriginalPos),this.joystickBGPos.copy(this.joystickBGOriginalPos),this.joystickBG.setLocalPosition(this.joystickBGOriginalPos),this.entity.setLocalPosition(0,0,0)},Joystick.prototype.getTouchMovement=function(){return this.getDirection(this.screenPos,this.center)};var Water=pc.createScript("water");Water.attributes.add("shader",{type:"asset",assetType:"shader"}),Water.attributes.add("iChannel1",{type:"asset",assetType:"texture"}),Water.attributes.add("iChannel2",{type:"asset",assetType:"texture"}),Water.prototype.initialize=function(){this.timer=0,this.material=this.entity.render?this.entity.render.meshInstances[0].material:this.entity.model.meshInstances[0].material,this.material.chunks.diffuseTexPS=this.shader.resource,this.material.setParameter("iChannel1",this.iChannel1.resource),this.material.setParameter("iChannel2",this.iChannel2.resource),this.material.setParameter("iResolution",new pc.Vec3(this.app.graphicsDevice.width,this.app.graphicsDevice.height,0).data),window.onresize=function(e){this.material.setParameter("iResolution",new pc.Vec3(this.app.graphicsDevice.width,this.app.graphicsDevice.height,0).data)}.bind(this),this.material.update()},Water.prototype.update=function(e){this.timer+=e,this.material.setParameter("iTime",this.timer)};var OnOffButton=pc.createScript("onOffButton");OnOffButton.attributes.add("enableString",{type:"string"}),OnOffButton.attributes.add("disableString",{type:"string"}),OnOffButton.attributes.add("enableImage",{type:"asset",assetType:"sprite"}),OnOffButton.attributes.add("disableImage",{type:"asset",assetType:"sprite"}),OnOffButton.attributes.add("cameraEntity",{type:"entity"}),OnOffButton.prototype.initialize=function(){const t=this.app;this.enabled=!0,this.entity.element.on("click",(function(e){e.event.stopPropagation(),this.enabled?(this.enabled=!1,t.fire(this.disableString),this.cameraEntity&&(this.cameraEntity.enabled=!1),this.entity.element.sprite=this.enableImage.resource):(this.enabled=!0,t.fire(this.enableString),this.cameraEntity&&(this.cameraEntity.enabled=!0),this.entity.element.sprite=this.disableImage.resource)}),this)},OnOffButton.prototype.update=function(t){};var ScrollController=pc.createScript("scrollController");ScrollController.prototype.initialize=function(){const e=this.app;this.content=e.getEntityFromIndex(this.entity.scrollview.contentEntity),this.content.element.on("mousewheel",(function(e){var t=this.entity.scrollview.scroll;this.entity.scrollview._onSetScroll(t.x,t.y+.1*e.wheelDelta,!1)}),this),this.content.element.on("mouseenter",(function(){e.fire("playerCamera:disable")}),this),this.content.element.on("mouseleave",(function(){e.fire("playerCamera:enable")}),this),this.content.element.on("touchstart",(function(){e.fire("playerCamera:disable")}),this),this.content.element.on("touchend",(function(){e.fire("playerCamera:enable")}),this)},ScrollController.prototype.update=function(e){};var UiSpriteAnim=pc.createScript("uiSpriteAnim");UiSpriteAnim.attributes.add("fps",{type:"number",default:15}),UiSpriteAnim.attributes.add("delay",{type:"number",default:0}),UiSpriteAnim.attributes.add("loop",{type:"boolean",default:!0}),UiSpriteAnim.prototype.initialize=function(){setTimeout((()=>{this._frameCount=this.entity.element.sprite.frameKeys.length,this._interval=1/this.fps,this.restart()}),0)},UiSpriteAnim.prototype.update=function(t){if(!this._isComplete&&(this._timer+=t,this._timer>1/this.fps)){var i=this.entity.element.spriteFrame+1;i>=this._frameCount&&(!0===this.loop?i=0:this._isComplete=!0),this.entity.element.spriteFrame=i,this._timer-=1/this.fps}},UiSpriteAnim.prototype.restart=function(){this.entity.element.spriteFrame=0,this._timer=-this.delay,this._isComplete=!1};var AmbienceSetup=pc.createScript("ambienceSetup");AmbienceSetup.prototype.initialize=function(){const e=this.app;this.webcamGroup=e.root.findByName("Webcam Group"),this.player=e.root.findByName("Player"),e.on("AmbienceSetup:addUser",(function(){this.addUser()}),this),e.on("AmbienceSetup:reset",(function(e,t,a){this.reset(e,t,a)}),this)},AmbienceSetup.prototype.update=function(e){if(this.webcamGroup){const e=this.app;this.others=e.root.findByName("Others Group").children;for(let e=0;e<this.webcamGroup.length;e++)0===e?(this.player.findByName("Face").setPosition(this.webcamGroup.children[e].getLocalPosition()),this.player.findByName("Face").setRotation(this.webcamGroup.children[e].getLocalRotation()),this.player.findByName("Face").setLocalScale(this.webcamGroup.children[e].getLocalScale())):this.others[e-1]&&(this.others[e-1].findByName("Face").setPosition(this.webcamGroup.children[e].getLocalPosition()),this.others[e-1].findByName("Face").setRotation(this.webcamGroup.children[e].getLocalRotation()),this.others[e-1].findByName("Face").setLocalScale(this.webcamGroup.children[e].getLocalScale()))}},AmbienceSetup.prototype.addUser=function(){let e=this.app.root.findByName("Others Group").children;for(let t=0;t<this.webcamGroup.length;t++)0===t?(this.player.findByName("Face").setPosition(this.webcamGroup[t].getLocalPosition()),this.player.findByName("Face").setRotation(this.webcamGroup[t].getLocalRotation()),this.player.findByName("Face").setLocalScale(this.webcamGroup[t].getLocalScale())):e[t-1]&&(e[t-1].findByName("Face").setPosition(this.webcamGroup[t].getLocalPosition()),e[t-1].findByName("Face").setRotation(this.webcamGroup[t].getLocalRotation()),e[t-1].findByName("Face").setLocalScale(this.webcamGroup[t].getLocalScale()))},AmbienceSetup.prototype.reset=function(e,t,a){let i=this.app.root.findByName("Others Group").children;for(let o=0;o<=i.length;o++)0===o?(this.player.findByName("Face").setLocalPosition(e),this.player.findByName("Face").setLocalRotation(t),this.player.findByName("Face").setLocalScale(a)):i[o-1]&&(i[o-1].findByName("Face").setLocalPosition(e),i[o-1].findByName("Face").setLocalRotation(t),i[o-1].findByName("Face").setLocalScale(a))};var RotateText=pc.createScript("rotateText");RotateText.attributes.add("speed",{type:"number",default:10}),RotateText.prototype.initialize=function(){this.quatY=new pc.Quat,this.rotY=0},RotateText.prototype.update=function(t){this.rotY+=this.speed*t,this.quatY.setFromAxisAngle(pc.Vec3.UP,this.rotY%360),this.entity.setRotation(this.quatY)};var Bubble=pc.createScript("bubble"),t=0,lifetime=2.5;Bubble.attributes.add("maxHeight",{type:"number",default:10}),Bubble.prototype.initialize=function(){this.speed=pc.math.random(.3,.5),this.t=0;const e=pc.math.random(.15,.21);this.entity.setLocalScale(e,e,e)},Bubble.prototype.update=function(e){this.t+=e;var i=this.entity,a=i.rigidbody.linearVelocity.x,l=i.rigidbody.linearVelocity.y+this.speed,o=i.rigidbody.linearVelocity.z;i.rigidbody.linearVelocity=new pc.Vec3(a,l,o),t>=lifetime&&i.destroy()};var ScrollingTexture=pc.createScript("scrollingTexture");ScrollingTexture.attributes.add("direction",{type:"string",default:"y"}),ScrollingTexture.attributes.add("velocity",{type:"number",default:-2}),ScrollingTexture.tmp=new pc.Vec2,ScrollingTexture.prototype.initialize=function(){this.timer=0,this.currentOffset=0,this.entity.morenderdel&&(this.entity.render.meshInstances?this.material=this.entity.render.meshInstances[0].material:this.material=this.entity.model.meshInstances[0].material)},ScrollingTexture.prototype.update=function(t){ScrollingTexture.tmp;this.timer+=2*t,this.currentOffset+=this.velocity*t,this.currentOffset>=1&&(this.currentOffset=0),this.material.diffuseMapOffset[this.direction]=this.currentOffset,this.material.normalMapOffset[this.direction]=this.currentOffset,this.material.update()};var WaterSpeaking=pc.createScript("waterSpeaking");WaterSpeaking.prototype.initialize=function(){this.app;this.entity.collision.on("triggerenter",this.onTriggerEnter,this),this.entity.collision.on("triggerleave",this.onTriggerLeave,this)},WaterSpeaking.prototype.onTriggerEnter=function(e){var t=this.app;t.root.findByName("Player").findByName("Body");"Player"===e.name&&t.fire("chat:insideWater")},WaterSpeaking.prototype.onTriggerLeave=function(e){var t=this.app;t.root.findByName("Player").findByName("Body");"Player"===e.name&&t.fire("chat:outsideWater")},WaterSpeaking.prototype.update=function(e){};var Shake=pc.createScript("shake");Shake.attributes.add("nameSpace",{type:"string"}),Shake.prototype.initialize=function(){const t=this;this.app.on(`${this.nameSpace}:shake`,(function(){gsap.effects.position(this,{x:function(){return gsap.utils.random(-.01,.01)},y:function(){return gsap.utils.random(-.01,.01)},duration:.01,repeatRefresh:!0,repeat:20,ease:"power4.out",onComplete:function(){gsap.effects.position(t,{x:0,y:0,duration:.01,ease:"power4.out"})}})}),this)},Shake.prototype.update=function(t){};var Elevator=pc.createScript("elevator");Elevator.attributes.add("minY",{type:"number"}),Elevator.attributes.add("maxY",{type:"number"}),Elevator.attributes.add("speed",{type:"number",default:1}),Elevator.prototype.initialize=function(t){this.app;this.move=-1,this.originalPos=this.entity.getPosition(),this.posY=.5,this.inLift=!1,this.disableMovement=!1,this.on("enable",this.onEnable,this),this.on("disable",this.onDisable,this),this.onEnable(),this.elevatorEntity=null},Elevator.prototype.onEnable=function(){this.entity.collision.on("triggerenter",this.onTriggerEnter,this),this.entity.collision.on("triggerleave",this.onTriggerLeave,this)},Elevator.prototype.onDisable=function(){this.entity.collision.off("triggerenter",this.onTriggerEnter,this),this.entity.collision.off("triggerleave",this.onTriggerLeave,this)},Elevator.prototype.onTriggerEnter=function(t){this.move=1,this.inLift=!0},Elevator.prototype.onTriggerLeave=function(t){this.move=0,this.inLift=!1},Elevator.prototype.update=function(t){1===this.move?this.posY<this.maxY?(this.posY=this.originalPos.y+t*this.speed,this.entity.parent.rigidbody.teleport(this.originalPos.x,this.posY,this.originalPos.z),this.app.fire("playerMovement:teleport",this.entity.getPosition()),this.disableMovement||(this.disableMovement=!0,this.app.fire("playerMovement:disable"))):this.disableMovement&&(this.disableMovement=!1,this.app.fire("playerMovement:enable")):0===this.move&&this.posY>this.minY&&(this.posY=this.originalPos.y-t*this.speed,this.entity.parent.rigidbody.teleport(this.originalPos.x,this.posY,this.originalPos.z),this.posY<=.1&&(this.move=-1))};var VideoTexture=pc.createScript("videoTexture");VideoTexture.attributes.add("video",{title:"Video",description:"MP4 video asset",type:"asset"}),VideoTexture.attributes.add("screenMaterial",{title:"Screen Material",description:"The screen material",type:"asset",assetType:"material"}),VideoTexture.prototype.initialize=function(){var e=this.app,t=document.createElement("video");t.loop=!0,t.muted=!0,t.playsInline=!0,t.crossOrigin="anonymous",this.videoDom=t;var i=t.style;i.width="1px",i.height="1px",i.position="absolute",i.opacity="0",i.zIndex="-1000",i.pointerEvents="none",document.body.appendChild(t),this.videoTexture=new pc.Texture(e.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8,minFilter:pc.FILTER_LINEAR_MIPMAP_LINEAR,magFilter:pc.FILTER_LINEAR,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE,mipmaps:!0}),this.videoTexture.setSource(t),t.addEventListener("canplaythrough",function(i){e.fire("tv:play",this.videoTexture,this.screenMaterial),t.play()}.bind(this)),t.src=this.video?this.video.getFileUrl():this.videoUrl,document.body.appendChild(t),t.load()},VideoTexture.prototype.control=function(e){this.videoDom.paused?(this.videoDom.play(),this.app.fire("video:playing",e)):(this.videoDom.pause(),this.app.fire("video:paused",e))},VideoTexture.prototype.update=function(e){this.videoTexture.upload()};var VideoTextureLink=pc.createScript("videoTextureLink");VideoTextureLink.attributes.add("video",{type:"string"}),VideoTextureLink.attributes.add("screenMaterial",{type:"string"}),VideoTextureLink.prototype.initialize=function(){var e=this.app,i=document.createElement("video");i.loop=!0,i.muted=!0,i.playsInline=!0,i.crossOrigin="anonymous",this.videoDom=i;var t=i.style;t.width="1px",t.height="1px",t.position="absolute",t.opacity="0",t.zIndex="-1000",t.pointerEvents="none",document.body.appendChild(i),this.videoTexture=new pc.Texture(e.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8,minFilter:pc.FILTER_LINEAR_MIPMAP_LINEAR,magFilter:pc.FILTER_LINEAR,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE,mipmaps:!0,flipY:!0}),this.videoTexture.setSource(i),i.addEventListener("canplaythrough",function(t){null!==this.screenMaterial?e.fire("tv:play",this.videoTexture,this.screenMaterial):this.entity.model.meshInstances[0].material&&e.fire("tv:play",this.videoTexture,this.entity.model.meshInstances[0].material),i.play()}.bind(this)),i.src=this.video,document.body.appendChild(i),i.load()},VideoTextureLink.prototype.control=function(e){this.videoDom.paused?(this.videoDom.play(),this.app.fire("video:playing",e)):(this.videoDom.pause(),this.app.fire("video:paused",e))},VideoTextureLink.prototype.update=function(e){this.videoTexture.upload()};var RenderLayerTotexture=pc.createScript("renderLayerTotexture");RenderLayerTotexture.attributes.add("layerNames",{type:"string",array:!0}),RenderLayerTotexture.prototype.initialize=function(){for(var e=0;e<this.layerNames.length;e++){var r=this.layerNames[e],t=new pc.Texture(this.app.graphicsDevice,{width:1024,height:1024,format:pc.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!0});t.minFilter=pc.FILTER_LINEAR,t.magFilter=pc.FILTER_LINEAR;var a=new pc.RenderTarget(this.app.graphicsDevice,t,{depth:!0,flipY:!0});this.app.scene.layers.getLayerByName(r).renderTarget=a}};var ApplyTexture=pc.createScript("applyTexture");ApplyTexture.attributes.add("layerName",{type:"string"}),ApplyTexture.prototype.postInitialize=function(){var e=this.app.scene.layers.getLayerByName(this.layerName);this.entity.element.texture=e.renderTarget.colorBuffer},ApplyTexture.prototype.update=function(e){};var MakeMapIcon=pc.createScript("makeMapIcon");MakeMapIcon.attributes.add("iconImage",{type:"asset",assetType:"sprite"}),MakeMapIcon.attributes.add("isTeleportPoint",{type:"boolean"}),MakeMapIcon.prototype.initialize=function(){this.app.fire("mapController:addIcon",this.entity,this.iconImage.resource,this.isTeleportPoint),this.on("destroy",(function(){this.app.fire("mapController:removeIcon",this.entity._guid)}),this)},MakeMapIcon.prototype.addIcon=function(){this.app.fire("mapController:addIcon",this.entity,this.iconImage.resource,this.isTeleportPoint)},MakeMapIcon.prototype.removeIcon=function(){this.app.fire("mapController:removeIcon",this.entity._guid)};var MapController=pc.createScript("mapController");MapController.attributes.add("player",{type:"entity"}),MapController.attributes.add("mapCamera",{type:"entity"}),MapController.attributes.add("cameraController",{type:"entity"}),MapController.attributes.add("maxDistance",{type:"number"}),MapController.attributes.add("isFullmap",{type:"boolean",default:!1}),MapController.prototype.initialize=function(){const t=this.app;this.playerControl=this.player.script.playerControl,this.cameraControl=this.cameraController.script.cameraControl,this.quatY=new pc.Quat;const e=pc.platform.mobile||pc.platform.touch?this.app.root.findByName("Mobile UI"):this.app.root.findByName("Desktop UI"),i=this.isFullmap?e.findByName("Fullmap"):e.findByName("Minimap");this.icons=[],this.icon=i.findByName("Temp Icon"),this.iconsGroup=i.findByName("Icons Group"),this.playerIcon=i.findByName("Player Icon"),this.wrapWidth=i.findByName("Group").element.width,this.wrapHeight=i.findByName("Group").element.height,this.center=new pc.Vec3(this.wrapWidth/2,this.wrapHeight/2,0),t.on("mapController:rotateCamera",(function(t){this.isFullmap||this.mapCamera.setEulerAngles(-90,t,0)}),this),t.on("mapController:addIcon",(function(e,i,o){const n=this.icon.clone();n.element.sprite=i,n.enabled=!0,this.iconsGroup.addChild(n),this.icons.push({entity:e}),o&&n.element.on("click",(function(i){i.event.stopPropagation(),t.fire("player:teleport",e.getPosition())}))}),this),t.on("mapController:removeIcon",(function(t){const e=this.iconsGroup.children,i=this.icons;for(let o=0,n=e.length;o<n;o++){if(t===this.icons[o].entity._guid){i.splice(o,1),e[o].destroy();break}}}),this)},MapController.prototype.update=function(t){this.updatePlayerIcon(),this.updateMapIcons()},MapController.prototype.updatePlayerIcon=function(){if(this.isFullmap){const t=new pc.Vec3;this.mapCamera.camera.worldToScreen(this.player.getPosition(),t),t.x=t.x/window.innerWidth*this.wrapWidth-this.wrapWidth/2,t.y=-1*t.y/window.innerHeight*this.wrapHeight+this.wrapHeight/2,t.z=0,this.playerIcon.setLocalPosition(t)}const t=this.playerControl.rotY,e=this.isFullmap?0:this.cameraControl.eulersEase.x;this.quatY.setFromAxisAngle(pc.Vec3.BACK,t-e-180),this.playerIcon.setLocalRotation(this.quatY)},MapController.prototype.updateMapIcons=function(){const t=this.iconsGroup.children;if(t.length||this.icons.length)for(let o=0,n=t.length;o<n;o++){const n=t[o];let a=this.icons[o].entity.getPosition();const r=new pc.Vec3;if(this.mapCamera.camera.worldToScreen(a,r),r.x=r.x/window.innerWidth*this.wrapWidth,r.y=-1*r.y/window.innerHeight*this.wrapHeight+this.wrapHeight,r.z=0,this.isFullmap)n.setLocalPosition(r);else{if(this.getDistance(r,this.center)>this.maxDistance){var e=this.getDirection(r,this.center),i=this.center.clone();n.setLocalPosition(e.scale(this.maxDistance).add(i))}else n.setLocalPosition(r)}}},MapController.prototype.getDistance=function(t,e){return t.distance(e)},MapController.prototype.getDirection=function(t,e){var i=t.x-e.x,o=t.y-e.y,n=t.z-e.z;return new pc.Vec3(i,o,n).normalize()};var SoundManager=pc.createScript("soundManager");SoundManager.attributes.add("fadeInDuration",{type:"number",default:2}),SoundManager.attributes.add("fadeOutDuration",{type:"number",default:2}),SoundManager.attributes.add("volumeFadeInCurve",{type:"curve",title:"Volume FadeIn Curve"}),SoundManager.attributes.add("volumeFadeOutCurve",{type:"curve",title:"Volume FadeOut Curve"}),SoundManager.prototype.initialize=function(){const t=this.app;this.currentRoom="Public",this.slots={},this.duration={},t.on("sound:set",(function(t,e){this[t]=e}),this),t.on("sound:play",(function(t){"BG Music"===t?this.slots[`${this.currentRoom}BGMusic`]=this.entity.sound.slot(`${this.currentRoom} BG Music`):this.slots[t]=this.entity.sound.slot(t);var e=this.slots[t].asset;this.duration[t]=this.app.assets.get(e).resource.duration,this.slots[t].timer=0,this.slots[t].state=0,this.slots[t].play()}),this),t.on("sound:pause",(function(t){this.slots[t].timer=0,this.slots[t].state=2}),this)},SoundManager.prototype.update=function(t){Object.entries(this.slots).forEach((([e,s],i)=>{for(var a=0;a<s.instances.length;++a){var u=s.instances[a];1===s.state?s.timer<this.fadeInDuration&&(s.timer+=t,u.volume=this.volumeFadeInCurve.value(s.timer/this.fadeInDuration)):2===s.state&&(s.timer+=t,s.timer<this.fadeOutDuration?u.volume=this.volumeFadeOutCurve.value(s.timer/this.fadeOutDuration):(s.pause(),delete this.slots[e]))}}))};var TargetTeleport=pc.createScript("targetTeleport");TargetTeleport.attributes.add("target",{type:"entity"}),TargetTeleport.prototype.initialize=function(){},TargetTeleport.prototype.update=function(t){};var DynamicLoading=pc.createScript("dynamicLoading");DynamicLoading.attributes.add("lowQualityEntity",{type:"entity"}),DynamicLoading.attributes.add("highQualityEntity",{type:"entity"}),DynamicLoading.prototype.initialize=function(){this.tagName=this.entity.name.substring(13),this.entity.collision.on("triggerenter",this.onTriggerEnter,this)},DynamicLoading.prototype.onTriggerEnter=function(){this.highQualityEntity.enabled||this.loadassets()},DynamicLoading.prototype.loadassets=function(){for(var t=this.app.assets.findByTag(this.tagName),i=t.length,n=0,onAssetReady=()=>{++n===i&&this.onAssetsLoaded()},a=0;a<i;a++)t[a].resource?onAssetReady():(t[a].ready(onAssetReady),this.app.assets.load(t[a]))},DynamicLoading.prototype.onAssetsLoaded=function(){this.lowQualityEntity.enabled=!1,this.highQualityEntity.enabled=!0,this.entity.enabled=!1};var SoundTrigger=pc.createScript("soundTrigger");SoundTrigger.attributes.add("soundName",{type:"string"}),SoundTrigger.prototype.initialize=function(){this.entity.collision.on("triggerenter",this.onTriggerEnter,this),this.entity.collision.on("triggerleave",this.onTriggerLeave,this)},SoundTrigger.prototype.onTriggerEnter=function(){this.entity.sound.play(this.soundName)},SoundTrigger.prototype.onTriggerLeave=function(){this.entity.sound.stop()},SoundTrigger.prototype.update=function(t){};var LinkTrigger=pc.createScript("linkTrigger");LinkTrigger.attributes.add("url",{type:"string"}),LinkTrigger.prototype.initialize=function(i){this.on("enable",this.onEnable,this),this.on("disable",this.onDisable,this),this.onEnable(),this.linkEntity=null},LinkTrigger.prototype.onEnable=function(){this.entity.collision.on("triggerenter",this.onTriggerEnter,this)},LinkTrigger.prototype.onDisable=function(){this.entity.collision.off("triggerenter",this.onTriggerEnter,this)},LinkTrigger.prototype.onTriggerEnter=function(i){this.url&&this.app.fire("popup:open",this.url)};var Fullmap=pc.createScript("fullmap");Fullmap.prototype.initialize=function(){const t=this.app,i=pc.platform.mobile||pc.platform.touch?this.app.root.findByName("Mobile UI"):this.app.root.findByName("Desktop UI");this.inGameUI=i.findByName("In-game UI"),t.on("fullmap:show",(function(){this.entity.enabled=!0,this.inGameUI.enabled=!1}),this),t.on("fullmap:hide",(function(){this.entity.enabled=!1,this.inGameUI.enabled=!0}),this)},Fullmap.prototype.update=function(t){};var PageController=pc.createScript("pageController");PageController.attributes.add("target",{type:"entity"}),PageController.attributes.add("isOpen",{type:"boolean"}),PageController.attributes.add("additionAction",{type:"string",array:!0}),PageController.prototype.initialize=function(){const t=this.app;this.entity.element.on("click",(function(){if(this.target.enabled=this.isOpen,this.additionAction.length)for(var e=0;e<this.additionAction.length;e++)t.fire(this.additionAction[e])}),this)},PageController.prototype.update=function(t){};var Minimap=pc.createScript("minimap");Minimap.prototype.initialize=function(){const i=this.app;i.on("minimap:show",(function(){this.entity.enabled=!0}),this),i.on("minimap:hide",(function(){this.entity.enabled=!1}),this)},Minimap.prototype.update=function(i){};var world2reflMirror,Mirror=pc.createScript("mirror");Mirror.attributes.add("primitive",{type:"boolean"}),Mirror.attributes.add("density",{type:"number"}),Mirror.attributes.add("onlyTag",{type:"string"}),Mirror.attributes.add("shaderPS",{type:"asset",assetType:"shader"});var planePosWM,planeNormalWM,planeAV,planeBV,planeCV,planeDV,tmpView=new pc.Mat4,tmpView2=new pc.Mat4,tmpView3=new pc.Mat4,planeQ=new pc.Vec4,planeV=new pc.Vec4,planePosV=new pc.Vec3,planeNormalV=new pc.Vec3,projInv=new pc.Mat4,pointsV=[new pc.Vec4,new pc.Vec4,new pc.Vec4,new pc.Vec4],prevGlobalMatrix=new pc.Mat4,tmpQuat=new pc.Quat,mirrorLookAt=new pc.Vec3,localPlayerPos=new pc.Vec3,afterTransitionPos=new pc.Vec3,reflectedCamPos=new pc.Vec3,reflectedCamDir=new pc.Vec3,invPortalPlane=new pc.Vec3,activeMirror=null,mirrorFrustum=new pc.Frustum,tempSphereMirror={center:null,radius:0},mirrorBit=0,atf={},MAX3D_SCALE=1,MIRRORSTATE_FAR=0,MIRRORSTATE_NEAR=1,MIRRORSTATE_TOUCH=2,MIRRORSTATE_SWITCH=3,MIRRORSTATE_POST=4,MIRRORSTATE_OFF=5,mirrorTransition=0,mirrorDefaultFov=0;function reflectionMatrix(e,t,r,a){var i=new pc.Mat4;return i.data[0]=1-2*e*e,i.data[1]=-2*e*t,i.data[2]=-2*e*r,i.data[3]=-2*e*a,i.data[4]=-2*e*t,i.data[5]=1-2*t*t,i.data[6]=-2*t*r,i.data[7]=-2*t*a,i.data[8]=-2*e*r,i.data[9]=-2*t*r,i.data[10]=1-2*r*r,i.data[11]=-2*r*a,i.data[12]=0,i.data[13]=0,i.data[14]=0,i.data[15]=1,i.transpose(),i}function customTransformFuncMirror(e,t){var r=this.node.getPosition(),a=this.node.getRotation();e.setTRS(r,a,pc.Vec3.ONE),e.mul2(world2reflMirror,e)}function customProjFuncMirror(e,t){if(this.projection===pc.PROJECTION_PERSPECTIVE)e.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov);else{var r=0*this.aspectRatio;e.setOrtho(-r,r,-0,0,this.nearClip,this.farClip)}var a=this.node.getPosition(),i=this.node.getRotation();tmpView.setTRS(a,i,pc.Vec3.ONE).invert(),tmpView.transformPoint(planePosWM,planePosV),tmpView.transformVector(planeNormalWM,planeNormalV).normalize(),planeAV=planeNormalV.x,planeBV=planeNormalV.y,planeCV=planeNormalV.z,planeDV=-planePosV.dot(planeNormalV),planeV.set(planeAV,planeBV,planeCV,planeDV),projInv.copy(e).invert(),planeQ.set(sgn(planeAV),sgn(planeBV),1,1),projInv.transformVec4(planeQ,planeQ),planeV.scale(2/planeV.dot(planeQ));var s=e.data;s[2]=planeV.x-s[3],s[6]=planeV.y-s[7],s[10]=planeV.z-s[11],s[14]=planeV.w-s[15]}function sgn(e){return e>0?1:e<0?-1:0}Mirror.prototype.isVisible=function(e){var t,r,a,i=e.frustum,s=this.pointsW,n=e.projectionMatrix;for(i.setFromMat4(n),r=0;r<6;r++){if(t=i.planes[r][0]*s[0].x+i.planes[r][1]*s[0].y+i.planes[r][2]*s[0].z+i.planes[r][3]<=0)for(a=1;a<4;a++)if(i.planes[r][0]*s[a].x+i.planes[r][1]*s[a].y+i.planes[r][2]*s[a].z+i.planes[r][3]>0){t=!1;break}if(t)return!1}return!0},Mirror.prototype.initialize=function(){var e,t,r,a,i=this.app,s=i.graphicsDevice;pc.shaderChunks;this.cam=i.root.findByName("Camera").camera,this.nearDist=3;var n=this.entity.render.meshInstances[0],o=atf.mirrorRt;if(!o){var p=n.material;p.customFragmentShader=this.shaderPS.resource,p.blendType=pc.BLEND_NORMAL,p.update(),pc.mirrorMaterial=p,pc.fallbackMirrorMaterial=p.clone(),this.setSky(2);var c=pc.PIXELFORMAT_R8_G8_B8_A8;s.webgl2&&s.extTextureFloatRenderable?c=pc.PIXELFORMAT_111110F:s.extTextureHalfFloatRenderable&&s.extTextureHalfFloatLinear&&(c=pc.PIXELFORMAT_RGBA16F);var l=new pc.Texture(s,{width:s.width,height:s.height,format:c,autoMipmap:!1});l.addressU=pc.ADDRESS_CLAMP_TO_EDGE,l.addressV=pc.ADDRESS_CLAMP_TO_EDGE,l.magFilter=pc.FILTER_LINEAR,l.minFilter=pc.FILTER_LINEAR,atf.mirrorRt=o=new pc.RenderTarget(s,l,{samples:4,depth:!0,stencil:!0}),s.scope.resolve("mirrorTex").setValue(l)}this.rt=o,n.setParameter("mirrorDepthOffset",0),n.setParameter("mirrorDensity",0===this.density?1:this.density);var h=this.primitive?this.entity:this.entity.children[0].children[0];this.planePosW=h.getPosition(),this.planeNormalW=h.forward,this.planeRightW=h.right,this.planeNormalWOrig=this.planeNormalW.clone(),e=this.planeNormalW.x,t=this.planeNormalW.y,r=this.planeNormalW.z,a=-this.planePosW.dot(this.planeNormalW),this.world2refl=reflectionMatrix(e,t,r,a),this.planeDW=a,this.maxXdiff=.5*h.getLocalScale().x*MAX3D_SCALE;var d,m=i.scene.drawCalls;this.dipsReflect=[],this.dipsReflect2=[];var f=n.material,u=this.entity.name+"_off",M=this.onlyTag,V=void 0!==M&&""!==M&&null!==M;for(d=0;d<m.length;d++)if(m[d].node){if(m[d].material===f)continue;for(var w=m[d].node,y=!1,R=!1,T=!1;w;)w.tags&&w.tags.has(u)&&(y=!0),w.tags&&w.tags.has("DontMirror")&&(R=!0),V&&w.tags&&w.tags.has(M)&&(T=!0),w=w.parent;m[d].node.getWorldTransform(),m[d].aabb,V?(T||m[d].command)&&this.dipsReflect.push(m[d]):(y||R||this.dipsReflect.push(m[d]),this.dipsReflect2.push(m[d]))}var g,A,P=this,addAsyncEntity=function(e){var t=e.model.asset;if(t){var r=i.assets.get(t);r&&(r.once("load",(function(){for(A=e.render.meshInstances,g=0;g<A.length;g++)P.dipsReflect.push(A[g]),P.dipsReflect2.push(A[g])})),i.assets.load(r))}},v=i.root.findByTag("MirrorOnly");for(d=0;d<v.length;d++)if(v[d].enabled)if(v[d].render)for(A=v[d].render.meshInstances,g=0;g<A.length;g++)this.dipsReflect.push(A[g]),this.dipsReflect2.push(A[g]);else addAsyncEntity(v[d]);for(v=i.root.findByTag(this.entity.name+"_on"),d=0;d<v.length;d++)if(v[d].enabled)for(A=v[d].render.meshInstances,g=0;g<A.length;g++)this.dipsReflect.push(A[g]);this.objectsOn=v,this.objectsOff=i.root.findByTag(u),this.init=!1,pc.mirrorCount?this.first=!1:(pc.mirrorCount=0,pc.mirrorsToRender=0,pc.mirrorList=[],pc.dipsMirror=[],pc.distortionNearFade=1,pc.isMirrorClose=!1,pc.mirrorsDrawn=0,this.first=!0),pc.mirrorCount++,pc.mirrorList.push(this);var W=new pc.BasicMaterial;W.redWrite=!1,W.greenWrite=!1,W.blueWrite=!1,W.alphaWrite=!1,W.depthWrite=!1,W.depthTest=!1,W.stencilBack=W.stencilFront=new pc.StencilParameters({zpass:pc.STENCILOP_REPLACE,ref:pc.mirrorCount});var E=new pc.MeshInstance(n.node,n.mesh,W);pc.dipsMirror.push(E),this.bit=pc.mirrorCount,this.srect={x:0,y:0,width:1,height:1},this.pointsW=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3];var C=h.getLocalScale(),_=h.right,S=h.up,b=new pc.Vec3;for(this.pointsW[0].copy(_).scale(.5*C.x*MAX3D_SCALE),b.copy(S).scale(.5*C.y*MAX3D_SCALE),this.pointsW[0].add(b).add(this.planePosW),this.pointsW[1].copy(_).scale(-.5*C.x*MAX3D_SCALE),b.copy(S).scale(-.5*C.y*MAX3D_SCALE),this.pointsW[1].add(b).add(this.planePosW),this.pointsW[2].copy(_).scale(-.5*C.x*MAX3D_SCALE),b.copy(S).scale(.5*C.y*MAX3D_SCALE),this.pointsW[2].add(b).add(this.planePosW),this.pointsW[3].copy(S).scale(-.5*C.y*MAX3D_SCALE),b.copy(_).scale(.5*C.x*MAX3D_SCALE),this.pointsW[3].add(b).add(this.planePosW),this.pointsW4=[new pc.Vec4,new pc.Vec4,new pc.Vec4,new pc.Vec4],d=0;d<4;d++)this.pointsW4[d].x=this.pointsW[d].x,this.pointsW4[d].y=this.pointsW[d].y,this.pointsW4[d].z=this.pointsW[d].z,this.pointsW4[d].w=1;this.clear={flags:0},this.clearFirst={color:[1,0,0,1],depth:1,stencil:0,flags:pc.CLEARFLAG_DEPTH|pc.CLEARFLAG_STENCIL},this.state=MIRRORSTATE_FAR,this.constDist=s.scope.resolve("distortionNearFade"),this.constTrans=s.scope.resolve("mirrorTransition");var L=n.aabb.getMin(),x=n._aabb.getMax(),F=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3];F[0].set(L.x,L.y,L.z),F[1].set(x.x,L.y,L.z),F[2].set(x.x,x.y,L.z),F[3].set(L.x,x.y,L.z),F[4].set(L.x,L.y,x.z),F[5].set(x.x,L.y,x.z),F[6].set(x.x,x.y,x.z),F[7].set(L.x,x.y,x.z),this.bp=F,this.mConst=this.app.graphicsDevice.scope.resolve("world2refl");var D=this.cam,I=this.app.scene.layers.getLayerByName("Mirror"),N=[I],preFunction=function(){planePosWM=P.planePosW,planeNormalWM=P.planeNormalW,world2reflMirror=P.world2refl,D.calculateTransform=customTransformFuncMirror,D.calculateProjection=customProjFuncMirror,D.flipFaces=!0,P.app.renderer.updateCameraFrustum(D.camera)},postFunction=function(){D.calculateTransform=null,D.calculateProjection=null,D.flipFaces=!1,P.app.renderer.updateCameraFrustum(D.camera)};for(d=0;d<N.length;d++)N[d].renderTarget=this.rt,N[d].onPreCull=N[d].onPreRender=preFunction,N[d].onPostCull=N[d].onPostRender=postFunction,N[d].enabled=!0;this.mirrorLayers=N,this.app.scene.on("set:skybox",(function(){I.addMeshInstances(P.app.scene.skyboxModel.meshInstances)})),this.wasVisible=!0,this.app.graphicsDevice.on("resizecanvas",(function(){atf={},this._init=!1}),this)},Mirror.prototype.update=function(e){if(this._init){1===this._init&&(this.initialize(),this._init=2);var t=this.isVisible(this.cam);if(t!==this.wasVisible){for(var r=0;r<this.mirrorLayers.length;r++)this.mirrorLayers[r].enabled=t;this.wasVisible=t}}else this._init=1},Mirror.prototype.setSky=function(e){this.skyIsOn=e,pc.fallbackMirrorMaterial&&(pc.fallbackMirrorMaterial.customFragmentShader=(e?"#define SKY\n":"")+"#define SIMPLE\n"+pc.shaderChunks.rgbmPS+this.shaderPS.resource,pc.fallbackMirrorMaterial.update())};var InstructionOpen=pc.createScript("instructionOpen");InstructionOpen.prototype.initialize=function(){this.entity.element.on("click",this.openInstruction,this)},InstructionOpen.prototype.update=function(t){},InstructionOpen.prototype.openInstruction=function(){this.app.fire("instruction:open")};var SelectButton=pc.createScript("selectButton");SelectButton.attributes.add("number",{type:"entity"}),SelectButton.attributes.add("type",{type:"entity"}),SelectButton.prototype.initialize=function(){this.parentEl=this.entity.parent.name,this.textures=this.entity.parent.findByName("Textures").children,this.totalNum=this.textures.length,this.child=this.type.children,this.currentIdx=0,this.entity.element.on("click",this.onClick,this),this.app.on("SelectButton:randomReturn",(function(t){this.randomReturn(t)}),this)},SelectButton.prototype.onClick=function(){"Prev Btn"===this.entity.name?this.prev():this.next()},SelectButton.prototype.prev=function(){this.textures[this.currentIdx].enabled=!1,this.child[this.currentIdx].enabled=!1,this.currentIdx=(this.currentIdx+this.totalNum-1)%this.totalNum,this.textures[this.currentIdx].enabled=!0,this.child[this.currentIdx].enabled=!0,this.app.fire("select:set","body",this.currentIdx)},SelectButton.prototype.next=function(){this.textures[this.currentIdx].enabled=!1,this.child[this.currentIdx].enabled=!1,this.currentIdx=(this.currentIdx+1)%this.totalNum,this.textures[this.currentIdx].enabled=!0,this.child[this.currentIdx].enabled=!0,this.app.fire("select:set","body",this.currentIdx)},SelectButton.prototype.randomReturn=function(t){this.currentIdx=t,this.app.fire("select:set","Body",this.currentIdx);for(let t=0;t<this.totalNum;t++)this.textures[t].enabled=!1,this.child[t].enabled=!1;this.textures[this.currentIdx].enabled=!0,this.child[this.currentIdx].enabled=!0},SelectButton.prototype.update=function(t){};var RandomBody=pc.createScript("randomBody");RandomBody.prototype.initialize=function(){this.entity.element.on("click",this.selectElement,this)},RandomBody.prototype.update=function(t){},RandomBody.prototype.selectElement=function(){let t=Math.floor(8*Math.random()),e=player.findByName("Avatar").children;for(let t=0;t<e.length;t++)e[t].enabled=!1;e[t].enabled=!0,this.app.fire("SelectButton:randomReturn",t)};var InfoControl=pc.createScript("infoControl");InfoControl.attributes.add("content",{type:"string",default:"Placerat nibh ultricies proin rutrum et, consequat amet quis egestas. Commodo lorem."}),InfoControl.prototype.initialize=function(){this.app;const t=pc.platform.mobile||pc.platform.touch?this.app.root.findByName("Mobile UI"):this.app.root.findByName("Desktop UI");this.infoUI=t.findByName("Info UI"),this.entity.element&&this.entity.element.on("click",this.infoClose,this),this.contentBox=this.infoUI.findByName("Content")},InfoControl.prototype.infoOpen=function(t){this.contentBox.element.text=this.content,this.infoUI.enabled=!0},InfoControl.prototype.infoClose=function(t){this.contentBox.element.text="",this.infoUI.enabled=!1},InfoControl.prototype.update=function(t){};var FullmapList=pc.createScript("fullmapList");FullmapList.attributes.add("roomList",{type:"entity"}),FullmapList.prototype.initialize=function(){const t=this.app;this.rooms=this.roomList.children,this.iconList=this.rooms[0].children,this.mapIcon=t.root.findByName("Map Icons").children,this.tempList=this.roomList.findByName("Temp List"),this.haveList=!1,t.on("FullmapList:changeScene",(function(t){this.changeScene(t)}),this)},FullmapList.prototype.changeScene=function(t){for(let i=0;i<this.rooms.length;i++)this.rooms[i].name!==t?this.rooms[i].enabled=!1:(this.rooms[i].enabled=!0,this.iconList=this.rooms[i].children,this.haveList=!0);this.haveList||this.createList(t)},FullmapList.prototype.createList=function(t){let i=new pc.Entity;i=this.tempList.clone(),i.name=t,this.app.root.findByName("Map Icons")&&(this.mapIcon=this.app.root.findByName("Map Icons").children);for(let t=0;t<this.mapIcon.length;t++){let e=new pc.Entity;e=this.tempList.children[0].clone(),e.children[1].element.text=this.mapIcon[t].name,e.setLocalPosition(0,-50*t,0),e.enabled=!0,i.addChild(e)}i.enabled=!0,this.roomList.addChild(i)},FullmapList.prototype.update=function(t){};var FullmapButton=pc.createScript("fullmapButton");FullmapButton.prototype.initialize=function(){this.entity.element.on("click",this.onClick,this)},FullmapButton.prototype.update=function(t){},FullmapButton.prototype.onClick=function(t){t.event.stopPropagation(),this.targetName=this.entity.findByName("Name").element.text,this.target=this.app.root.findByName(this.targetName),this.app.fire("player:teleport",this.target.getPosition())};var CaptureButton=pc.createScript("captureButton");CaptureButton.prototype.initialize=function(){this.entity.element.on("click",this.onClick,this)},CaptureButton.prototype.onClick=function(){this.app.fire("Screenshot:onTakeScreenshot")};var Screenshot=pc.createScript("screenshot");Screenshot.prototype.initialize=function(){this.app.on("Screenshot:onTakeScreenshot",this.onTakeScreenshot,this)},Screenshot.prototype.onTakeScreenshot=function(){const e=pc.platform.mobile||pc.platform.touch?this.app.root.findByName("Mobile UI"):this.app.root.findByName("Desktop UI");e.enabled=!1,setTimeout((function(){const t=document.querySelector("#application-canvas").toDataURL("image/png");var o=document.createElement("a");o.id="link",window.document.body.appendChild(o);var n=document.getElementById("link");n.setAttribute("download","anymuseum.png"),n.setAttribute("href",t),n.click(),e.enabled=!0}),1)};var PopupUi=pc.createScript("popupui");PopupUi.attributes.add("css",{type:"asset",assetType:"css",title:"CSS Asset"}),PopupUi.attributes.add("html",{type:"asset",assetType:"html",title:"HTML Asset"}),PopupUi.attributes.add("closeBtnImg",{type:"asset",assetType:"texture"}),PopupUi.prototype.initialize=function(){const e=this.app;this.player=e.root.findByName("Player").script.player;const t=pc.platform.mobile||pc.platform.touch?this.app.root.findByName("Mobile UI"):this.app.root.findByName("Desktop UI");this.inGameUI=t.findByName("In-game UI");var i=document.createElement("style");document.head.appendChild(i),i.innerHTML=this.css.resource||"",this.div=document.createElement("div"),this.div.classList.add("popupUI"),this.div.innerHTML=this.html.resource||"",document.body.appendChild(this.div),this.iframeWrap=this.div.querySelector("#iframeWrap"),this.iframe=document.createElement("iframe"),this.iframe.setAttribute("allowtransparency",!0),this.closeBtn=this.div.querySelector("#closeBtn"),this.closeBtn.style.background=`url(${this.closeBtnImg.getFileUrl()}) center / 100% no-repeat`,this.closeBtn.style.zIndex="1",this.initEvent(),e.on("popup:open",(function(t){this.iframe.src=t,this.iframeWrap.appendChild(this.iframe),this.div.classList.add("active"),this.inGameUI.enabled=!1,e.fire("playerCamera:disable")}),this),e.on("popup:close",(function(){this.div.classList.remove("active"),this.iframe.src="",this.iframeWrap.removeChild(this.iframe),this.inGameUI.enabled=!0,e.fire("playerCamera:enable")}),this)},PopupUi.prototype.initEvent=function(e){var t=this;this.closeBtn.addEventListener("click",(function(e){e.preventDefault(),t.app.fire("popup:close")}),!1)};var CaptionUi=pc.createScript("captionUi");CaptionUi.attributes.add("css",{type:"asset",assetType:"css",title:"CSS Asset"}),CaptionUi.attributes.add("html",{type:"asset",assetType:"html",title:"HTML Asset"}),CaptionUi.attributes.add("closeBtnImg",{type:"asset",assetType:"texture"}),CaptionUi.prototype.initialize=function(){const t=this.app,i=pc.platform.mobile||pc.platform.touch?this.app.root.findByName("Mobile UI"):this.app.root.findByName("Desktop UI");this.inGameUI=i.findByName("In-game UI");var e=document.createElement("style");document.head.appendChild(e),e.innerHTML=this.css.resource||"",this.div=document.createElement("div"),this.div.classList.add("captionUI"),this.div.innerHTML=this.html.resource||"",document.body.appendChild(this.div),this.titleDiv=this.div.querySelector("#title"),this.contentDiv=this.div.querySelector("#content"),this.closeBtn=this.div.querySelector("#closeBtn"),this.closeBtn.style.background=`url(${this.closeBtnImg.getFileUrl()}) center / 100% no-repeat`,this.closeBtn.style.zIndex="1",this.initEvent(),t.on("caption:open",(function(t,i){this.titleDiv.innerHTML=t,this.contentDiv.innerHTML=i,this.div.classList.add("active")}),this),t.on("caption:close",(function(){this.div.classList.remove("active"),this.titleDiv.innerHTML="",this.contentDiv.innerHTML=""}),this)},CaptionUi.prototype.initEvent=function(t){var i=this;this.closeBtn.addEventListener("click",(function(t){t.preventDefault(),i.app.fire("caption:close")}),!1)};var Caption=pc.createScript("caption");Caption.attributes.add("type",{type:"number",description:"caption: 0, link: 1, popup: 2",default:0}),Caption.attributes.add("title",{type:"string"}),Caption.attributes.add("content",{type:"string"}),Caption.attributes.add("url",{type:"string"}),Caption.prototype.initialize=function(){this.entity.element&&this.entity.element.on("click",(function(){1==window.confirm(`Press Yes to Rediract to ${this.url}`)&&window.open(this.url,"_blank")}),this)},Caption.prototype.openCaption=function(){0===this.type?""===this.title&&""===this.content||this.app.fire("caption:open",this.title,this.content):1===this.type?window.open(this.url,"_blank"):2===this.type&&""!==this.url&&this.app.fire("popup:open",this.url)};var ModelJsonReader=pc.createScript("modelJsonReader");ModelJsonReader.prototype.initialize=function(){this.progressBar=this.app.root.findByName("Scene Progress Bar"),this.progressBar&&(this.progressBarText=this.progressBar.findByName("Text")),this.app.on("ModelJsonReader:EnterRoom",this.enterRoom(),this)},ModelJsonReader.prototype.enterRoom=function(){let e=this;var t=new URL(window.top.location.href);this.roomID=t.searchParams.get("assignments"),console.log("this.roomID",this.roomID),this.loadJsonFromRemote(`https://play.grwth.hk/assignments/${this.roomID}`,(function(t){e.initDisplay(t)}))},ModelJsonReader.prototype.loadJsonFromRemote=function(e,t){var o=this,a=new XMLHttpRequest;a.addEventListener("load",(function(){t(JSON.parse(this.response))})),a.open("GET",e),this.progressBar&&(this.progressBar.enabled=!0),a.addEventListener("progress",(function(e){if(e.lengthComputable){var t=e.loaded/e.total;o.progressBarText&&(o.progressBarText.element.text="Loading JSON: "+Math.round(100*t)+"%"),e.loaded===e.total&&o.progressBar&&(o.progressBar.enabled=!1)}}),!1),a.send()},ModelJsonReader.prototype.initDisplay=async function(e){this.data=e.json.scene,this.lightArr=[],this.parentPlayData={},this.scene=new pc.Entity,this.scene.name=this.data.object.name,this.objTemp=this.app.root.findByName("Obj Temp"),this.portalTemp=this.app.root.findByName("Portal Temp"),this.app.root.findByName("RoomMaker").addChild(this.scene),this.addObj(this.data.object,this.scene)},ModelJsonReader.prototype.addObj=async function(e,t,o={}){for(let a=0;a<e.children.length;a++)"DirectionalLight"===e.children[a].type||(e.children[a].children?(this.addGroup(e.children[a],t,o),this.addMesh(e.children[a],t,o)):"Mesh"===e.children[a].type&&this.addMesh(e.children[a],t,o))},ModelJsonReader.prototype.addLight=function(e,t){},ModelJsonReader.prototype.addGroup=async function(e,t,o={}){var a=new pc.Entity;a.name=e.name,t.addChild(a),e.userData&&"Model"===e.userData.type?this.addObj(e,a,e):this.addObj(e,a)},ModelJsonReader.prototype.addMesh=async function(e,t,o={}){let a=this.objTemp.clone();a.name=e.uuid,a.script.obj.url=`https://play.grwth.hk/publishes/${this.roomID}/${e.uuid}.obj`,a.script.obj.meshUuid=e.uuid,a.script.obj.matUuid=e.material,a.script.obj.type=e.userData&&e.userData.type?e.userData.type:"gltf",a.script.obj.enabled=!0,t.addChild(a),o.userData?this.checkType(a,o):e.userData&&e.userData.type&&this.checkType(a,e)},ModelJsonReader.prototype.checkType=async function(e,t){let o=t.userData;if("Entrance"===o.type){this.app.root.findByName("Enter Portal").setPosition(t.matrix[12],t.matrix[13]+1,t.matrix[14]);let e=new pc.Entity;e=this.portalTemp.clone(),e.name=t.name,e.setPosition(t.matrix[12],t.matrix[13]+1,t.matrix[14]),e.script.makeMapIcon.enabled=!0,e.script.makeMapIcon.addIcon()}else if("Exit"===o.type){this.app.root.findByName("Exit Portal").setPosition(t.matrix[12],t.matrix[13],t.matrix[14]);let e=new pc.Entity;e=this.portalTemp.clone(),e.name=t.name,e.setPosition(t.matrix[12],t.matrix[13]+1,t.matrix[14]),e.script.makeMapIcon.enabled=!0,e.script.makeMapIcon.addIcon()}else if("Portal"===o.type){let e=new pc.Entity;e=this.portalTemp.clone(),e.name=t.name,e.setPosition(t.matrix[12],t.matrix[13]+1,t.matrix[14]),e.script.makeMapIcon.enabled=!0,e.script.makeMapIcon.addIcon()}o.play&&("Presentation"===o.type?"mp4"===o.play.presentation.option&&(e.script.videoTextureLink.screenMaterial=null,e.script.videoTextureLink.video=`https://play.grwth.hk/publishes/${this.roomID}/${t.uuid}/${o.play.presentation.value.sourceFile}`,e.script.videoTextureLink.enabled=!0):(o.play.onClick&&"none"!==o.play.onClick.option&&(e.script.rmobjectEvent.onClick.enable=!0,e.script.rmobjectEvent.onClick.option=o.play.onClick.option,e.script.rmobjectEvent.onClick.value=o.play.onClick.value),o.play.audio&&"none"!==o.play.audio.option&&(e.script.rmobjectEvent.audio.enable=!0,e.script.rmobjectEvent.audio.option=o.play.audio.option,e.script.rmobjectEvent.audio.value=o.play.audio.value.sourceFile,await this.createAudio(e,t,o.play.audio))))},ModelJsonReader.prototype.createAudio=function(e,t,o){let a=new pc.Asset(`${o.value.sourceFile}`,"audio",{url:`https://play.grwth.hk/publishes/${this.roomID}/${t.uuid}/${o.value.sourceFile}`},null);this.app.assets.add(a),this.app.assets.load(a),"onClick"===o.option&&(e.sound.positional=!1),"range"===o.option&&(e.sound.positional=!0,e.script.rangeMusicPlayer.pos=new pc.Vec3(t.matrix[12],t.matrix[13]+1,t.matrix[14]),e.script.rangeMusicPlayer.room="RoomMaker",e.script.rangeMusicPlayer.enabled=!0),a.on("load",(function(t){e.sound.addSlot(`${o.value.sourceFile}`,{asset:t,loop:"range"===o.option,overlap:!0,autoPlay:"range"===o.option})}))},ModelJsonReader.prototype.createImage=function(e,t,o=!1){let a=this.data.images;for(let o=0;o<a.length;o++)if(a[o].uuid===e){const e=a[o].url.split(";");return`https://play.grwth.hk/publishes/${this.roomID}/${t}.${e[0].substring(11)}`}},ModelJsonReader.prototype.createTexture=function(e,t,o){let a=this.data.textures;for(let i=0;i<a.length;i++)if(a[i].uuid===e){let e=new pc.Texture(this.app.graphicsDevice,{mipmaps:!1,flipY:"gltf"!==o}),r=document.createElement("img");return r.crossOrigin="anonymous",r.dataRetry="10",r.src=this.createImage(a[i].image,t),r.onload=()=>{e.setSource(r)},e}},ModelJsonReader.prototype.createMat=function(e,t,o){let a=new pc.StandardMaterial;a.name=e;let i=new pc.Asset(e,"material");return i.resource=a,this.app.assets.add(i),i.resource=a,i.id},ModelJsonReader.prototype.decToRGB=function(e,t){let o=Math.floor(e/65536),a=Math.floor(e/256)%256;return 0===t?o/256:1===t?a/256:2===t?e%256/256:void 0},ModelJsonReader.prototype.bakeLight=function(){for(let e=0;e<this.lightArr.length;e++)this.lightArr[e].light.shadowUpdateMod=pc.SHADOWUPDATE_THISFRAME},ModelJsonReader.prototype.update=function(e){};var FloatingSpin=pc.createScript("floatingSpin");FloatingSpin.attributes.add("spinX",{type:"number",default:0,title:"Spinning X"}),FloatingSpin.attributes.add("spinY",{type:"number",default:5,title:"Spinning Y"}),FloatingSpin.attributes.add("spinZ",{type:"number",default:0,title:"Spinning Z"}),FloatingSpin.attributes.add("moveX",{type:"number",default:0,title:"Moving X"}),FloatingSpin.attributes.add("moveY",{type:"number",default:50,title:"Moving Y"}),FloatingSpin.attributes.add("moveZ",{type:"number",default:0,title:"Moving Z"}),FloatingSpin.prototype.initialize=function(){this.newRot=(new pc.Vec3).copy(this.entity.getEulerAngles()),this.oriPos=(new pc.Vec3).copy(this.entity.getLocalPosition()),this.newPos=(new pc.Vec3).copy(this.entity.getLocalPosition()),this.timer=0},FloatingSpin.prototype.update=function(t){this.newRot.x=this.newRot.x+t*this.spinX,this.newRot.y=this.newRot.y+t*this.spinY,this.newRot.z=this.newRot.z+t*this.spinZ,this.entity.setEulerAngles(this.newRot),this.timer=this.timer+t,this.newPos.x=this.oriPos.x+Math.sin(this.timer)*this.moveX,this.newPos.y=this.oriPos.y+Math.sin(this.timer)*this.moveY,this.newPos.z=this.oriPos.z+Math.sin(this.timer)*this.moveZ,this.entity.setLocalPosition(this.newPos)};!function(e,t){"use strict";var s={};"undefined"!=typeof module?module.exports=s:e.OBJ=s,s.Mesh=function(e){for(var t=[],s=[],r=[],n={verts:[],norms:[],textures:[],hashindices:{},indices:[],index:0},i=e.split("\n"),u=/^v\s/,h=/^vn\s/,f=/^vt\s/,o=/^f\s/,d=/\s+/,a=0;a<i.length;a++){var l=i[a].trim(),c=l.split(d);if(c.shift(),u.test(l))t.push.apply(t,c);else if(h.test(l))s.push.apply(s,c);else if(f.test(l))r.push.apply(r,c);else if(o.test(l))for(var p=!1,x=0,m=c.length;x<m;x++){if(3!==x||p||(x=2,p=!0),c[x]in n.hashindices)n.indices.push(n.hashindices[c[x]]);else{var v=c[x].split("/");n.verts.push(+t[3*(v[0]-1)+0]),n.verts.push(+t[3*(v[0]-1)+1]),n.verts.push(+t[3*(v[0]-1)+2]),r.length&&(n.textures.push(+r[2*(v[1]-1)+0]),n.textures.push(+r[2*(v[1]-1)+1])),n.norms.push(+s[3*(v[2]-1)+0]),n.norms.push(+s[3*(v[2]-1)+1]),n.norms.push(+s[3*(v[2]-1)+2]),n.hashindices[c[x]]=n.index,n.indices.push(n.index),n.index+=1}3===x&&p&&n.indices.push(n.hashindices[c[0]])}}this.vertices=n.verts,this.vertexNormals=n.norms,this.textures=n.textures,this.indices=n.indices};var Ajax=function(){var e=this;this.xmlhttp=new XMLHttpRequest,this.get=function(t,s){e.xmlhttp.onreadystatechange=function(){4===e.xmlhttp.readyState&&s(e.xmlhttp.responseText,e.xmlhttp.status)},e.xmlhttp.open("GET",t,!0),e.xmlhttp.send()}};s.downloadMeshes=function(e,t,r){var n=Object.keys(e).length,i=!1;for(var u in undefined===r&&(r={}),e)e.hasOwnProperty(u)&&(new Ajax).get(e[u],function(e){return function(u,h){if(200===h?r[e]=new s.Mesh(u):(i=!0,console.error('An error has occurred and the mesh "'+e+'" could not be downloaded.')),0===--n){if(i)throw console.error("An error has occurred and one or meshes has not been downloaded. The execution of the script has terminated."),"";t(r)}}}(u))};var _buildBuffer=function(e,t,s,r){var n=e.createBuffer(),i=t===e.ARRAY_BUFFER?Float32Array:Uint16Array;return e.bindBuffer(t,n),e.bufferData(t,new i(s),e.STATIC_DRAW),n.itemSize=r,n.numItems=s.length/r,n};s.initMeshBuffers=function(e,t){t.normalBuffer=_buildBuffer(e,e.ARRAY_BUFFER,t.vertexNormals,3),t.textureBuffer=_buildBuffer(e,e.ARRAY_BUFFER,t.textures,2),t.vertexBuffer=_buildBuffer(e,e.ARRAY_BUFFER,t.vertices,3),t.indexBuffer=_buildBuffer(e,e.ELEMENT_ARRAY_BUFFER,t.indices,1)},s.deleteMeshBuffers=function(e,t){e.deleteBuffer(t.normalBuffer),e.deleteBuffer(t.textureBuffer),e.deleteBuffer(t.vertexBuffer),e.deleteBuffer(t.indexBuffer)}}(this);var Obj=pc.createScript("obj");Obj.attributes.add("url",{type:"string"}),Obj.attributes.add("meshUuid",{type:"string"}),Obj.attributes.add("matUuid",{type:"string"}),Obj.attributes.add("type",{type:"string",default:"gltf"}),Obj.prototype.loadModel=function(t){var e=new OBJ.Mesh(t),i={};if(e.vertexNormals&&(i.normals=e.vertexNormals),e.textures&&(i.uvs=e.textures),e.indices&&(i.indices=e.indices),e.vertices&&e.vertexNormals&&e.textures&&e.indices){var s=pc.calculateTangents(e.vertices,e.vertexNormals,e.textures,e.indices);i.tangents=s}var a=pc.createMesh(this.app.graphicsDevice,e.vertices,i),r=new pc.GraphNode,n=new pc.StandardMaterial,o=new pc.MeshInstance(r,a,n),d=new pc.Model;d.graph=r,d.meshInstances=[o],this.entity.addComponent("collision"),this.entity.collision.type="mesh",this.entity.collision.model=d,this.entity.addComponent("rigidbody")},Obj.prototype.initialize=function(){},Obj.prototype.init=function(){var t=new pc.Asset("obj","text",{url:this.url});t.tags.add("RoomMaker");var e=this;t.ready((function(t){e.loadModel(t.resource)})),this.app.assets.add(t),this.app.assets.load(t)},Obj.prototype.update=function(t){};var RandomNpc=pc.createScript("randomNpc");RandomNpc.attributes.add("npcTarget",{type:"entity",title:"Target Entity"}),RandomNpc.attributes.add("npcSpeed",{type:"number",default:1,title:"RandomNpc Speed"}),RandomNpc.attributes.add("npcRange",{type:"number",default:5,title:"RandomNpc Range"}),RandomNpc.prototype.initialize=function(){this.distanceToTartget=0,this.npcCanSeeTarget=!1,this.npcDestination=new pc.Vec3,this.npcOrigin=new pc.Vec3,this.npcOrigin.copy(this.entity.getPosition()),this.npcState="Search"},RandomNpc.prototype.update=function(t){this.updateView(t),this.updateState(t),this.detectObstacle(),this.applyGravity()},RandomNpc.prototype.updateView=function(t){if(this.npcTarget?this.distanceToTarget=this.entity.getPosition().distance(this.npcTarget.getPosition()):(this.distanceToTarget=100,this.npcTarget=this.app.root.findByName("Start Point")),this.distanceToDestination=this.entity.getPosition().distance(new pc.Vec3(this.npcDestination.x,this.entity.getPosition().y,this.npcDestination.z)),this.distanceToTarget<40){var i=this.npcTarget.getPosition();if(i.sub(this.entity.getPosition()).normalize(),i.dot(this.entity.forward)>.5||this.npcCanSeeTarget){var n=this.app.systems.rigidbody.raycastFirst(this.entity.getPosition(),this.npcTarget.getPosition());n&&n.entity===this.npcTarget?(this.npcCanSeeTarget=!0,this.npcDestination.copy(new pc.Vec3(this.npcTarget.getPosition().x,1,this.npcTarget.getPosition().z))):this.npcCanSeeTarget=!1}else this.npcCanSeeTarget=!1}else this.npcCanSeeTarget=!1},RandomNpc.prototype.updateState=function(t){this.setState("Search"),this.executeState(t)},RandomNpc.prototype.setState=function(t){this.npcState!=t&&(this.npcState=t,this.npcStateText&&(this.npcStateText.text=t))},RandomNpc.prototype.executeState=function(t){"Search"===this.npcState?this.distanceToDestination>.2?(this.entity.lookAt(new pc.Vec3(this.npcDestination.x,this.entity.getPosition().y,this.npcDestination.z)),this.entity.translateLocal(0,0,-this.npcSpeed*t)):this.randomDestination():"Alert"===this.npcState?(this.npcDestination.copy(new pc.Vec3(this.npcTarget.getPosition().x,this.entity.getPosition().y,this.npcTarget.getPosition().z)),this.entity.lookAt(new pc.Vec3(this.npcDestination.x,this.entity.getPosition().y,this.npcDestination.z))):"Chase"===this.npcState?(this.npcDestination.copy(new pc.Vec3(this.npcTarget.getPosition().x,this.entity.getPosition().y,this.npcTarget.getPosition().z)),this.entity.lookAt(new pc.Vec3(this.npcDestination.x,this.entity.getPosition().y,this.npcDestination.z)),this.distanceToDestination>3&&this.entity.translateLocal(0,0,-this.npcSpeed*t*2)):"Attack"===this.npcState&&(this.npcDestination.copy(new pc.Vec3(this.npcTarget.getPosition().x,this.entity.getPosition().y,this.npcTarget.getPosition().z)),this.entity.lookAt(new pc.Vec3(this.npcDestination.x,this.entity.getPosition().y,this.npcDestination.z)))},RandomNpc.prototype.randomDestination=function(){const t=pc.math.random(this.npcOrigin.x-this.npcRange,this.npcOrigin.x+this.npcRange),i=pc.math.random(this.npcOrigin.z-this.npcRange,this.npcOrigin.z+this.npcRange);this.npcDestination.copy(new pc.Vec3(t,this.entity.getPosition().y,i))},RandomNpc.prototype.detectObstacle=function(){var t=this.app.systems.rigidbody.raycastFirst(this.entity.getPosition(),this.npcDestination);t&&(this.entity.getPosition().distance(t.point)<2&&this.randomDestination())},RandomNpc.prototype.applyGravity=function(){var t=.1,i=this.entity.getPosition(),n=new pc.Vec3(i.x,i.y+.05,i.z),e=new pc.Vec3(i.x,i.y-t,i.z),s=this.app.systems.rigidbody.raycastFirst(n,e);if(s)Math.abs(s.point.y-this.entity.getPosition().y)-t<-.1&&this.entity.setPosition(this.entity.getPosition().x,s.point.y+t,this.entity.getPosition().z);else{this.entity.translateLocal(0,-.1,0)}};class TourNpc extends pc.ScriptType{sleep(t){return new Promise((e=>setTimeout(e,t)))}async initialize(){this.entity.anim.setFloat("walk",0),this.chatbox=this.entity.findByName("Group"),await this.tasks()}async tasks(){let t=0,e=this.route;do{let a=e[t].point.getPosition();0!==e[t].walk&&(this.walk(a,e[t].walk),await this.sleep(1e3*e[t].walk),this.idle()),""!==e[t].talk&&(this.chatbox.enabled=!0,this.chatbox.findByName("Talk").element.text=e[t].talk),await this.sleep(1e3*e[t].wait),t=(t+1)%Object.keys(e).length||0,this.chatbox.enabled=!1}while(this.loop)}walk(t,e){const a=this.entity.getLocalPosition();this.entity.anim.setFloat("walk",1),this.entity.lookAt(t);this.entity.tween(a).to(t,e,pc.Linear).on("complete",(()=>{})).start()}idle(){this.entity.anim.setFloat("walk",0)}}pc.registerScript(TourNpc),TourNpc.attributes.add("route",{type:"json",array:!0,schema:[{name:"point",type:"entity"},{name:"walk",type:"number",default:5},{name:"wait",type:"number",default:1},{name:"talk",type:"string"}]}),TourNpc.attributes.add("loop",{type:"boolean",default:!0});var PlayAnim=pc.createScript("playAnim");PlayAnim.prototype.initialize=function(){this.app.on("PlayAnim:setWalkValue",(function(t){this.entity.anim&&(t>0&&this.entity.anim.parameters.walk.value<=0||t<=0&&this.entity.anim.parameters.walk.value>0)&&this.entity.anim.setFloat("walk",t)}),this),this.app.on("PlayAnim:setFlyValue",(function(){if(this.entity.anim){let t=this.app.systems.rigidbody.gravity.y;this.entity.anim.parameters.fly.value!==t&&(this.entity.anim.setFloat("fly",t),console.log(this.entity.anim.parameters.fly,t))}}),this)},PlayAnim.prototype.update=function(t){};pc.extend(pc,function(){var TweenManager=function(t){this._app=t,this._tweens=[],this._add=[]};TweenManager.prototype={add:function(t){return this._add.push(t),t},update:function(t){for(var i=0,e=this._tweens.length;i<e;)this._tweens[i].update(t)?i++:(this._tweens.splice(i,1),e--);this._add.length&&(this._tweens=this._tweens.concat(this._add),this._add.length=0)}};var Tween=function(t,i,e){pc.events.attach(this),this.manager=i,e&&(this.entity=null),this.time=0,this.complete=!1,this.playing=!1,this.stopped=!0,this.pending=!1,this.target=t,this.duration=0,this._currentDelay=0,this.timeScale=1,this._reverse=!1,this._delay=0,this._yoyo=!1,this._count=0,this._numRepeats=0,this._repeatDelay=0,this._from=!1,this._slerp=!1,this._fromQuat=new pc.Quat,this._toQuat=new pc.Quat,this._quat=new pc.Quat,this.easing=pc.Linear,this._sv={},this._ev={}},_parseProperties=function(t){var i;return t instanceof pc.Vec2?i={x:t.x,y:t.y}:t instanceof pc.Vec3?i={x:t.x,y:t.y,z:t.z}:t instanceof pc.Vec4||t instanceof pc.Quat?i={x:t.x,y:t.y,z:t.z,w:t.w}:t instanceof pc.Color?(i={r:t.r,g:t.g,b:t.b},void 0!==t.a&&(i.a=t.a)):i=t,i};Tween.prototype={to:function(t,i,e,s,n,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),s&&this.delay(s),n&&this.repeat(n),r&&this.yoyo(r),this},from:function(t,i,e,s,n,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),s&&this.delay(s),n&&this.repeat(n),r&&this.yoyo(r),this._from=!0,this},rotate:function(t,i,e,s,n,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),s&&this.delay(s),n&&this.repeat(n),r&&this.yoyo(r),this._slerp=!0,this},start:function(){var t,i,e,s;if(this.playing=!0,this.complete=!1,this.stopped=!1,this._count=0,this.pending=this._delay>0,this._reverse&&!this.pending?this.time=this.duration:this.time=0,this._from){for(t in this._properties)this._properties.hasOwnProperty(t)&&(this._sv[t]=this._properties[t],this._ev[t]=this.target[t]);this._slerp&&(this._toQuat.setFromEulerAngles(this.target.x,this.target.y,this.target.z),i=void 0!==this._properties.x?this._properties.x:this.target.x,e=void 0!==this._properties.y?this._properties.y:this.target.y,s=void 0!==this._properties.z?this._properties.z:this.target.z,this._fromQuat.setFromEulerAngles(i,e,s))}else{for(t in this._properties)this._properties.hasOwnProperty(t)&&(this._sv[t]=this.target[t],this._ev[t]=this._properties[t]);this._slerp&&(i=void 0!==this._properties.x?this._properties.x:this.target.x,e=void 0!==this._properties.y?this._properties.y:this.target.y,s=void 0!==this._properties.z?this._properties.z:this.target.z,void 0!==this._properties.w?(this._fromQuat.copy(this.target),this._toQuat.set(i,e,s,this._properties.w)):(this._fromQuat.setFromEulerAngles(this.target.x,this.target.y,this.target.z),this._toQuat.setFromEulerAngles(i,e,s)))}return this._currentDelay=this._delay,this.manager.add(this),this},pause:function(){this.playing=!1},resume:function(){this.playing=!0},stop:function(){this.playing=!1,this.stopped=!0},delay:function(t){return this._delay=t,this.pending=!0,this},repeat:function(t,i){return this._count=0,this._numRepeats=t,this._repeatDelay=i||0,this},loop:function(t){return t?(this._count=0,this._numRepeats=1/0):this._numRepeats=0,this},yoyo:function(t){return this._yoyo=t,this},reverse:function(){return this._reverse=!this._reverse,this},chain:function(){for(var t=arguments.length;t--;)t>0?arguments[t-1]._chained=arguments[t]:this._chained=arguments[t];return this},update:function(t){if(this.stopped)return!1;if(!this.playing)return!0;if(!this._reverse||this.pending?this.time+=t*this.timeScale:this.time-=t*this.timeScale,this.pending){if(!(this.time>this._currentDelay))return!0;this._reverse?this.time=this.duration-(this.time-this._currentDelay):this.time-=this._currentDelay,this.pending=!1}var i=0;(!this._reverse&&this.time>this.duration||this._reverse&&this.time<0)&&(this._count++,this.complete=!0,this.playing=!1,this._reverse?(i=this.duration-this.time,this.time=0):(i=this.time-this.duration,this.time=this.duration));var e,s,n=0===this.duration?1:this.time/this.duration,r=this.easing(n);for(var h in this._properties)this._properties.hasOwnProperty(h)&&(e=this._sv[h],s=this._ev[h],this.target[h]=e+(s-e)*r);if(this._slerp&&this._quat.slerp(this._fromQuat,this._toQuat,r),this.entity&&(this.entity._dirtifyLocal(),this.element&&this.entity.element&&(this.entity.element[this.element]=this.target),this._slerp&&this.entity.setLocalRotation(this._quat)),this.fire("update",t),this.complete){var a=this._repeat(i);return a?this.fire("loop"):(this.fire("complete",i),this.entity&&this.entity.off("destroy",this.stop,this),this._chained&&this._chained.start()),a}return!0},_repeat:function(t){if(this._count<this._numRepeats){if(this._reverse?this.time=this.duration-t:this.time=t,this.complete=!1,this.playing=!0,this._currentDelay=this._repeatDelay,this.pending=!0,this._yoyo){for(var i in this._properties){var e=this._sv[i];this._sv[i]=this._ev[i],this._ev[i]=e}this._slerp&&(this._quat.copy(this._fromQuat),this._fromQuat.copy(this._toQuat),this._toQuat.copy(this._quat))}return!0}return!1}};var BounceOut=function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},BounceIn=function(t){return 1-BounceOut(1-t)};return{TweenManager:TweenManager,Tween:Tween,Linear:function(t){return t},QuadraticIn:function(t){return t*t},QuadraticOut:function(t){return t*(2-t)},QuadraticInOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},CubicIn:function(t){return t*t*t},CubicOut:function(t){return--t*t*t+1},CubicInOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},QuarticIn:function(t){return t*t*t*t},QuarticOut:function(t){return 1- --t*t*t*t},QuarticInOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},QuinticIn:function(t){return t*t*t*t*t},QuinticOut:function(t){return--t*t*t*t*t+1},QuinticInOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},SineIn:function(t){return 0===t?0:1===t?1:1-Math.cos(t*Math.PI/2)},SineOut:function(t){return 0===t?0:1===t?1:Math.sin(t*Math.PI/2)},SineInOut:function(t){return 0===t?0:1===t?1:.5*(1-Math.cos(Math.PI*t))},ExponentialIn:function(t){return 0===t?0:Math.pow(1024,t-1)},ExponentialOut:function(t){return 1===t?1:1-Math.pow(2,-10*t)},ExponentialInOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))},CircularIn:function(t){return 1-Math.sqrt(1-t*t)},CircularOut:function(t){return Math.sqrt(1- --t*t)},CircularInOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},BackIn:function(t){var i=1.70158;return t*t*((i+1)*t-i)},BackOut:function(t){var i=1.70158;return--t*t*((i+1)*t+i)+1},BackInOut:function(t){var i=2.5949095;return(t*=2)<1?t*t*((i+1)*t-i)*.5:.5*((t-=2)*t*((i+1)*t+i)+2)},BounceIn:BounceIn,BounceOut:BounceOut,BounceInOut:function(t){return t<.5?.5*BounceIn(2*t):.5*BounceOut(2*t-1)+.5},ElasticIn:function(t){var i,e=.1;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=.4*Math.asin(1/e)/(2*Math.PI),-e*Math.pow(2,10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/.4))},ElasticOut:function(t){var i,e=.1;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=.4*Math.asin(1/e)/(2*Math.PI),e*Math.pow(2,-10*t)*Math.sin((t-i)*(2*Math.PI)/.4)+1)},ElasticInOut:function(t){var i,e=.1,s=.4;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=s*Math.asin(1/e)/(2*Math.PI),(t*=2)<1?e*Math.pow(2,10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/s)*-.5:e*Math.pow(2,-10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/s)*.5+1)}}}()),function(){pc.Application.prototype.addTweenManager=function(){this._tweenManager=new pc.TweenManager(this),this.on("update",(function(t){this._tweenManager.update(t)}))},pc.Application.prototype.tween=function(t){return new pc.Tween(t,this._tweenManager)},pc.Entity.prototype.tween=function(t,i){var e=this._app.tween(t);return e.entity=this,this.once("destroy",e.stop,e),i&&i.element&&(e.element=i.element),e};var t=pc.Application.getApplication();t&&t.addTweenManager()}();var ChangeSkybox=pc.createScript("changeSkybox");ChangeSkybox.attributes.add("general",{type:"asset"}),ChangeSkybox.attributes.add("room",{type:"json",array:!0,schema:[{name:"scene",type:"string",array:!0},{name:"skybox",type:"asset"}]}),ChangeSkybox.prototype.initialize=function(){this.app.on("ChangeSkybox:onChangeScene",(function(e){this.onChangeScene(e)}),this)},ChangeSkybox.prototype.onChangeScene=function(e){for(let t=0;t<this.room.length;t++)for(let n=0;n<this.room[t].scene.length;n++)if(this.room[t].scene[n]===e)return this.app.scene.skyboxMip=0,this.app.scene.setSkybox(this.room[t].skybox.resources),void(this.app.renderNextFrame=!0);this.app.scene.skyboxMip=0,this.app.scene.setSkybox(this.general.resources),this.app.renderNextFrame=!0},ChangeSkybox.prototype.update=function(e){};pc.extend(pc,function(){function computeGaussian(e,t){return 1/Math.sqrt(2*Math.PI*t)*Math.exp(-e*e/(2*t*t))}function calculateBlurValues(e,t,r,s,o){e[0]=computeGaussian(0,o),t[0]=0,t[1]=0;var i,a,l=e[0];for(i=0,a=Math.floor(7.5);i<a;i++){var u=computeGaussian(i+1,o);e[2*i]=u,e[2*i+1]=u,l+=2*u;var n=2*i+1.5;t[4*i]=r*n,t[4*i+1]=s*n,t[4*i+2]=-r*n,t[4*i+3]=-s*n}for(i=0,a=e.length;i<a;i++)e[i]/=l}var BloomEffect=function(e){var t={aPosition:pc.SEMANTIC_POSITION},r=["attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","    gl_Position = vec4(aPosition, 0.0, 1.0);","    vUv0 = (aPosition + 1.0) * 0.5;","}"].join("\n"),s=["precision "+e.precision+" float;","","varying vec2 vUv0;","","uniform sampler2D uBaseTexture;","uniform float uBloomThreshold;","","void main(void)","{","    vec4 color = texture2D(uBaseTexture, vUv0);","","    gl_FragColor = clamp((color - uBloomThreshold) / (1.0 - uBloomThreshold), 0.0, 1.0);","}"].join("\n"),o=["precision "+e.precision+" float;","","#define SAMPLE_COUNT 15","","varying vec2 vUv0;","","uniform sampler2D uBloomTexture;","uniform vec2 uBlurOffsets[SAMPLE_COUNT];","uniform float uBlurWeights[SAMPLE_COUNT];","","void main(void)","{","    vec4 color = vec4(0.0);","    for (int i = 0; i < SAMPLE_COUNT; i++)","    {","        color += texture2D(uBloomTexture, vUv0 + uBlurOffsets[i]) * uBlurWeights[i];","    }","","    gl_FragColor = color;","}"].join("\n"),i=["precision "+e.precision+" float;","","varying vec2 vUv0;","","uniform float uBloomEffectIntensity;","uniform sampler2D uBaseTexture;","uniform sampler2D uBloomTexture;","","void main(void)","{","    vec4 bloom = texture2D(uBloomTexture, vUv0) * uBloomEffectIntensity;","    vec4 base = texture2D(uBaseTexture, vUv0);","","    base *= (1.0 - clamp(bloom, 0.0, 1.0));","","    gl_FragColor = base + bloom;","}"].join("\n");this.extractShader=new pc.Shader(e,{attributes:t,vshader:r,fshader:s}),this.blurShader=new pc.Shader(e,{attributes:t,vshader:r,fshader:o}),this.combineShader=new pc.Shader(e,{attributes:t,vshader:r,fshader:i});var a=e.width,l=e.height;this.targets=[];for(var u=0;u<2;u++){var n=new pc.Texture(e,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:a>>1,height:l>>1});n.minFilter=pc.FILTER_LINEAR,n.magFilter=pc.FILTER_LINEAR,n.addressU=pc.ADDRESS_CLAMP_TO_EDGE,n.addressV=pc.ADDRESS_CLAMP_TO_EDGE;var h=new pc.RenderTarget(e,n,{depth:!1});this.targets.push(h)}this.bloomThreshold=.25,this.blurAmount=4,this.bloomIntensity=1.25,this.sampleWeights=new Float32Array(15),this.sampleOffsets=new Float32Array(30);var c=new pc.Texture(e,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:a>>1,height:l>>1});c.minFilter=pc.FILTER_LINEAR,c.magFilter=pc.FILTER_LINEAR,c.addressU=pc.ADDRESS_CLAMP_TO_EDGE,c.addressV=pc.ADDRESS_CLAMP_TO_EDGE,this.renderTarget=new pc.RenderTarget(e,c,{depth:!0}),pc.app.scene.layers.getLayerByName("Bloom")&&(pc.app.scene.layers.getLayerByName("Bloom").renderTarget=this.renderTarget)};return(BloomEffect=pc.inherits(BloomEffect,pc.PostEffect)).prototype=pc.extend(BloomEffect.prototype,{render:function(e,t,r){var s=this.device,o=s.scope;o.resolve("uBloomThreshold").setValue(this.bloomThreshold),o.resolve("uBaseTexture").setValue(this.renderTarget.colorBuffer),pc.drawFullscreenQuad(s,this.targets[0],this.vertexBuffer,this.extractShader),calculateBlurValues(this.sampleWeights,this.sampleOffsets,1/this.targets[1].width,0,this.blurAmount),o.resolve("uBlurWeights[0]").setValue(this.sampleWeights),o.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),o.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),pc.drawFullscreenQuad(s,this.targets[1],this.vertexBuffer,this.blurShader),calculateBlurValues(this.sampleWeights,this.sampleOffsets,0,1/this.targets[0].height,this.blurAmount),o.resolve("uBlurWeights[0]").setValue(this.sampleWeights),o.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),o.resolve("uBloomTexture").setValue(this.targets[1].colorBuffer),pc.drawFullscreenQuad(s,this.targets[0],this.vertexBuffer,this.blurShader),o.resolve("uBloomEffectIntensity").setValue(this.bloomIntensity),o.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),o.resolve("uBaseTexture").setValue(e.colorBuffer),pc.drawFullscreenQuad(s,t,this.vertexBuffer,this.combineShader,r)}}),{BloomEffect:BloomEffect}}());var Bloom=pc.createScript("bloom");Bloom.attributes.add("bloomIntensity",{type:"number",default:1,min:0,title:"Intensity"}),Bloom.attributes.add("bloomThreshold",{type:"number",default:.25,min:0,max:1,precision:2,title:"Threshold"}),Bloom.attributes.add("blurAmount",{type:"number",default:4,min:1,title:"Blur amount"}),Bloom.prototype.initialize=function(){this.effect=new pc.BloomEffect(this.app.graphicsDevice),this.effect.bloomThreshold=this.bloomThreshold,this.effect.blurAmount=this.blurAmount,this.effect.bloomIntensity=this.bloomIntensity;var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("attr",(function(e,t){this.effect[e]=t}),this),this.on("state",(function(t){t?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect)}))};var ApplyBloom=pc.createScript("applyBloom");ApplyBloom.attributes.add("bloomIntensity",{type:"number",title:"Bloom Intensity",min:0,default:10}),ApplyBloom.attributes.add("bloomThreshold",{type:"number",title:"Bloom Threshold",min:0,max:1,default:.25}),ApplyBloom.attributes.add("blurAmount",{type:"number",title:"Blur Amount",min:1,max:10,default:4}),ApplyBloom.prototype.initialize=function(){this.vec=new pc.Vec3,this.prepare(),window.addEventListener("resize",this.onResize.bind(this))},ApplyBloom.prototype.prepare=function(){this.texture=new pc.Texture(this.app.graphicsDevice,{width:this.app.graphicsDevice.width,height:this.app.graphicsDevice.height,format:pc.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!0,minFilter:pc.FILTER_LINEAR,magFilter:pc.FILTER_LINEAR}),this.renderTarget=new pc.RenderTarget({colorBuffer:this.texture,depth:!0,samples:8}),this.worldLayer=this.app.scene.layers.getLayerByName("World"),this.bloomLayer=this.app.scene.layers.getLayerByName("Bloom"),this.bloomLayer.renderTarget=this.renderTarget,this.bloomCamera=new pc.Entity,this.bloomCamera.addComponent("camera",{clearColor:new pc.Color(0,0,0,0),layers:[this.bloomLayer.id],fov:this.app.root.findByName("Camera").camera.fov}),this.app.root.addChild(this.bloomCamera),this.bloomCamera.camera.priority=0,this.bloomEffect=new pc.BloomEffect(this.app.graphicsDevice),this.bloomEffect.bloomThreshold=this.bloomThreshold,this.bloomEffect.blurAmount=this.blurAmount,this.bloomEffect.bloomIntensity=this.bloomIntensity,this.entity.camera.postEffects.addEffect(this.bloomEffect)},ApplyBloom.prototype.onResize=function(){this.entity.camera.postEffects.removeEffect(this.bloomEffect),this.app.scene.layers.remove(this.bloomLayer),this.texture.destroy(),this.texture=new pc.Texture(this.app.graphicsDevice,{width:this.app.graphicsDevice.width,height:this.app.graphicsDevice.height,format:pc.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!0,minFilter:pc.FILTER_LINEAR,magFilter:pc.FILTER_LINEAR}),this.renderTarget.destroy(),this.renderTarget=new pc.RenderTarget(this.app.graphicsDevice,this.texture,{depth:!0}),this.bloomLayer.renderTarget=this.renderTarget,this.app.scene.layers.insert(this.bloomLayer,0),this.bloomLayer.texture=this.texture,this.entity.camera.postEffects.addEffect(this.bloomEffect)},ApplyBloom.prototype.update=function(e){var t=this.entity.getWorldTransform();this.bloomCamera.setPosition(t.getTranslation()),this.bloomCamera.setEulerAngles(t.getEulerAngles()),this.bloomCamera.setLocalScale(t.getScale()),this.bloomCamera.camera.horizontalFov=!(this.app.graphicsDevice.width>this.app.graphicsDevice.height)};var RmObjectEvent=pc.createScript("rmobjectEvent");RmObjectEvent.attributes.add("onClick",{type:"json",schema:[{name:"enable",type:"boolean",default:!1},{name:"option",type:"string"},{name:"value",type:"string"}]}),RmObjectEvent.attributes.add("audio",{type:"json",schema:[{name:"enable",type:"boolean",default:!1},{name:"option",type:"string"},{name:"value",type:"string"}]}),RmObjectEvent.prototype.initialize=function(){},RmObjectEvent.prototype.checkEvent=function(){if(console.log("checkEvent",this.onClick,this.audio),this.onClick.enable&&"urlPopUp"===this.onClick.option&&"string"==typeof this.onClick.value&&1==window.confirm(`Press Yes to Rediract to ${this.onClick.value}`)&&window.open(this.onClick.value,"_blank"),this.audio.enable&&"onClick"===this.audio.option&&null!==this.audio.value)if(console.log(this.entity.sound),this.entity.sound)this.entity.sound.play(`${this.audio.value}`);else{this.entity.findByName(`${entity.name} sound`).sound.play(`${this.audio.value}`)}},RmObjectEvent.prototype.update=function(t){};var MusicPlayer=pc.createScript("musicPlayer");MusicPlayer.prototype.initialize=function(){},MusicPlayer.prototype.playMusic=function(){this.entity.sound.play("Slot 1")},MusicPlayer.prototype.update=function(t){};var RangeMusicPlayer=pc.createScript("rangeMusicPlayer");RangeMusicPlayer.attributes.add("maxDistance",{type:"number",default:"10"}),RangeMusicPlayer.attributes.add("pos",{type:"vec3"}),RangeMusicPlayer.attributes.add("room",{type:"string"}),RangeMusicPlayer.prototype.initialize=function(){this.player=this.app.root.findByName("Player")},RangeMusicPlayer.prototype.update=function(t){if(this.pos.distance(this.player.getPosition())>this.maxDistance)for(const[t,e]of Object.entries(this.entity.sound.slots))this.entity.sound.slot(t).isPlaying&&this.entity.sound.stop(t);else for(const[t,e]of Object.entries(this.entity.sound.slots))this.entity.sound.slot(t).isPlaying||this.entity.sound.play(t)};var AnimatedTexture=pc.createScript("animatedTexture");AnimatedTexture.attributes.add("materialAsset",{type:"asset",assetType:"material"}),AnimatedTexture.attributes.add("numFrames",{type:"number",default:1,description:"Number of frames to play before looping"}),AnimatedTexture.attributes.add("startFrame",{type:"number",default:0,description:"Frame to start animation from"}),AnimatedTexture.attributes.add("width",{type:"number",default:1,description:"Number of frames wide"}),AnimatedTexture.attributes.add("height",{type:"number",default:1,description:"Number of frames high"}),AnimatedTexture.attributes.add("frameRate",{type:"number",default:1,description:"Playback frames per second"}),AnimatedTexture.prototype.initialize=function(){this.materialAsset&&(this.material=this.materialAsset.resource),this.timer=1/this.frameRate,this.frame=this.startFrame,this.uniform0=[0,0,0],this.uniform1=[0,0,0],this.updateMaterial(this.frame)},AnimatedTexture.prototype.update=function(t){this.timer-=t,this.timer<0&&(this.frame++,this.frame>=this.numFrames+this.startFrame&&(this.frame=this.startFrame),this.updateMaterial(this.frame),this.timer=1/this.frameRate)},AnimatedTexture.prototype.updateMaterial=function(t){var e=1/this.width,r=1/this.height,i=t%this.width*e,a=Math.floor(t/this.width)*r,s=this.entity.model.meshInstances;this.uniform0[0]=e,this.uniform0[1]=0,this.uniform0[2]=i,this.uniform1[0]=0,this.uniform1[1]=r,this.uniform1[2]=a,s[0].setParameter("texture_diffuseMapTransform0",this.uniform0),s[0].setParameter("texture_diffuseMapTransform1",this.uniform1),s[0].setParameter("texture_emissiveMapTransform0",this.uniform0),s[0].setParameter("texture_emissiveMapTransform1",this.uniform1),s[0].setParameter("texture_opacityMapTransform0",this.uniform0),s[0].setParameter("texture_opacityMapTransform1",this.uniform1)};var Network=pc.createScript("network");Network.attributes.add("near",{type:"number",default:10}),Network.attributes.add("far",{type:"number",default:50}),Network.id=null,Network.socket=null;const makeid=function(e){for(var t="",a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=a.length,n=0;n<e;n++)t+=a.charAt(Math.floor(Math.random()*i));return t};Network.prototype.initialize=function(){var e=this.app;const t=pc.platform.mobile||pc.platform.touch?this.app.root.findByName("Mobile UI"):this.app.root.findByName("Desktop UI");e.loader.getHandler("texture").crossOrigin="anonymous",this.firstLoaded=!1,this.player=e.root.findByName("Player"),this.playerName=this.player.findByName("Name"),this.othersGroup=e.root.findByName("Others Group"),this.others=e.root.findByName("Others"),this.playerScript=this.player.script.player,this.mainPlayerWebCamPlane=this.player.findByName("Face").script.webCamPlane,this.inGameUI=t.findByName("In-game UI"),this.chatPanel=t.findByName("Chat UI"),this.chatContent=this.chatPanel.findByName("Content"),this.webcamUI=t.findByName("Webcam UI"),this.privateRoomUI=t.findByName("Private Room UI"),this.roomMakerUI=t.findByName("Room Maker UI"),this.loginPanel=t.findByName("Login UI"),this.selectionPanel=t.findByName("Selection UI"),this.selectionPanel&&(this.name=this.selectionPanel.findByName("Name"),this.nameInput=this.name.script.input,this.nameTextElement=this.name.findByName("Text").element),this.instructionUI=t.findByName("Instruction UI"),this.game=e.root.findByName("Game"),this.currentRoom="Main",this.roomIdx=null,this.roomType=null,this.haveSpeaker=!1,this.roomMakerName="room1";var a=new URL(window.top.location.href);this.roomMakerChannel=a.searchParams.get("assignments");var i=io.connect("https://leoluca.io");Network.socket=i,this.socket=Network.socket,Network.socket.emit("renewToken",{channel:"Public"});const n=makeid(20);var o=this;i.on("initSocket",(function(e){o.initialSocket(e)})),i.on("initialPlayersData",(function(e){o.initialPlayers(e),console.log("initial Players")})),i.on("playerJoined",(function(e){o.addPlayer(e),console.log("player Joined")})),i.on("playerMoved",(function(e){o.movePlayer(e)})),i.on("playerChatChanged",(function(e){o.changePlayerChat(e)})),i.on("updateChatBox",(function(e){o.updateChatBox(e)})),i.on("loginStatus",(function(e){"success"===e.status?o.loginSuccess(e):o.loginFailed()})),i.on("privateRoomStatus",(function(e){console.log(e),"success"===e.status?o.passcodeSuccess(e):o.passcodeFailed()})),i.on("startGame",(function(e){o.startGame(e)})),i.on("getRoomData",(function(e){e.length>1?(this.roomType="Entrance",o.setupAllTeleports(e)):this.roomType=e.type})),i.on("getToken",(function(e){o.token=e.token,o.firstLoaded||(o.firstLoaded=!0,o.applyToken({channel:n,token:o.token,type:"local"}))})),i.on("publishWebCamToOtherPlayer",(function(e){o.setOtherPlayerWebCamPlane(e)})),i.on("publishScreenToOtherPlayer",(function(e){o.setOtherPlayerShareScreenPlane(e)})),i.on("setMainPlayerSpeakerUID",(function(e){o.setMainPlayerSpeakerUID(e)})),i.on("closeAllPlayersSpeakerScreen",(function(){o.closeAllPlayersScreen()})),i.on("removeAllPlayers",(function(){o.removeAllPlayersEntity(),console.log("remove all Players entity")})),i.on("removePlayer",(function(e){o.removePlayer(e),console.log("remove target player")}));let r=null;e.on("socket:login",(function(e,t){i.emit("login",{email:e,pw:t})}),this),e.on("socket:initData",(function(e,t){i.emit("initData",{id:Network.id,name:e,bodyIdx:t})}),this),e.on("socket:sendPasscode",(function(e){i.emit("enterPrivateRoom",{passcode:e,roomIdx:this.roomIdx})}),this),e.on("socket:sendMessage",(function(e){r&&clearTimeout(r),i.emit("playerChatUpdate",{id:Network.id,chat:e}),i.emit("chatBoxUpdate",{id:Network.id,chat:e}),r=setTimeout((()=>{i.emit("playerChatUpdate",{id:Network.id,chat:""})}),3e3)}),this),e.on("socket:changeRoom",(function(t,a){"Main"===this.currentRoom&&(this.currentRoom="Intro"),window.dataLayer&&window.dataLayer.push({event:"entered_area",event_params:{eventType:"navigation",location:t,entrance:a,previousLocation:this.currentRoom,messageContent:void 0,npcName:void 0,dialoguePage:void 0}}),this.currentRoom=t,"CocaCola"===t||"CocaColaHistory"===t?(e.systems.rigidbody.gravity.y=0,this.player.collision.axis=2,console.log("fly",e.systems.rigidbody.gravity.y),e.fire("PlayAnim:setFlyValue")):(e.systems.rigidbody.gravity.y=-9.81,this.player.collision.axis=1,e.fire("PlayAnim:setFlyValue")),e.fire("ChangeSkybox:onChangeScene",t),e.fire("player:resetBorn"),e.fire("FullmapList:changeScene",t),i.emit("changeRoom",{roomId:t}),i.emit("getRoomData",this.roomIdx)}),this),e.on("socket:setRoomIdx",(function(e){this.roomIdx=e}),this),e.on("socket:speaking",(function(){this.haveSpeaker=!0,i.emit("speaking",{id:Network.id,roomId:this.roomIdx},(function(t){e.fire("podium:success")}))}),this),e.on("socket:stopSpeaking",(function(){this.haveSpeaker=!1,i.emit("stopSpeaking",{id:Network.id,roomId:this.roomIdx},(function(e){e||console.log("Person on stage is not the same as server.")}))}),this),e.on("RoomMaker:setRoomName",(function(e){this.roomMakerName=e,this.app.fire("sceneManager:loadScene","Play","Play Main to Play","Start Point",(function(e,t,a){o.roomMakerUI.enabled=!1,o.inGameUI.enabled=!0}))}),this)},Network.prototype.initialSocket=function(e){Network.id=e.id,this.id=e.id},Network.prototype.initialPlayers=function(e){for(var t in this.players=e.players,this.closeAllPlayersScreen(),e.newRoomId&&(console.log("applyToken",e.newRoomId,this.token),this.applyToken({channel:e.newRoomId,token:this.token,type:"local"})),console.log("initialPlayers",this.players),e.roomId&&(console.log("applyToken",e.roomId,this.token),this.applyToken({channel:e.roomId,token:this.token,type:"local"})),this.players)console.log(t,Network.id),t!=Network.id&&(this.players[t].entity=this.createPlayerEntity(this.players[t]),this.setOtherPlayerWebCamPlane(this.players[t]),this.players[t].isPersenter&&this.setOtherPlayerShareScreenPlane(this.players[t]));this.initialized=!0,this.updatePosition()},Network.prototype.addPlayer=function(e){this.players[e.id]=e,this.players[e.id].entity=this.createPlayerEntity(e)},Network.prototype.createPlayerEntity=function(e){const t=this.others.clone();return console.log("newPlayer",t),t.findByName("Name").element.text=e.name,t.findByName("Avatar").children[e.bodyIdx].enabled=!0,console.log("newPlayer",t.findByName("Avatar").children[e.bodyIdx],e.bodyIdx),t.enabled=!0,this.othersGroup.addChild(t),t},Network.prototype.movePlayer=function(e){if(this.players[e.id]&&this.players[e.id].entity){this.players[e.id].entity.rigidbody.teleport(e.x,e.y,e.z),this.players[e.id].entity.children[0].setEulerAngles(e.rx,e.ry,e.rz);for(let t=0;this.players[e.id].entity.findByName("Avatar").children[t];t++)this.players[e.id].entity.findByName("Avatar").children[t].anim.setFloat("walk",e.walk)}},Network.prototype.removePlayer=function(e){if(this.players[e].entity){var t=this.players[e].entity.findByName("Face").script.webCamRemotePlane;t&&t.leave(),this.players[e].entity.destroy(),this.players[e].entity=null,delete this.players[e]}},Network.prototype.removeAllPlayersEntity=function(){for(var e in this.players)if(this.players[e].entity){const t=this.otherPlayerWebCamPlane({id:e});t&&t.leave(),this.players[e].entity.destroy(),this.players[e].entity=null,delete this.players[e]}},Network.prototype.update=function(e){this.updatePosition()},Network.prototype.updatePosition=function(){if(this.initialized){var e=this.player.getPosition(),t=this.player.children[0].getEulerAngles();let a=100;if("Stage"===this.roomType&&!0===this.haveSpeaker){for(let e in this.players)if(this.players[e].entity){a=!0===this.players[e].speaking?100:0,this.otherPlayerWebCamPlane({id:this.players[e].id}).setVolume(a)}}else for(let t in this.players)if(this.players[t].entity){let i=this.players[t].entity.getPosition(),n=new pc.Vec3;n.sub2(e,i);let o=n.length();a=o>=this.far?0:o<=this.near?100:Math.ceil(100-100*(o-this.near)/(this.far-this.near));let r=this.otherPlayerWebCamPlane({id:this.players[t].id});r&&r.setVolume(a)}Network.socket.emit("positionUpdate",{id:Network.id,x:e.x,y:e.y,z:e.z,rx:t.x,ry:t.y,rz:t.z,walk:this.player.findByName("Avatar").children[0].anim.parameters.walk.value})}},Network.prototype.changePlayerChat=function(e){this.initialized&&(e.id===Network.id&&(this.player.findByName("Chat").element.text=e.chat),this.players[e.id]&&this.players[e.id].entity&&(this.players[e.id].entity.findByName("Chat").element.text=e.chat))},Network.prototype.updateChatBox=function(e){this.chatContent.element.text+=`\n${e.name}: ${e.chat}`;var t=this.chatPanel.findByName("ScrollView"),a=t.scrollview._prevContentSizes[1];if(a>t.element.height){var i=a-t.element.height;t.scrollview._onSetScroll(0,i,!1)}},Network.prototype.updateSelfName=function(e){this.player.findByName("Name").element.text=e},Network.prototype.loginSuccess=function(e){this.loginPanel.enabled=!1,this.webcamUI.enabled=!0,this.selectionPanel?(this.selectionPanel.enabled=!0,this.nameInput.clean(),this.nameInput.input.value=e.displayName,this.nameTextElement.text=e.displayName):Network.socket.emit("initData",{id:Network.id,name:"unnamed",bodyIdx:0}),this.app.fire("player:set","type",e.type),console.log("login success")},Network.prototype.loginFailed=function(){this.app.fire("submit:fail")},Network.prototype.passcodeSuccess=function(e){const t=this;this.app.fire("sceneManager:loadScene",e.roomId,"Atrium to Priv Room","Start Point",(function(e,a,i){t.privateRoomUI.enabled=!1})),console.log("passcode success")},Network.prototype.passcodeFailed=function(){this.app.fire("numpad:shake"),this.app.fire("submit:fail")},Network.prototype.setupAllTeleports=function(e){const t=this.app.root.findByName("Teleports").children;for(let a=0,i=t.length;a<i;a++){const i=e[a],n=t[a].children[0],o=t[a].children[1].children,r=n.model.material;if(this.mapRoom=this.app.root.findByName("Map Room").children,i.isEnabled){t[a].name=i.type,n.name=i.type,r.emissive.set(i.color.r,i.color.g,i.color.b);const e=this.app.assets.find(i.type,"sprite");this.mapRoom[a].script.makeMapIcon.iconImage=e,this.mapRoom[a].script.makeMapIcon.enabled=!0;for(let e=0,t=o.length;e<t;e++)o[e].element.text=i.type}else{n.tags.add("locked"),r.emissive.set(1,0,0),this.mapRoom[a].script.makeMapIcon.enabled=!1;for(let e=0,t=o.length;e<t;e++)o[e].element.text=""}r.update()}},Network.prototype.startGame=function(e){const t=this.app;this.selectionPanel&&(this.selectionPanel.enabled=!1),this.updateSelfName(e.name),console.log("Before Load"),t.fire("sceneManager:loadScene","Play","Play Main to Play(Login)","Start Point",(function(e,t,a){console.log("start game")}))},Network.prototype.setOtherPlayerWebCamPlane=function(e){const t=this.otherPlayerWebCamPlane(e);t&&(t.uid=e.webCamUID,this.applyToken({id:e.id,channel:e.roomId,token:this.token,type:"remote"}))},Network.prototype.setOtherPlayerShareScreenPlane=function(e){const t=this.app;t.root.findByName("MainScreen")&&(this.mainPlayershareScreenPlane||(this.mainPlayershareScreenPlane=t.root.findByName("MainScreen").script.shareScreenPlane),this.mainPlayerSpeakerScreens||(this.mainPlayerSpeakerScreens=t.root.findByName("SpeakerScreens").children),this.mainPlayershareScreenPlane.uid=e.shareScreenUID,this.setMainPlayerSpeakerUID(e),this.applyToken({channel:e.roomId,token:this.token,type:"remoteScreen"}))},Network.prototype.setMainPlayerSpeakerUID=function(e){const t=this.app;if(!this.mainPlayerSpeakerScreens&&t.root.findByName("SpeakerScreens")&&(this.mainPlayerSpeakerScreens=t.root.findByName("SpeakerScreens").children),this.mainPlayerSpeakerScreens){for(var a=0,i=this.mainPlayerSpeakerScreens.length;a<i;a++){this.mainPlayerSpeakerScreens[a].script.speakerScreenPlane.uid=e.webCamUID}this.applyToken({channel:e.roomId,token:this.token,type:"speakerScreen"})}},Network.prototype.applyToken=function(e){switch(e.type){case"local":this.mainPlayerWebCamPlane.initAgora(e.channel,e.token);break;case"remote":const t=this.otherPlayerWebCamPlane(e);t&&t.initAgora(e.channel,e.token);break;case"speakerScreen":default:break;case"localScreen":this.mainPlayershareScreenPlane||(this.mainPlayershareScreenPlane=this.app.root.findByName("MainScreen").script.shareScreenPlane);const a=!1;this.mainPlayershareScreenPlane.initAgora(e.channel,e.token,a);break;case"remoteScreen":const i=!0;this.mainPlayershareScreenPlane.initAgora(e.channel,e.token,i)}},Network.prototype.closeAllPlayersScreen=function(){if(this.mainPlayershareScreenPlane&&this.mainPlayershareScreenPlane.leave(),this.mainPlayerSpeakerScreens)for(var e=0,t=this.mainPlayerSpeakerScreens.length;e<t;e++){this.mainPlayerSpeakerScreens[e].script.speakerScreenPlane.leave()}},Network.prototype.otherPlayerWebCamPlane=function(e){return!!this.players[e.id].entity&&this.players[e.id].entity.findByName("Face").script.webCamRemotePlane};Object.assign(window,function(){function nearestPow2(e){return Math.pow(2,Math.round(Math.log(e)/Math.log(2)))}function isPowerOf2(e){return e&&0==(e&e-1)}function getFilter(e){var r=pc.FILTER_LINEAR;switch(e){case 9728:r=pc.FILTER_NEAREST;break;case 9729:r=pc.FILTER_LINEAR;break;case 9984:r=pc.FILTER_NEAREST_MIPMAP_NEAREST;break;case 9985:r=pc.FILTER_LINEAR_MIPMAP_NEAREST;break;case 9986:r=pc.FILTER_NEAREST_MIPMAP_LINEAR;break;case 9987:r=pc.FILTER_LINEAR_MIPMAP_LINEAR}return r}function getWrap(e){var r=pc.ADDRESS_REPEAT;switch(e){case 33071:r=pc.ADDRESS_CLAMP_TO_EDGE;break;case 33648:r=pc.ADDRESS_MIRRORED_REPEAT;break;case 10497:r=pc.ADDRESS_REPEAT}return r}function isDataURI(e){return/^data:.*,.*$/i.test(e)}function getAccessorData(e,r,s){var t=e.bufferViews[r.bufferView],a=s[t.buffer],n=(r.hasOwnProperty("byteOffset")?r.byteOffset:0)+(t.hasOwnProperty("byteOffset")?t.byteOffset:0),o=r.count*function getAccessorTypeSize(e){var r=3;switch(e){case"SCALAR":r=1;break;case"VEC2":r=2;break;case"VEC3":r=3;break;case"VEC4":case"MAT2":r=4;break;case"MAT3":r=9;break;case"MAT4":r=16}return r}(r.type),i=null;switch(r.componentType){case 5120:i=new Int8Array(a,n,o);break;case 5121:i=new Uint8Array(a,n,o);break;case 5122:i=new Int16Array(a,n,o);break;case 5123:i=new Uint16Array(a,n,o);break;case 5125:i=new Uint32Array(a,n,o);break;case 5126:i=new Float32Array(a,n,o)}return i}function translateAnimation(e,r){var s=new AnimationClip;s.loop=!0,e.hasOwnProperty("name")&&(s.name=e.name);var t=r.gltf;return e.channels.forEach((function(a){var n,o,i,c,p,f,l,u,d=e.samplers[a.sampler],h=getAccessorData(t,t.accessors[d.input],r.buffers),w=getAccessorData(t,t.accessors[d.output],r.buffers),O=a.target,y=O.path,T=r.nodes[O.node];if("weights"===y){var m=w.length/h.length;for(l=0;l<m;l++){for(p=new AnimationCurve,f=AnimationKeyableType.NUM,p.keyableType=f,p.addTarget("model",y,l),"CUBIC"===d.interpolation?p.type=AnimationCurveType.CUBIC:"STEP"===d.interpolation&&(p.type=AnimationCurveType.STEP),u=0;u<h.length;u++)n=h[u],o=w[m*u+l],p.insertKey(f,n,o);s.addCurve(p)}}else{f=AnimationKeyableType.NUM;var E=y;switch(y){case"translation":f=AnimationKeyableType.VEC,E="localPosition";break;case"scale":f=AnimationKeyableType.VEC,E="localScale";break;case"rotation":f=AnimationKeyableType.QUAT,E="localRotation"}(p=new AnimationCurve).keyableType=f,p.setTarget(T,E),"CUBIC"===d.interpolation?p.type=AnimationCurveType.CUBIC:"STEP"===d.interpolation?p.type=AnimationCurveType.STEP:"CUBICSPLINE"===d.interpolation&&(p.type=AnimationCurveType.CUBICSPLINE_GLTF);var P,M=[];if("CUBICSPLINE"===d.interpolation)for(l=0;l<h.length;l++)n=h[l],"translation"===y||"scale"===y?(i=new pc.Vec3(w[9*l+0],w[9*l+1],w[9*l+2]),o=new pc.Vec3(w[9*l+3],w[9*l+4],w[9*l+5]),c=new pc.Vec3(w[9*l+6],w[9*l+7],w[9*l+8])):"rotation"===y?(i=new pc.Quat(w[12*l+0],w[12*l+1],w[12*l+2],w[12*l+3]),o=new pc.Quat(w[12*l+4],w[12*l+5],w[12*l+6],w[12*l+7]),c=new pc.Quat(w[12*l+8],w[12*l+9],w[12*l+10],w[12*l+11])):(i=w[3*l],o=w[3*l+1],c=w[3*l+2]),(P=new AnimationKeyable(f,n,o)).inTangent=i,P.outTangent=c,M.push(P);else for(l=0;l<h.length;l++)n=h[l],o="translation"===y||"scale"===y?new pc.Vec3(w[3*l+0],w[3*l+1],w[3*l+2]):"rotation"===y?new pc.Quat(w[4*l+0],w[4*l+1],w[4*l+2],w[4*l+3]):w[l],P=new AnimationKeyable(f,n,o),M.push(P);p.animKeys=M,p.duration=n,s.addCurve(p)}})),e.hasOwnProperty("extras")&&r.processAnimationExtras&&r.processAnimationExtras(s,e.extras),s}function translateImage(e,r,s){var t=new Image,onLoad=function(){t.removeEventListener("load",onLoad,!1);var e=r.gltf,a=r.images.indexOf(t);e.textures.forEach((function(e,s){if(e.hasOwnProperty("source")&&e.source===a){var n=r.textures[s];if(isPowerOf2(t.width)&&isPowerOf2(t.width)||n.addressU!==pc.ADDRESS_REPEAT&&n.addressU!==pc.ADDRESS_MIRRORED_REPEAT&&n.addressV!==pc.ADDRESS_REPEAT&&n.addressV!==pc.ADDRESS_MIRRORED_REPEAT&&n.minFilter!==pc.FILTER_LINEAR_MIPMAP_LINEAR&&n.minFilter!==pc.FILTER_NEAREST_MIPMAP_LINEAR&&n.minFilter!==pc.FILTER_LINEAR_MIPMAP_NEAREST&&n.minFilter!==pc.FILTER_NEAREST_MIPMAP_NEAREST)n.setSource(t);else{var o=new Image;o.addEventListener("load",(function(){n.setSource(o)})),o.src=function resampleImage(e){var r=e.width,s=e.height,t=nearestPow2(r),a=nearestPow2(s),n=document.createElement("canvas");return n.width=t,n.height=a,n.getContext("2d").drawImage(e,0,0,r,s,0,0,t,a),n.toDataURL()}(t)}}})),r.imagesLoaded++,r.imagesLoaded===e.images.length&&s()};if(t.addEventListener("load",onLoad,!1),e.hasOwnProperty("uri")&&(isDataURI(e.uri)?t.src=e.uri:r.processUri?r.processUri(e.uri,(function(e){t.crossOrigin="anonymous",t.src=e})):(t.crossOrigin="anonymous",t.src=r.basePath+e.uri)),e.hasOwnProperty("bufferView")){var a=r.gltf,n=r.buffers,o=a.bufferViews[e.bufferView],i=n[o.buffer],c=o.hasOwnProperty("byteOffset")?o.byteOffset:0,p=i.slice(c,c+o.byteLength),f=new Blob([p],{type:e.mimeType});t.src=URL.createObjectURL(f)}return t}var e=["#ifdef MAPFLOAT","uniform float material_shininess;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_glossMap;","#endif","","void getGlossiness() {","    dGlossiness = 1.0;","","#ifdef MAPFLOAT","    dGlossiness *= material_shininess;","#endif","","#ifdef MAPTEXTURE","    dGlossiness *= texture2D(texture_glossMap, $UV).$CH;","#endif","","#ifdef MAPVERTEX","    dGlossiness *= saturate(vVertexColor.$VC);","#endif","","    dGlossiness = 1.0 - dGlossiness;","","    dGlossiness += 0.0000001;","}"].join("\n"),r=["#ifdef MAPCOLOR","uniform vec3 material_specular;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_specularMap;","#endif","","void getSpecularity() {","    dSpecularity = vec3(1.0);","","    #ifdef MAPCOLOR","        dSpecularity *= material_specular;","    #endif","","    #ifdef MAPTEXTURE","        vec3 srgb = texture2D(texture_specularMap, $UV).$CH;","        dSpecularity *= vec3(pow(srgb.r, 2.2), pow(srgb.g, 2.2), pow(srgb.b, 2.2));","    #endif","","    #ifdef MAPVERTEX","        dSpecularity *= saturate(vVertexColor.$VC);","    #endif","}"].join("\n");function translateMaterial(s,t){console.log("translateMaterial",s);var a,n,o=new pc.StandardMaterial;if(o.occludeSpecular=!0,o.diffuseTint=!0,o.diffuseVertexColor=!0,o.specularTint=!0,o.specularVertexColor=!0,o.useSkybox=!1,o.alphaToCoverage=!0,s.hasOwnProperty("name")&&(o.name=s.name),s.hasOwnProperty("extensions")&&s.extensions.hasOwnProperty("KHR_materials_unlit")&&(o.useLighting=!1),s.hasOwnProperty("extensions")&&s.extensions.hasOwnProperty("KHR_materials_pbrSpecularGlossiness")){var i=s.extensions.KHR_materials_pbrSpecularGlossiness;if(i.hasOwnProperty("diffuseFactor")?(a=i.diffuseFactor,o.diffuse.set(Math.pow(a[0],1/2.2),Math.pow(a[1],1/2.2),Math.pow(a[2],1/2.2)),o.opacity=null!=a[3]?a[3]:1):(o.diffuse.set(1,1,1),o.opacity=1),i.hasOwnProperty("diffuseTexture")){var c=i.diffuseTexture;if(n=t.textures[c.index],o.diffuseMap=n,o.diffuseMapChannel="rgb",o.opacityMap=n,o.opacityMapChannel="a",c.hasOwnProperty("texCoord")&&(o.diffuseMapUv=c.texCoord,o.opacityMapUv=c.texCoord),c.hasOwnProperty("extensions")&&c.extensions.hasOwnProperty("KHR_texture_transform")){var p=c.extensions.KHR_texture_transform;p.hasOwnProperty("scale")&&(o.diffuseMapTiling=new pc.Vec2(p.scale[0],p.scale[1]),o.opacityMapTiling=new pc.Vec2(p.scale[0],p.scale[1])),p.hasOwnProperty("offset")&&(o.diffuseMapOffset=new pc.Vec2(p.offset[0],p.offset[1]),o.opacityMapOffset=new pc.Vec2(p.offset[0],p.offset[1]))}}if(o.useMetalness=!1,i.hasOwnProperty("specularFactor")?(a=i.specularFactor,o.specular.set(Math.pow(a[0],1/2.2),Math.pow(a[1],1/2.2),Math.pow(a[2],1/2.2))):o.specular.set(1,1,1),i.hasOwnProperty("glossinessFactor")?o.shininess=100*i.glossinessFactor:o.shininess=100,i.hasOwnProperty("specularGlossinessTexture")){var f=i.specularGlossinessTexture;if(o.specularMap=t.textures[f.index],o.specularMapChannel="rgb",o.glossMap=t.textures[f.index],o.glossMapChannel="a",f.hasOwnProperty("texCoord")&&(o.glossMapUv=f.texCoord,o.metalnessMapUv=f.texCoord),f.hasOwnProperty("extensions")&&f.extensions.hasOwnProperty("KHR_texture_transform")){var l=f.extensions.KHR_texture_transform;l.hasOwnProperty("scale")&&(o.glossMapTiling=new pc.Vec2(l.scale[0],l.scale[1]),o.metalnessMapTiling=new pc.Vec2(l.scale[0],l.scale[1])),l.hasOwnProperty("offset")&&(o.glossMapOffset=new pc.Vec2(l.offset[0],l.offset[1]),o.metalnessMapOffset=new pc.Vec2(l.offset[0],l.offset[1]))}}o.chunks.specularPS=r}else if(s.hasOwnProperty("pbrMetallicRoughness")){var u=s.pbrMetallicRoughness;if(u.hasOwnProperty("baseColorFactor")?(a=u.baseColorFactor,o.diffuse.set(Math.pow(a[0],1/2.2),Math.pow(a[1],1/2.2),Math.pow(a[2],1/2.2)),o.opacity=a[3]):(o.diffuse.set(1,1,1),o.opacity=1),u.hasOwnProperty("baseColorTexture")){var d=u.baseColorTexture;if(n=t.textures[d.index],o.diffuseMap=n,o.diffuseMapChannel="rgb",o.opacityMap=n,o.opacityMapChannel="a",d.hasOwnProperty("texCoord")&&(o.diffuseMapUv=d.texCoord,o.opacityMapUv=d.texCoord),d.hasOwnProperty("extensions")&&d.extensions.hasOwnProperty("KHR_texture_transform")){var h=d.extensions.KHR_texture_transform;h.hasOwnProperty("scale")&&(o.diffuseMapTiling=new pc.Vec2(h.scale[0],h.scale[1]),o.opacityMapTiling=new pc.Vec2(h.scale[0],h.scale[1])),h.hasOwnProperty("offset")&&(o.diffuseMapOffset=new pc.Vec2(h.offset[0],h.offset[1]),o.opacityMapOffset=new pc.Vec2(h.offset[0],h.offset[1]))}}if(o.useMetalness=!0,u.hasOwnProperty("metallicFactor")?(o.metalness=.1*u.metallicFactor,0!==o.metalness&&(o.useSkybox=!0)):o.metalness=0,u.hasOwnProperty("roughnessFactor")?o.shininess=100*u.roughnessFactor:o.shininess=100,u.hasOwnProperty("metallicRoughnessTexture")){var w=u.metallicRoughnessTexture;if(o.metalnessMap=t.textures[w.index],o.metalnessMapChannel="b",o.glossMap=t.textures[w.index],o.glossMapChannel="g",w.hasOwnProperty("texCoord")&&(o.glossMapUv=w.texCoord,o.metalnessMapUv=w.texCoord),w.hasOwnProperty("extensions")&&w.extensions.hasOwnProperty("KHR_texture_transform")){var O=w.extensions.KHR_texture_transform;O.hasOwnProperty("scale")&&(o.glossMapTiling=new pc.Vec2(O.scale[0],O.scale[1]),o.metalnessMapTiling=new pc.Vec2(O.scale[0],O.scale[1])),O.hasOwnProperty("offset")&&(o.glossMapOffset=new pc.Vec2(O.offset[0],O.offset[1]),o.metalnessMapOffset=new pc.Vec2(O.offset[0],O.offset[1]))}}o.chunks.glossPS=e}if(s.hasOwnProperty("normalTexture")){var y=s.normalTexture;if(o.normalMap=t.textures[y.index],y.hasOwnProperty("texCoord")&&(o.normalMapUv=y.texCoord),y.hasOwnProperty("extensions")&&y.extensions.hasOwnProperty("KHR_texture_transform")){var T=y.extensions.KHR_texture_transform;T.hasOwnProperty("scale")&&(o.normalMapTiling=new pc.Vec2(T.scale[0],T.scale[1])),T.hasOwnProperty("offset")&&(o.normalMapOffset=new pc.Vec2(T.offset[0],T.offset[1]))}y.hasOwnProperty("scale")&&(o.bumpiness=y.scale)}if(s.hasOwnProperty("occlusionTexture")){var m=s.occlusionTexture;if(o.aoMap=t.textures[m.index],o.aoMapChannel="r",m.hasOwnProperty("texCoord")&&(o.aoMapUv=m.texCoord),m.hasOwnProperty("extensions")&&m.extensions.hasOwnProperty("KHR_texture_transform")){var E=m.extensions.KHR_texture_transform;E.hasOwnProperty("scale")&&(o.aoMapTiling=new pc.Vec2(E.scale[0],E.scale[1])),E.hasOwnProperty("offset")&&(o.aoMapOffset=new pc.Vec2(E.offset[0],E.offset[1]))}}if(s.hasOwnProperty("emissiveFactor")?(a=s.emissiveFactor,o.emissive.set(Math.pow(a[0],1/2.2),Math.pow(a[1],1/2.2),Math.pow(a[2],1/2.2)),o.emissiveTint=!0):(o.emissive.set(0,0,0),o.emissiveTint=!1),s.hasOwnProperty("emissiveTexture")){var P=s.emissiveTexture;if(o.emissiveMap=t.textures[P.index],P.hasOwnProperty("texCoord")&&(o.emissiveMapUv=P.texCoord),P.hasOwnProperty("extensions")&&P.extensions.hasOwnProperty("KHR_texture_transform")){var M=P.extensions.KHR_texture_transform;M.hasOwnProperty("scale")&&(o.emissiveMapTiling=new pc.Vec2(M.scale[0],M.scale[1])),M.hasOwnProperty("offset")&&(o.emissiveMapOffset=new pc.Vec2(M.offset[0],M.offset[1]))}}if(s.hasOwnProperty("alphaMode"))switch(s.alphaMode){case"MASK":o.blendType=pc.BLEND_NONE,s.hasOwnProperty("alphaCutoff")?o.alphaTest=s.alphaCutoff:o.alphaTest=.5;break;case"BLEND":o.blendType=pc.BLEND_NORMAL;break;default:o.blendType=pc.BLEND_NONE}else o.blendType=pc.BLEND_NONE;return s.hasOwnProperty("doubleSided")?(o.twoSidedLighting=s.doubleSided,o.cull=s.doubleSided?pc.CULLFACE_NONE:pc.CULLFACE_BACK):(o.twoSidedLighting=!1,o.cull=pc.CULLFACE_BACK),s.hasOwnProperty("extras")&&t.processMaterialExtras&&t.processMaterialExtras(o,s.extras),o.update(),o}function translateMesh(e,r){var s=r.gltf,t=[];return e.primitives.forEach((function(e){var a,n,o=e.attributes,i=null,c=null,p=null,f=null,l=null,u=null,d=null,h=null,w=null;if(e.hasOwnProperty("extensions")){var O=e.extensions;if(O.hasOwnProperty("KHR_draco_mesh_compression")){var y=O.KHR_draco_mesh_compression,T=s.bufferViews[y.bufferView],m=r.buffers[T.buffer],E=T.hasOwnProperty("byteOffset")?T.byteOffset:0,P=new Int8Array(m,E,T.byteLength),M=r.decoderModule,A=new M.DecoderBuffer;A.Init(P,P.length);var g,I,v=new M.Decoder,_=v.GetEncodedGeometryType(A);switch(_){case M.INVALID_GEOMETRY_TYPE:console.error("Invalid geometry type");break;case M.POINT_CLOUD:g=new M.PointCloud,I=v.DecodeBufferToPointCloud(A,g);break;case M.TRIANGULAR_MESH:g=new M.Mesh,I=v.DecodeBufferToMesh(A,g)}if(!I.ok()||0==g.ptr){var x=I.error_msg();console.error(x)}var b=g.num_points(),R=g.num_faces();if(y.hasOwnProperty("attributes")){var extractAttribute=function(e){var r=v.GetAttributeByUniqueId(g,e),s=new M.DracoFloat32Array;v.GetAttributeFloatForAllPoints(g,r,s);var t=b*r.num_components(),n=new Float32Array(t);for(a=0;a<t;a++)n[a]=s.GetValue(a);return M.destroy(s),n},C=y.attributes;C.hasOwnProperty("POSITION")&&(i=extractAttribute(C.POSITION)),C.hasOwnProperty("NORMAL")&&(c=extractAttribute(C.NORMAL)),C.hasOwnProperty("TANGENT")&&(p=extractAttribute(C.TANGENT)),C.hasOwnProperty("TEXCOORD_0")&&(f=extractAttribute(C.TEXCOORD_0)),C.hasOwnProperty("TEXCOORD_1")&&(l=extractAttribute(C.TEXCOORD_1)),C.hasOwnProperty("COLOR_0")&&(u=extractAttribute(C.COLOR_0)),C.hasOwnProperty("JOINTS_0")&&(d=extractAttribute(C.JOINTS_0)),C.hasOwnProperty("WEIGHTS_0")&&(h=extractAttribute(C.WEIGHTS_0))}if(_==M.TRIANGULAR_MESH){var N=new M.DracoInt32Array;for(w=b>65535?new Uint32Array(3*R):new Uint16Array(3*R),a=0;a<R;++a)v.GetFaceFromMesh(g,a,N),w[3*a]=N.GetValue(0),w[3*a+1]=N.GetValue(1),w[3*a+2]=N.GetValue(2);M.destroy(N)}M.destroy(g),M.destroy(v),M.destroy(A)}}o.hasOwnProperty("POSITION")&&null===i&&(n=s.accessors[e.attributes.POSITION],i=getAccessorData(s,n,r.buffers)),o.hasOwnProperty("NORMAL")&&null===c&&(n=s.accessors[e.attributes.NORMAL],c=getAccessorData(s,n,r.buffers)),o.hasOwnProperty("TANGENT")&&null===p&&(n=s.accessors[e.attributes.TANGENT],p=getAccessorData(s,n,r.buffers)),o.hasOwnProperty("TEXCOORD_0")&&null===f&&(n=s.accessors[e.attributes.TEXCOORD_0],f=getAccessorData(s,n,r.buffers)),o.hasOwnProperty("TEXCOORD_1")&&null===l&&(n=s.accessors[e.attributes.TEXCOORD_1],l=getAccessorData(s,n,r.buffers)),o.hasOwnProperty("COLOR_0")&&null===u&&(n=s.accessors[e.attributes.COLOR_0],u=getAccessorData(s,n,r.buffers)),o.hasOwnProperty("JOINTS_0")&&null===d&&(n=s.accessors[e.attributes.JOINTS_0],d=getAccessorData(s,n,r.buffers)),o.hasOwnProperty("WEIGHTS_0")&&null===h&&(n=s.accessors[e.attributes.WEIGHTS_0],h=getAccessorData(s,n,r.buffers)),e.hasOwnProperty("indices")&&null===w&&(n=s.accessors[e.indices],w=getAccessorData(s,n,r.buffers));var S=i.length/3;null!==i&&null===c&&(c=pc.calculateNormals(i,null===w?function(){var e=new Uint16Array(S);for(a=0;a<S;a++)e[a]=a;return e}():w));var L=[];i&&L.push({semantic:pc.SEMANTIC_POSITION,components:3,type:pc.TYPE_FLOAT32}),c&&L.push({semantic:pc.SEMANTIC_NORMAL,components:3,type:pc.TYPE_FLOAT32}),p&&L.push({semantic:pc.SEMANTIC_TANGENT,components:4,type:pc.TYPE_FLOAT32}),f&&L.push({semantic:pc.SEMANTIC_TEXCOORD0,components:2,type:pc.TYPE_FLOAT32}),l&&L.push({semantic:pc.SEMANTIC_TEXCOORD1,components:2,type:pc.TYPE_FLOAT32}),u&&L.push({semantic:pc.SEMANTIC_COLOR,components:4,type:pc.TYPE_UINT8,normalize:!0}),d&&L.push({semantic:pc.SEMANTIC_BLENDINDICES,components:4,type:pc.TYPE_UINT8}),h&&L.push({semantic:pc.SEMANTIC_BLENDWEIGHT,components:4,type:pc.TYPE_FLOAT32});var D,U,V,F,k,G=new pc.VertexFormat(r.device,L),B=new pc.VertexBuffer(r.device,G,S,pc.BUFFER_STATIC),H=B.lock(),K=new Float32Array(H),X=new Uint8Array(H),getAttribute=function(e){var r=G.elements;for(a=0;a<r.length;a++)if(r[a].name===e)return r[a];return null};if(null!==i)for(F=(V=getAttribute(pc.SEMANTIC_POSITION)).offset/4,k=V.stride/4,a=0;a<S;a++)U=3*a,K[D=F+a*k]=i[U],K[D+1]=i[U+1],K[D+2]=i[U+2];if(null!==c)for(F=(V=getAttribute(pc.SEMANTIC_NORMAL)).offset/4,k=V.stride/4,a=0;a<S;a++)U=3*a,K[D=F+a*k]=c[U],K[D+1]=c[U+1],K[D+2]=c[U+2];if(null!==p)for(F=(V=getAttribute(pc.SEMANTIC_TANGENT)).offset/4,k=V.stride/4,a=0;a<S;a++)U=4*a,K[D=F+a*k]=p[U],K[D+1]=p[U+1],K[D+2]=p[U+2],K[D+3]=p[U+3];if(null!==f)for(F=(V=getAttribute(pc.SEMANTIC_TEXCOORD0)).offset/4,k=V.stride/4,a=0;a<S;a++)U=2*a,K[D=F+a*k]=f[U],K[D+1]=f[U+1];if(null!==l)for(F=(V=getAttribute(pc.SEMANTIC_TEXCOORD1)).offset/4,k=V.stride/4,a=0;a<S;a++)U=2*a,K[D=F+a*k]=l[U],K[D+1]=l[U+1];if(null!==u)for(F=(V=getAttribute(pc.SEMANTIC_COLOR)).offset,k=V.stride,n=s.accessors[e.attributes.COLOR_0],a=0;a<S;a++){D=F+a*k;var Y=u[U="VEC4"===n.type?4*a:3*a],W=u[U+1],$=u[U+2],j=u[U+3];X[D]=Math.round(255*pc.math.clamp(Y,0,1)),X[D+1]=Math.round(255*pc.math.clamp(W,0,1)),X[D+2]=Math.round(255*pc.math.clamp($,0,1)),X[D+3]="VEC4"===n.type?Math.round(255*pc.math.clamp(j,0,1)):255}if(null!==d)for(F=(V=getAttribute(pc.SEMANTIC_BLENDINDICES)).offset,k=V.stride,a=0;a<S;a++)U=4*a,X[D=F+a*k]=d[U],X[D+1]=d[U+1],X[D+2]=d[U+2],X[D+3]=d[U+3];if(null!==h)for(F=(V=getAttribute(pc.SEMANTIC_BLENDWEIGHT)).offset/4,k=V.stride/4,a=0;a<S;a++)U=4*a,K[D=F+a*k]=h[U],K[D+1]=h[U+1],K[D+2]=h[U+2],K[D+3]=h[U+3];B.unlock();var J=new pc.Mesh;if(J.vertexBuffer=B,J.primitive[0].type=function getPrimitiveType(e){var r=pc.PRIMITIVE_TRIANGLES;if(e.hasOwnProperty("mode"))switch(e.mode){case 0:r=pc.PRIMITIVE_POINTS;break;case 1:r=pc.PRIMITIVE_LINES;break;case 2:r=pc.PRIMITIVE_LINELOOP;break;case 3:r=pc.PRIMITIVE_LINESTRIP;break;case 4:r=pc.PRIMITIVE_TRIANGLES;break;case 5:r=pc.PRIMITIVE_TRISTRIP;break;case 6:r=pc.PRIMITIVE_TRIFAN}return r}(e),J.primitive[0].base=0,J.primitive[0].indexed=null!==w,null!==w){var Q;Q=w instanceof Uint8Array?pc.INDEXFORMAT_UINT8:w instanceof Uint16Array?pc.INDEXFORMAT_UINT16:pc.INDEXFORMAT_UINT32;var q=w.length,z=new pc.IndexBuffer(r.device,Q,q,pc.BUFFER_STATIC,w);J.indexBuffer[0]=z,J.primitive[0].count=w.length}else J.primitive[0].count=S;J.materialIndex=e.material;var Z=(n=s.accessors[e.attributes.POSITION]).min,ee=n.max,re=new pc.BoundingBox(new pc.Vec3((ee[0]+Z[0])/2,(ee[1]+Z[1])/2,(ee[2]+Z[2])/2),new pc.Vec3((ee[0]-Z[0])/2,(ee[1]-Z[1])/2,(ee[2]-Z[2])/2));if(J.aabb=re,e.hasOwnProperty("targets")){var se=[];e.targets.forEach((function(e){var t={};e.hasOwnProperty("POSITION")&&(n=s.accessors[e.POSITION],t.deltaPositions=getAccessorData(s,n,r.buffers)),e.hasOwnProperty("NORMAL")&&(n=s.accessors[e.NORMAL],t.deltaNormals=getAccessorData(s,n,r.buffers)),e.hasOwnProperty("TANGENT")&&(n=s.accessors[e.TANGENT],t.deltaTangents=getAccessorData(s,n,r.buffers)),se.push(new pc.MorphTarget(t))})),J.morph=new pc.Morph(se)}t.push(J)})),t}var s=new pc.Mat4,t=new pc.Vec3;function translateNode(e,r){var a=new pc.GraphNode;if(e.hasOwnProperty("name")?a.name=e.name+r.nodeCounter:a.name="Node "+r.nodeCounter,e.hasOwnProperty("matrix")&&(s.data.set(e.matrix),s.getTranslation(t),a.setLocalPosition(t),s.getEulerAngles(t),a.setLocalEulerAngles(t),s.getScale(t),a.setLocalScale(t)),e.hasOwnProperty("rotation")){var n=e.rotation;a.setLocalRotation(n[0],n[1],n[2],n[3])}if(e.hasOwnProperty("translation")){var o=e.translation;a.setLocalPosition(o[0],o[1],o[2])}if(e.hasOwnProperty("scale")){var i=e.scale;a.setLocalScale(i[0],i[1],i[2])}return r.nodeCounter++,a}function translateSkin(e,r){var s,t,a,n=r.gltf,o=e.joints,i=o.length,c=[];if(e.hasOwnProperty("inverseBindMatrices")){var p=e.inverseBindMatrices,f=getAccessorData(n,n.accessors[p],r.buffers),l=[];for(s=0;s<i;s++){for(t=0;t<16;t++)l[t]=f[16*s+t];(a=new pc.Mat4).set(l),c.push(a)}}else for(s=0;s<i;s++)a=new pc.Mat4,c.push(a);var u=[];for(s=0;s<i;s++)u[s]=r.nodes[o[s]].name;var d=e.skeleton,h=new pc.Skin(r.device,c,u);for(h.skeleton=r.nodes[d],h.bones=[],s=0;s<o.length;s++)h.bones[s]=r.nodes[o[s]];return h}function translateTexture(e,r){var s=new pc.Texture(r.device,{flipY:!1});if(e.hasOwnProperty("name")&&(s.name=e.name),e.hasOwnProperty("sampler")){var t=r.gltf.samplers[e.sampler];t.hasOwnProperty("minFilter")&&(s.minFilter=getFilter(t.minFilter)),t.hasOwnProperty("magFilter")&&(s.magFilter=getFilter(t.magFilter)),t.hasOwnProperty("wrapS")&&(s.addressU=getWrap(t.wrapS)),t.hasOwnProperty("wrapT")&&(s.addressV=getWrap(t.wrapT))}return s}function parse(e,r,s,t){if(t){if(!s.gltf.hasOwnProperty(e))return void t();if(0===s.gltf[e].length)return void t()}s.gltf.hasOwnProperty(e)&&(s[e]=s.gltf[e].map((function(e){return r(e,s,t)})))}function createModel(e){var r=e.gltf,s=[],t=[],a=[];r.nodes.forEach((function(r,n){r.hasOwnProperty("mesh")&&e.meshes[r.mesh].forEach((function(o){var i;i=void 0===o.materialIndex?e.defaultMaterial:e.materials[o.materialIndex];var c=new pc.MeshInstance(e.nodes[n],o,i);if(s.push(c),o.morph){var p=new pc.MorphInstance(o.morph);c.morphInstance=p,p.updateBounds(c.mesh),o.weights&&o.weights.forEach((function(e,r){p.setWeight(r,e)})),a.push(p)}if(r.hasOwnProperty("skin")){var f=e.skins[r.skin];o.skin=f;var l=new pc.SkinInstance(f);l.bones=f.bones,c.skinInstance=l,t.push(l)}}))}));var n=new pc.Model,o=function getRoots(e){var r=e.gltf,s=[];if(r.hasOwnProperty("scenes")){var t=0;r.hasOwnProperty("scene")&&(t=r.scene);for(var a=r.scenes[t].nodes,n=0;n<a.length;n++)s.push(e.nodes[a[n]])}else s.push(e.nodes[0]);return s}(e);return 1===o.length?n.graph=o[0]:(n.graph=new pc.GraphNode,o.forEach((function(e){n.graph.addChild(e)}))),n.meshInstances=s,n.morphInstances=a,n.skinInstances=t,n}function loadGltf(e,r,s,t){console.log("gltf");var a=t&&t.hasOwnProperty("buffers")?t.buffers:void 0,n=t&&t.hasOwnProperty("basePath")?t.basePath:void 0,o=t&&t.hasOwnProperty("processUri")?t.processUri:void 0,i=t&&t.hasOwnProperty("processAnimationExtras")?t.processAnimationExtras:void 0,c=t&&t.hasOwnProperty("processMaterialExtras")?t.processMaterialExtras:void 0,p=t&&t.hasOwnProperty("processGlobalExtras")?t.processGlobalExtras:void 0,f={basePath:n,buffers:a,device:r,defaultMaterial:translateMaterial({}),gltf:e,imagesLoaded:0,nodeCounter:0,processUri:o,processAnimationExtras:i,processMaterialExtras:c};e.hasOwnProperty("extensionsUsed")&&-1!==e.extensionsUsed.indexOf("KHR_draco_mesh_compression")&&(f.decoderModule=t.decoderModule),function loadBuffers(e,r){if(e.buffers)r();else{var s=e.gltf;if(e.buffers=[],s.hasOwnProperty("buffers")){var t=0;s.buffers.forEach((function(a,n){if(a.hasOwnProperty("uri"))if(isDataURI(a.uri)){var o=atob(a.uri.split(",")[1]);e.buffers[n]=new ArrayBuffer(o.length);for(var i=new Uint8Array(e.buffers[n]),c=0;c<o.length;c++)i[c]=o.charCodeAt(c);s.buffers.length===++t&&r()}else if(e.processUri)e.processUri(a.uri,(function(a){e.buffers[n]=a,s.buffers.length===++t&&r()}));else{var p=new XMLHttpRequest;p.open("GET",e.basePath+a.uri,!0),p.responseType="arraybuffer",p.onload=function(a){e.buffers[n]=this.response,s.buffers.length===++t&&r()},p.send()}}))}}}(f,(function(){parse("textures",translateTexture,f),parse("images",translateImage,f,(function(){parse("materials",translateMaterial,f),parse("meshes",translateMesh,f),parse("nodes",translateNode,f),parse("skins",translateSkin,f),parse("animations",translateAnimation,f),e.hasOwnProperty("extras")&&p&&p(e.extras),function buildHierarchy(e){e.gltf.nodes.forEach((function(r,s){r.hasOwnProperty("children")&&r.children.forEach((function(r){var t=e.nodes[r];t.parent&&t.parent.removeChild(t),e.nodes[s].addChild(t)}))}))}(f),s(null,{model:createModel(f),textures:f.textures,animations:f.animations}),e.hasOwnProperty("extensionsUsed")&&-1!==e.extensionsUsed.indexOf("KHR_draco_mesh_compression")&&(f.decoderModule=null)}))}))}return{loadGltf:loadGltf,loadGlb:function loadGlb(e,r,s,t){var a=new DataView(e),n=a.getUint32(0,!0);if(1179937895===n){var o=a.getUint32(4,!0);if(2===o){var i=a.getUint32(8,!0),c=a.getUint32(12,!0),p=a.getUint32(16,!0);if(1313821514===p){for(var f=new Uint8Array(e,20,c),l=JSON.parse(function decodeBinaryUtf8(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);for(var r="",s=0,t=e.length;s<t;s++)r+=String.fromCharCode(e[s]);return decodeURIComponent(escape(r))}(f)),u=[],d=20+c;d<i;){if(c=a.getUint32(d,!0),5130562!==(p=a.getUint32(d+4,!0)))return void s("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+p.toString(16));var h=e.slice(d+8,d+8+c);u.push(h),d+=c+8}(t=t||{}).buffers=u,loadGltf(l,r,s,t)}else s("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+p.toString(16))}else s("Invalid version number found in glb header. Expected 2, found "+o)}else s("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+n.toString(16))}}}());var LoadGltfExternal=pc.createScript("loadGltfExternal");LoadGltfExternal.prototype.initialize=function(){this.app;var e=this;const t=pc.platform.mobile||pc.platform.touch?this.app.root.findByName("Mobile UI"):this.app.root.findByName("Desktop UI");this.instructionUI=t.findByName("Instruction UI"),this.inGameUI=t.findByName("In-game UI"),this.progressBar=this.app.root.findByName("Scene Progress Bar"),this.progressBar&&(this.progressBarText=this.progressBar.findByName("Text"));var o=new URL(window.top.location.href);this.roomID=o.searchParams.get("assignments"),console.log("this.roomID",this.roomID),this.matId=0,this.loadJsonFromRemote(`https://play.grwth.hk/assignments/${this.roomID}`,(function(t){e.initDisplay(t),e.loadGLTFFromRemote()}))},LoadGltfExternal.prototype.loadJsonFromRemote=async function(e,t){var o=this,a=new XMLHttpRequest;a.addEventListener("load",(function(){t(JSON.parse(this.response))})),a.open("GET",e),this.progressBar&&(this.progressBar.enabled=!0),a.addEventListener("progress",(function(e){if(e.lengthComputable){var t=e.loaded/e.total;o.progressBarText&&(o.progressBarText.element.text="Loading JSON File: "+Math.round(100*t)+"%"),e.loaded===e.total&&o.progressBar&&(o.progressBar.enabled=!1)}}),!1),a.send()},LoadGltfExternal.prototype.loadGLTFFromRemote=async function(){let e=this;e.progressBar&&(e.progressBar.enabled=!0),e.progressBarText&&(e.progressBarText.element.text="Loading GLTF Model"),this.app.assets.loadFromUrl("https://play.grwth.hk/publishes/"+e.roomID+"/scene.gltf","json",(function(t,o){var a=JSON.parse(o.resource);loadGltf(a,e.app.graphicsDevice,(function(t,o){var a=new pc.Asset("gltf","model",{url:""});a.resource=o.model,a.loaded=!0,e.app.assets.add(a),e.entity.model.model=a.resources[0],console.log(a),e.entity.addComponent("collision"),e.entity.collision.type="mesh",e.entity.collision.model=a.resources[0],e.entity.addComponent("rigidbody"),console.log("loadGltf",e.entity),e.addScript(e.entity.children[0],e.data.object)}),{basePath:e.baseUrl})}))},LoadGltfExternal.prototype.initDisplay=async function(e){this.data=e.json.scene,this.lightArr=[],this.parentPlayData={},this.portalTemp=this.app.root.findByName("Portal Temp")},LoadGltfExternal.prototype.addScript=function(e,t){let o;if(e&&e.children)for(let a=0;e.children[a];a++){for(let t=0;this.entity.model.meshInstances[t];t++)if(this.entity.model.meshInstances[t].node.name===e.children[a].name){this.entity.model.meshInstances[t].material.name=`${e.children[a].name} Material`,o=this.entity.model.meshInstances[t].material;break}console.log(e.children[a].name,o,e.children[a],t.children[a]),e.children[a].children&&this.addScript(e.children[a],t.children[a]),this.checkType(e.children[a],t.children[a],o)}},LoadGltfExternal.prototype.checkType=async function(e,t,o){let a=t.userData;if(a&&a.type&&"Entrance"===a.type){this.app.root.findByName("Enter Portal").setPosition(t.matrix[12],t.matrix[13]+1,t.matrix[14]);let e=new pc.Entity;e=this.portalTemp.clone(),e.name=t.name,e.setPosition(t.matrix[12],t.matrix[13]+1,t.matrix[14]),e.script.makeMapIcon.enabled=!0,e.script.makeMapIcon.addIcon(),this.app.fire("player:teleport",e.getPosition()),console.log("Finish Set Up"),this.progressBar&&(this.progressBar.enabled=!1),this.instructionUI.enabled=!0,this.inGameUI.enabled=!0}else if(a&&a.type&&"Exit"===a.type){this.app.root.findByName("Exit Portal").setPosition(t.matrix[12],t.matrix[13],t.matrix[14]);let e=new pc.Entity;e=this.portalTemp.clone(),e.name=t.name,e.setPosition(t.matrix[12],t.matrix[13]+1,t.matrix[14]),e.script.makeMapIcon.enabled=!0,e.script.makeMapIcon.addIcon()}else if(a&&a.type&&"Portal"===a.type){let e=new pc.Entity;e=this.portalTemp.clone(),e.name=t.name,e.setPosition(t.matrix[12],t.matrix[13]+1,t.matrix[14]),e.script.makeMapIcon.enabled=!0,e.script.makeMapIcon.addIcon()}if(a&&a.play){let i=new pc.Entity;i.addComponent("script"),i.name=`${e.name} Script`,e.addChild(i),i.script.create("rmobjectEvent",{attributes:{onClick:{enabled:!1},audio:{enable:!1}}}),"Presentation"===a.type?"mp4"===a.play.presentation.option&&(console.log(i,o,`https://play.grwth.hk/publishes/${this.roomID}/${t.uuid}/${a.play.presentation.value.sourceFile}`),i.script.create("videoTextureLink",{attributes:{screenMaterial:o,video:`https://play.grwth.hk/publishes/${this.roomID}/${t.uuid}/${a.play.presentation.value.sourceFile}`}})):(a.play.onClick&&"none"!==a.play.onClick.option&&(i.script.rmobjectEvent.onClick.option=a.play.onClick.option,i.script.rmobjectEvent.onClick.value=a.play.onClick.value,i.script.rmobjectEvent.onClick.enable=!0),a.play.audio&&"none"!==a.play.audio.option&&(i.script.rmobjectEvent.audio.option=a.play.audio.option,i.script.rmobjectEvent.audio.value=a.play.audio.value.sourceFile,i.script.rmobjectEvent.audio.enable=!0,await this.createAudio(i,t,a.play.audio)))}},LoadGltfExternal.prototype.createAudio=function(e,t,o){e.addComponent("sound"),console.log(`https://play.grwth.hk/publishes/${this.roomID}/${t.uuid}/${o.value.sourceFile}`);let a=new pc.Asset(`${o.value.sourceFile}`,"audio",{url:`https://play.grwth.hk/publishes/${this.roomID}/${t.uuid}/${o.value.sourceFile}`},null);this.app.assets.add(a),this.app.assets.load(a),"onClick"===o.option&&(e.sound.positional=!1),"range"===o.option&&(e.sound.positional=!0,e.script.create("rangeMusicPlayer",{attributes:{pos:e.getPosition(),maxDistance:10}})),a.on("load",(function(t){e.sound.addSlot(`${o.value.sourceFile}`,{asset:t,loop:"range"===o.option,overlap:!0,autoPlay:"range"===o.option})}))},LoadGltfExternal.prototype.update=function(e){};var PickerFramebuffer=pc.createScript("pickerFramebuffer");PickerFramebuffer.attributes.add("pickAreaScale",{type:"number",title:"Pick Area Scale",description:"1 is more accurate but worse performance. 0.01 is best performance but least accurate. 0.25 is the default.",default:.25,min:.01,max:1}),PickerFramebuffer.attributes.add("layerNames",{type:"string",title:"Layers Names",array:!0,description:"Layer names from which objects will be picked from.",default:["World"]}),PickerFramebuffer.prototype.initialize=function(){var e=this.app.graphicsDevice.canvas,t=parseInt(e.clientWidth,10),r=parseInt(e.clientHeight,10);this.picker=new pc.Picker(this.app,t*this.pickAreaScale,r*this.pickAreaScale),this.layers=[];for(var i=0;i<this.layerNames.length;++i){var a=this.app.scene.layers.getLayerByName(this.layerNames[i]);a&&this.layers.push(a)}this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onSelect,this),this.on("destroy",(function(){this.app.mouse.off(pc.EVENT_MOUSEDOWN,this.onSelect,this)}),this)},PickerFramebuffer.prototype.onSelect=function(e){var t=this.app.graphicsDevice.canvas,r=parseInt(t.clientWidth,10),i=parseInt(t.clientHeight,10),a=this.entity.camera.camera,c=this.app.scene,s=this.picker;s.resize(r*this.pickAreaScale,i*this.pickAreaScale),s.prepare(a,c,this.layers);var o=s.getSelection({x:Math.floor(e.x*(s.width/r)),y:s.height-Math.floor(e.y*(s.height/i))});if(o.length>0){var n=o[0].node;console.log("PickerFramebuffer:selected",n),n.children[0]&&n.children[0].script&&n.children[0].script.rmobjectEvent&&(console.log("PickerFramebuffer:selected",n,n.children[0].script),n.children[0].script.rmobjectEvent.checkEvent());let e=n,t=!1,r=0;for(;e.parent&&!t&&r++<10;){if(e.name.includes("Room")){console.log("room",e.name,this.entity.script),this.entity.script.orbitCamera.focusEntity===e?console.log("same focus"):this.entity.script.orbitCamera.focusEntity=e,t=!0;break}console.log("no room",e.name,e.parent.name),e=e.parent}t||(this.entity.script.orbitCamera.focusEntity=this.app.root.findByName("Zero")),console.log("PickerFramebuffer:selected: Camera Focus Entity ",this.entity.script.orbitCamera.focusEntity)}};var OrbitCamera=pc.createScript("orbitCamera");OrbitCamera.attributes.add("distanceMax",{type:"number",default:0,title:"Distance Max",description:"Setting this at 0 will give an infinite distance limit"}),OrbitCamera.attributes.add("distanceMin",{type:"number",default:0,title:"Distance Min"}),OrbitCamera.attributes.add("pitchAngleMax",{type:"number",default:90,title:"Pitch Angle Max (degrees)"}),OrbitCamera.attributes.add("pitchAngleMin",{type:"number",default:-90,title:"Pitch Angle Min (degrees)"}),OrbitCamera.attributes.add("inertiaFactor",{type:"number",default:0,title:"Inertia Factor",description:"Higher value means that the camera will continue moving after the user has stopped dragging. 0 is fully responsive."}),OrbitCamera.attributes.add("focusEntity",{type:"entity",title:"Focus Entity",description:"Entity for the camera to focus on. If blank, then the camera will use the whole scene"}),OrbitCamera.attributes.add("frameOnStart",{type:"boolean",default:!0,title:"Frame on Start",description:'Frames the entity or scene at the start of the application."'}),Object.defineProperty(OrbitCamera.prototype,"distance",{get:function(){return this._targetDistance},set:function(t){this._targetDistance=this._clampDistance(t)}}),Object.defineProperty(OrbitCamera.prototype,"pitch",{get:function(){return this._targetPitch},set:function(t){this._targetPitch=this._clampPitchAngle(t)}}),Object.defineProperty(OrbitCamera.prototype,"yaw",{get:function(){return this._targetYaw},set:function(t){this._targetYaw=t;var i=(this._targetYaw-this._yaw)%360;this._targetYaw=i>180?this._yaw-(360-i):i<-180?this._yaw+(360+i):this._yaw+i}}),Object.defineProperty(OrbitCamera.prototype,"pivotPoint",{get:function(){return this._pivotPoint},set:function(t){this._pivotPoint.copy(t)}}),OrbitCamera.prototype.focus=function(t){this._buildAabb(t,0);var i=this._modelsAabb.halfExtents,e=Math.max(i.x,Math.max(i.y,i.z));e/=Math.tan(.5*this.entity.camera.fov*pc.math.DEG_TO_RAD),e*=2,this.distance=e,this._removeInertia(),this._pivotPoint.copy(this._modelsAabb.center)},OrbitCamera.distanceBetween=new pc.Vec3,OrbitCamera.prototype.resetAndLookAtPoint=function(t,i){this.pivotPoint.copy(i),this.entity.setPosition(t),this.entity.lookAt(i);var e=OrbitCamera.distanceBetween;e.sub2(i,t),this.distance=e.length(),this.pivotPoint.copy(i);var a=this.entity.getRotation();this.yaw=this._calcYaw(a),this.pitch=this._calcPitch(a,this.yaw),this._removeInertia(),this._updatePosition()},OrbitCamera.prototype.resetAndLookAtEntity=function(t,i){this._buildAabb(i,0),this.resetAndLookAtPoint(t,this._modelsAabb.center)},OrbitCamera.prototype.reset=function(t,i,e){this.pitch=i,this.yaw=t,this.distance=e,this._removeInertia()},OrbitCamera.prototype.initialize=function(){var t=this,onWindowResize=function(){t._checkAspectRatio()};window.addEventListener("resize",onWindowResize,!1),this._checkAspectRatio(),this._modelsAabb=new pc.BoundingBox,this._buildAabb(this.focusEntity||this.app.root,0),this.entity.lookAt(this._modelsAabb.center),this._pivotPoint=new pc.Vec3,this._pivotPoint.copy(this._modelsAabb.center);var i=this.entity.getRotation();if(this._yaw=this._calcYaw(i),this._pitch=this._clampPitchAngle(this._calcPitch(i,this._yaw)),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0),this._distance=0,this._targetYaw=this._yaw,this._targetPitch=this._pitch,this.frameOnStart)this.focus(this.focusEntity||this.app.root);else{var e=new pc.Vec3;e.sub2(this.entity.getPosition(),this._pivotPoint),this._distance=this._clampDistance(e.length())}this._targetDistance=this._distance,this.on("attr:distanceMin",(function(t,i){this._targetDistance=this._clampDistance(this._distance)})),this.on("attr:distanceMax",(function(t,i){this._targetDistance=this._clampDistance(this._distance)})),this.on("attr:pitchAngleMin",(function(t,i){this._targetPitch=this._clampPitchAngle(this._pitch)})),this.on("attr:pitchAngleMax",(function(t,i){this._targetPitch=this._clampPitchAngle(this._pitch)})),this.on("attr:focusEntity",(function(t,i){this.frameOnStart?this.focus(t||this.app.root):this.resetAndLookAtEntity(this.entity.getPosition(),t||this.app.root)})),this.on("attr:frameOnStart",(function(t,i){t&&this.focus(this.focusEntity||this.app.root)})),this.on("destroy",(function(){window.removeEventListener("resize",onWindowResize,!1)}))},OrbitCamera.prototype.update=function(t){var i=0===this.inertiaFactor?1:Math.min(t/this.inertiaFactor,1);this._distance=pc.math.lerp(this._distance,this._targetDistance,i),this._yaw=pc.math.lerp(this._yaw,this._targetYaw,i),this._pitch=pc.math.lerp(this._pitch,this._targetPitch,i),this._updatePosition()},OrbitCamera.prototype._updatePosition=function(){this.entity.setLocalPosition(0,0,0),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0);var t=this.entity.getPosition();t.copy(this.entity.forward),t.scale(-this._distance),t.add(this.pivotPoint),this.entity.setPosition(t)},OrbitCamera.prototype._removeInertia=function(){this._yaw=this._targetYaw,this._pitch=this._targetPitch,this._distance=this._targetDistance},OrbitCamera.prototype._checkAspectRatio=function(){var t=this.app.graphicsDevice.height,i=this.app.graphicsDevice.width;this.entity.camera.horizontalFov=t>i},OrbitCamera.prototype._buildAabb=function(t,i){var e=0,a=0,n=null,s=[],r=t.findComponents("render");for(e=0;e<r.length;++e)for(n=r[e].meshInstances,a=0;a<n.length;a++)s.push(n[a]);var h=t.findComponents("model");for(e=0;e<h.length;++e)for(n=h[e].meshInstances,a=0;a<n.length;a++)s.push(n[a]);for(e=0;e<s.length;e++)0===i?this._modelsAabb.copy(s[e].aabb):this._modelsAabb.add(s[e].aabb),i+=1;return i},OrbitCamera.prototype._calcYaw=function(t){var i=new pc.Vec3;return t.transformVector(pc.Vec3.FORWARD,i),Math.atan2(-i.x,-i.z)*pc.math.RAD_TO_DEG},OrbitCamera.prototype._clampDistance=function(t){return this.distanceMax>0?pc.math.clamp(t,this.distanceMin,this.distanceMax):Math.max(t,this.distanceMin)},OrbitCamera.prototype._clampPitchAngle=function(t){return pc.math.clamp(t,-this.pitchAngleMax,-this.pitchAngleMin)},OrbitCamera.quatWithoutYaw=new pc.Quat,OrbitCamera.yawOffset=new pc.Quat,OrbitCamera.prototype._calcPitch=function(t,i){var e=OrbitCamera.quatWithoutYaw,a=OrbitCamera.yawOffset;a.setFromEulerAngles(0,-i,0),e.mul2(a,t);var n=new pc.Vec3;return e.transformVector(pc.Vec3.FORWARD,n),Math.atan2(n.y,-n.z)*pc.math.RAD_TO_DEG};var MouseInput=pc.createScript("mouseInput");MouseInput.attributes.add("orbitSensitivity",{type:"number",default:.3,title:"Orbit Sensitivity",description:"How fast the camera moves around the orbit. Higher is faster"}),MouseInput.attributes.add("distanceSensitivity",{type:"number",default:.15,title:"Distance Sensitivity",description:"How fast the camera moves in and out. Higher is faster"}),MouseInput.prototype.initialize=function(){if(this.orbitCamera=this.entity.script.orbitCamera,this.orbitCamera){var t=this,onMouseOut=function(o){t.onMouseOut(o)};this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.on(pc.EVENT_MOUSEWHEEL,this.onMouseWheel,this),window.addEventListener("mouseout",onMouseOut,!1),this.on("destroy",(function(){this.app.mouse.off(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.off(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.mouse.off(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.off(pc.EVENT_MOUSEWHEEL,this.onMouseWheel,this),window.removeEventListener("mouseout",onMouseOut,!1)}))}this.app.mouse.disableContextMenu(),this.lookButtonDown=!1,this.panButtonDown=!1,this.lastPoint=new pc.Vec2},MouseInput.fromWorldPoint=new pc.Vec3,MouseInput.toWorldPoint=new pc.Vec3,MouseInput.worldDiff=new pc.Vec3,MouseInput.prototype.pan=function(t){var o=MouseInput.fromWorldPoint,e=MouseInput.toWorldPoint,i=MouseInput.worldDiff,s=this.entity.camera,n=this.orbitCamera.distance;s.screenToWorld(t.x,t.y,n,o),s.screenToWorld(this.lastPoint.x,this.lastPoint.y,n,e),i.sub2(e,o),this.orbitCamera.pivotPoint.add(i)},MouseInput.prototype.onMouseDown=function(t){switch(t.button){case pc.MOUSEBUTTON_LEFT:this.lookButtonDown=!0;break;case pc.MOUSEBUTTON_MIDDLE:case pc.MOUSEBUTTON_RIGHT:this.panButtonDown=!0}},MouseInput.prototype.onMouseUp=function(t){switch(t.button){case pc.MOUSEBUTTON_LEFT:this.lookButtonDown=!1;break;case pc.MOUSEBUTTON_MIDDLE:case pc.MOUSEBUTTON_RIGHT:this.panButtonDown=!1}},MouseInput.prototype.onMouseMove=function(t){pc.app.mouse;this.lookButtonDown?(this.orbitCamera.pitch-=t.dy*this.orbitSensitivity,this.orbitCamera.yaw-=t.dx*this.orbitSensitivity):this.panButtonDown&&this.pan(t),this.lastPoint.set(t.x,t.y)},MouseInput.prototype.onMouseWheel=function(t){this.orbitCamera.distance-=t.wheel*this.distanceSensitivity*(.1*this.orbitCamera.distance),t.event.preventDefault()},MouseInput.prototype.onMouseOut=function(t){this.lookButtonDown=!1,this.panButtonDown=!1};var TouchInput=pc.createScript("touchInput");TouchInput.attributes.add("orbitSensitivity",{type:"number",default:.4,title:"Orbit Sensitivity",description:"How fast the camera moves around the orbit. Higher is faster"}),TouchInput.attributes.add("distanceSensitivity",{type:"number",default:.2,title:"Distance Sensitivity",description:"How fast the camera moves in and out. Higher is faster"}),TouchInput.prototype.initialize=function(){this.orbitCamera=this.entity.script.orbitCamera,this.lastTouchPoint=new pc.Vec2,this.lastPinchMidPoint=new pc.Vec2,this.lastPinchDistance=0,this.orbitCamera&&this.app.touch&&(this.app.touch.on(pc.EVENT_TOUCHSTART,this.onTouchStartEndCancel,this),this.app.touch.on(pc.EVENT_TOUCHEND,this.onTouchStartEndCancel,this),this.app.touch.on(pc.EVENT_TOUCHCANCEL,this.onTouchStartEndCancel,this),this.app.touch.on(pc.EVENT_TOUCHMOVE,this.onTouchMove,this),this.on("destroy",(function(){this.app.touch.off(pc.EVENT_TOUCHSTART,this.onTouchStartEndCancel,this),this.app.touch.off(pc.EVENT_TOUCHEND,this.onTouchStartEndCancel,this),this.app.touch.off(pc.EVENT_TOUCHCANCEL,this.onTouchStartEndCancel,this),this.app.touch.off(pc.EVENT_TOUCHMOVE,this.onTouchMove,this)})))},TouchInput.prototype.getPinchDistance=function(t,i){var o=t.x-i.x,n=t.y-i.y;return Math.sqrt(o*o+n*n)},TouchInput.prototype.calcMidPoint=function(t,i,o){o.set(i.x-t.x,i.y-t.y),o.scale(.5),o.x+=t.x,o.y+=t.y},TouchInput.prototype.onTouchStartEndCancel=function(t){var i=t.touches;1==i.length?this.lastTouchPoint.set(i[0].x,i[0].y):2==i.length&&(this.lastPinchDistance=this.getPinchDistance(i[0],i[1]),this.calcMidPoint(i[0],i[1],this.lastPinchMidPoint))},TouchInput.fromWorldPoint=new pc.Vec3,TouchInput.toWorldPoint=new pc.Vec3,TouchInput.worldDiff=new pc.Vec3,TouchInput.prototype.pan=function(t){var i=TouchInput.fromWorldPoint,o=TouchInput.toWorldPoint,n=TouchInput.worldDiff,h=this.entity.camera,c=this.orbitCamera.distance;h.screenToWorld(t.x,t.y,c,i),h.screenToWorld(this.lastPinchMidPoint.x,this.lastPinchMidPoint.y,c,o),n.sub2(o,i),this.orbitCamera.pivotPoint.add(n)},TouchInput.pinchMidPoint=new pc.Vec2,TouchInput.prototype.onTouchMove=function(t){var i=TouchInput.pinchMidPoint,o=t.touches;if(1==o.length){var n=o[0];this.orbitCamera.pitch-=(n.y-this.lastTouchPoint.y)*this.orbitSensitivity,this.orbitCamera.yaw-=(n.x-this.lastTouchPoint.x)*this.orbitSensitivity,this.lastTouchPoint.set(n.x,n.y)}else if(2==o.length){var h=this.getPinchDistance(o[0],o[1]),c=h-this.lastPinchDistance;this.lastPinchDistance=h,this.orbitCamera.distance-=c*this.distanceSensitivity*.1*(.1*this.orbitCamera.distance),this.calcMidPoint(o[0],o[1],i),this.pan(i),this.lastPinchMidPoint.copy(i)}};